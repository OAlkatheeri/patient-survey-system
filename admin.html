<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Survey Admin Dashboard</title>
    
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <!-- Export libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Auth Screen Styles */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .auth-form {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 450px;
        }

        .auth-form h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c5aa0;
            font-size: 28px;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
            background: #f1f5f9;
            border-radius: 8px;
            padding: 4px;
        }

        .auth-tab {
            flex: 1;
            background: none;
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #64748b;
        }

        .auth-tab.active {
            background: white;
            color: #2c5aa0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #2c5aa0;
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
        }

        .form-group small {
            color: #64748b;
            font-size: 14px;
        }

        .btn-primary {
            width: 100%;
            background: linear-gradient(135deg, #2c5aa0 0%, #1e3a8a 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(44, 90, 160, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .error-message {
            color: #dc2626;
            background: #fee2e2;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .success-message {
            color: #059669;
            background: #d1fae5;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        /* Dashboard Layout */
        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #2c5aa0;
            font-size: 24px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info .role-badge {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .btn-logout {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
        }

        .btn-logout:hover {
            background: #dc2626;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            padding: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            overflow-x: auto;
        }

        .nav-tab {
            background: none;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
            color: #64748b;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #2c5aa0 0%, #1e3a8a 100%);
            color: white;
        }

        .nav-tab:hover:not(.active) {
            background: #f1f5f9;
            color: #2c5aa0;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border-left: 4px solid;
        }

        .stat-card.primary { border-color: #2c5aa0; }
        .stat-card.success { border-color: #10b981; }
        .stat-card.warning { border-color: #f59e0b; }
        .stat-card.danger { border-color: #ef4444; }

        .stat-card h3 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-card p {
            color: #64748b;
            font-weight: 500;
        }

        .stat-card .trend {
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
        }

        .trend.up { color: #10b981; }
        .trend.down { color: #ef4444; }

        /* Tables */
        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .table-header {
            padding: 20px 25px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .table-header h3 {
            color: #1e293b;
            font-size: 18px;
        }

        .table-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px 25px;
            text-align: left;
            border-bottom: 1px solid #f1f5f9;
        }

        th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        tbody tr:hover {
            background: #f8fafc;
        }

        /* Charts */
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .chart-container h3 {
            margin-bottom: 20px;
            color: #1e293b;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
        }

        /* Buttons */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-primary { background: #2c5aa0; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-secondary { background: #6b7280; color: white; }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Status badges */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending { background: #fef3c7; color: #92400e; }
        .status-completed { background: #d1fae5; color: #065f46; }
        .status-high { background: #fee2e2; color: #991b1b; }
        .status-medium { background: #fef3c7; color: #92400e; }
        .status-low { background: #d1fae5; color: #065f46; }

        /* Loading spinner */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #2c5aa0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Filters */
        .filters {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #2c5aa0;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        /* Alert styles */
        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #3b82f6;
        }

        /* Export dropdown */
        .export-dropdown {
            position: relative;
            display: inline-block;
        }

        .export-dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 120px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 6px;
            right: 0;
        }

        .export-dropdown-content a {
            color: #374151;
            padding: 8px 12px;
            text-decoration: none;
            display: block;
            font-size: 14px;
        }

        .export-dropdown-content a:hover {
            background-color: #f8fafc;
        }

        .export-dropdown.show .export-dropdown-content {
            display: block;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                justify-content: flex-start;
            }

            table {
                font-size: 14px;
            }

            th, td {
                padding: 10px 15px;
            }

            .chart-grid {
                grid-template-columns: 1fr;
            }

            .table-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <!-- Authentication Screen -->
    <div id="authScreen" class="auth-container">
        <div class="auth-form">
            <h1>üè• Admin Portal</h1>
            
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login')">Sign In</button>
                <button class="auth-tab" onclick="switchAuthTab('register')">Register</button>
            </div>

            <div id="authError" class="error-message" style="display: none;"></div>
            <div id="authSuccess" class="success-message" style="display: none;"></div>

            <!-- Login Form -->
            <form id="loginForm" style="display: block;">
                <div class="form-group">
                    <label for="loginEmail">Email Address</label>
                    <input type="email" id="loginEmail" required placeholder="admin@hospital.com">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" required placeholder="Enter your password">
                </div>
                <button type="submit" class="btn-primary">Sign In</button>
            </form>

            <!-- Register Form -->
            <form id="registerForm" style="display: none;">
                <div class="form-group">
                    <label for="registerName">Full Name</label>
                    <input type="text" id="registerName" required placeholder="John Doe">
                </div>
                <div class="form-group">
                    <label for="registerEmail">Email Address</label>
                    <input type="email" id="registerEmail" required placeholder="john@hospital.com">
                </div>
                <div class="form-group">
                    <label for="registerPassword">Password</label>
                    <input type="password" id="registerPassword" required placeholder="Create your login password" minlength="6">
                    <small>This will be your personal login password.</small>
                </div>
                <div class="form-group">
                    <label for="registerDepartment">Department</label>
                    <select id="registerDepartment" required>
                        <option value="">Select Department</option>
                        <option value="Reception/Front Desk">Reception/Front Desk</option>
                        <option value="General Practice">General Practice</option>
                        <option value="Specialist Consultation">Specialist Consultation</option>
                        <option value="Nursing Services">Nursing Services</option>
                        <option value="Laboratory">Laboratory</option>
                        <option value="Radiology/Imaging">Radiology/Imaging</option>
                        <option value="Pharmacy">Pharmacy</option>
                        <option value="Physical Therapy">Physical Therapy</option>
                        <option value="Emergency/Urgent Care">Emergency/Urgent Care</option>
                        <option value="Administration">Administration</option>
                        <option value="IT">IT</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="adminCode">Admin Access Code</label>
                    <input type="password" id="adminCode" required placeholder="Enter admin code">
                    <small>Contact your system administrator for the admin access code.</small>
                </div>
                <button type="submit" class="btn-primary">Create Account</button>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <h1>üìä Patient Survey Dashboard</h1>
                <div class="user-info">
                    <span id="userName">Loading...</span>
                    <span id="userRole" class="role-badge">Admin</span>
                    <button id="logoutBtn" class="btn-logout">Logout</button>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="nav-tabs">
                <button class="nav-tab active" data-tab="overview">üìà Overview</button>
                <button class="nav-tab" data-tab="surveys">üìã All Surveys</button>
                <button class="nav-tab" data-tab="analytics">üìä Analytics</button>
                <button class="nav-tab" data-tab="follow-ups">üìû Follow-ups</button>
                <button class="nav-tab" data-tab="users">üë• Users</button>
                <button class="nav-tab" data-tab="settings">‚öôÔ∏è Settings</button>
            </div>

            <!-- Overview Tab -->
            <div id="overview" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card primary">
                        <h3 id="totalSurveys">0</h3>
                        <p>Total Surveys Today</p>
                        <div class="trend up" id="surveyTrend">Loading...</div>
                    </div>
                    <div class="stat-card success">
                        <h3 id="avgSatisfaction">0.0</h3>
                        <p>Average Satisfaction</p>
                        <div class="trend up" id="satisfactionTrend">Loading...</div>
                    </div>
                    <div class="stat-card warning">
                        <h3 id="pendingFollowUps">0</h3>
                        <p>Pending Follow-ups</p>
                        <div class="trend down" id="followUpTrend">Loading...</div>
                    </div>
                    <div class="stat-card danger">
                        <h3 id="lowSatisfaction">0</h3>
                        <p>Low Satisfaction (‚â§2)</p>
                        <div class="trend down" id="lowSatTrend">Loading...</div>
                    </div>
                </div>

                <!-- Recent Surveys -->
                <div class="table-container">
                    <div class="table-header">
                        <h3>Recent Survey Responses</h3>
                        <div class="table-actions">
                            <button class="btn btn-primary btn-sm" onclick="refreshData()">üîÑ Refresh</button>
                            <button class="btn btn-success btn-sm" onclick="exportRecentSurveys()">üì• Export</button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Patient</th>
                                <th>Department</th>
                                <th>Overall Rating</th>
                                <th>Visit Date</th>
                                <th>Submitted</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recentSurveysTable">
                            <tr>
                                <td colspan="7" class="loading">
                                    <div class="spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- All Surveys Tab -->
            <div id="surveys" class="tab-content">
                <div class="filters">
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label>Department</label>
                            <select id="departmentFilter">
                                <option value="">All Departments</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Date Range</label>
                            <select id="dateRangeFilter">
                                <option value="today">Today</option>
                                <option value="yesterday">Yesterday</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="quarter">This Quarter</option>
                                <option value="year">This Year</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        <div class="filter-group" id="customDateGroup" style="display: none;">
                            <label>From Date</label>
                            <input type="date" id="startDate">
                        </div>
                        <div class="filter-group" id="customDateGroup2" style="display: none;">
                            <label>To Date</label>
                            <input type="date" id="endDate">
                        </div>
                        <div class="filter-group">
                            <label>Satisfaction Level</label>
                            <select id="satisfactionFilter">
                                <option value="">All Ratings</option>
                                <option value="low">Low (1-2)</option>
                                <option value="medium">Medium (3)</option>
                                <option value="high">High (4-5)</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-header">
                        <h3>All Survey Responses</h3>
                        <div class="table-actions">
                            <div class="export-dropdown">
                                <button class="btn btn-success btn-sm" onclick="toggleExportDropdown()">üì• Export ‚ñº</button>
                                <div class="export-dropdown-content">
                                    <a href="#" onclick="exportSurveys('excel')">üìä Excel (.xlsx)</a>
                                    <a href="#" onclick="exportSurveys('csv')">üìã CSV</a>
                                    <a href="#" onclick="exportSurveys('json')">üîß JSON</a>
                                </div>
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="loadSurveysData()">üîÑ Refresh</button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Survey ID</th>
                                <th>Patient Name</th>
                                <th>Email</th>
                                <th>Department</th>
                                <th>Overall Rating</th>
                                <th>Visit Date</th>
                                <th>Follow-up</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="allSurveysTable">
                            <tr>
                                <td colspan="8" class="loading">
                                    <div class="spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics" class="tab-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="totalResponsesMetric">0</h3>
                        <p>Total Responses (30 days)</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="avgOverallMetric">0.0</h3>
                        <p>Average Overall Rating</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="satisfactionRateMetric">0%</h3>
                        <p>Satisfaction Rate (4-5)</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="responseRateMetric">0%</h3>
                        <p>Follow-up Request Rate</p>
                    </div>
                </div>

                <div class="chart-grid">
                    <div class="chart-container">
                        <h3>Satisfaction Trends (Last 7 Days)</h3>
                        <canvas id="satisfactionChart" width="400" height="200"></canvas>
                    </div>

                    <div class="chart-container">
                        <h3>Department Performance</h3>
                        <canvas id="departmentChart" width="400" height="200"></canvas>
                    </div>

                    <div class="chart-container">
                        <h3>Wait Time Distribution</h3>
                        <canvas id="waitTimeChart" width="400" height="200"></canvas>
                    </div>

                    <div class="chart-container">
                        <h3>Rating Distribution</h3>
                        <canvas id="ratingChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>

            <!-- Follow-ups Tab -->
            <div id="follow-ups" class="tab-content">
                <div class="table-container">
                    <div class="table-header">
                        <h3>Follow-up Tasks</h3>
                        <div class="table-actions">
                            <button class="btn btn-primary btn-sm" onclick="loadFollowUpsData()">üîÑ Refresh</button>
                            <button class="btn btn-success btn-sm" onclick="exportFollowUps()">üì• Export</button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Patient</th>
                                <th>Contact Method</th>
                                <th>Priority</th>
                                <th>Assigned To</th>
                                <th>Status</th>
                                <th>Survey Rating</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="followUpsTable">
                            <tr>
                                <td colspan="8" class="loading">
                                    <div class="spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="users" class="tab-content">
                <div class="table-container">
                    <div class="table-header">
                        <h3>Admin Users</h3>
                        <div class="table-actions">
                            <button class="btn btn-secondary btn-sm" onclick="loadUsersData()">üîÑ Refresh</button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Department</th>
                                <th>Last Login</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable">
                            <tr>
                                <td colspan="7" class="loading">
                                    <div class="spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <div class="table-container">
                    <div class="table-header">
                        <h3>System Settings</h3>
                        <div class="table-actions">
                            <button class="btn btn-success btn-sm" onclick="saveSettings()">üíæ Save Changes</button>
                        </div>
                    </div>
                    <div style="padding: 25px;">
                        <div class="filters-grid">
                            <div class="filter-group">
                                <label>Survey Auto-restart Time (seconds)</label>
                                <input type="number" id="autoRestartTime" value="30" min="10" max="300">
                            </div>
                            <div class="filter-group">
                                <label>Survey Idle Timeout (seconds)</label>
                                <input type="number" id="idleTimeout" value="300" min="60" max="1800">
                            </div>
                            <div class="filter-group">
                                <label>Dashboard Refresh Interval (seconds)</label>
                                <input type="number" id="dashboardRefresh" value="300" min="30" max="1800">
                            </div>
                            <div class="filter-group">
                                <label>Low Rating Threshold (1-5)</label>
                                <input type="number" id="lowRatingThreshold" value="2" min="1" max="4">
                            </div>
                            <div class="filter-group">
                                <label>Max Follow-up Attempts</label>
                                <input type="number" id="maxFollowUpAttempts" value="3" min="1" max="10">
                            </div>
                            <div class="filter-group">
                                <label>Email Notifications</label>
                                <select id="emailNotifications">
                                    <option value="true">Enabled</option>
                                    <option value="false">Disabled</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Survey Detail Modal -->
    <div id="surveyModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeSurveyModal()">&times;</span>
            <h2>Survey Details</h2>
            <div id="surveyDetails"></div>
        </div>
    </div>

    <!-- Follow-up Task Modal -->
    <div id="followUpModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeFollowUpModal()">&times;</span>
            <h2>Follow-up Task</h2>
            <div id="followUpDetails"></div>
        </div>
    </div>

    <script>
        // üîß SUPABASE CONFIGURATION  
        const SUPABASE_CONFIG = {
            url: 'https://haeephlyfcoxrioohhjj.supabase.co',
            anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhhZWVwaGx5ZmNveHJpb29oaGpqIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MTQ4MTgwOSwiZXhwIjoyMDY3MDU3ODA5fQ.srXbETt6h-zFXuW41b_fKFZTlRquNOCS1I_nwKZIyhY'
        };

        const ADMIN_CODE = '5865'; // Admin access code for registration

        class AdminDashboard {
            constructor() {
                this.supabase = null;
                this.currentUser = null;
                this.currentAdminUser = null;
                this.charts = {};
                this.filteredData = [];
                this.currentFilters = {};
                this.init();
            }

            init() {
                try {
                    this.initSupabase();
                    this.setupEventListeners();
                    this.checkAuthStatus();
                } catch (error) {
                    console.error('‚ùå Initialization error:', error);
                    this.showError('Failed to initialize dashboard. Please refresh the page.');
                }
            }

            initSupabase() {
                try {
                    if (typeof supabase !== 'undefined') {
                        this.supabase = supabase.createClient(
                            SUPABASE_CONFIG.url,
                            SUPABASE_CONFIG.anonKey
                        );
                        console.log('‚úÖ Supabase initialized');
                    } else {
                        console.error('‚ùå Supabase client not loaded');
                        this.showError('Supabase client not available. Please check your configuration.');
                    }
                } catch (error) {
                    console.error('‚ùå Supabase initialization error:', error);
                    this.showError('Failed to initialize Supabase connection.');
                }
            }

            setupEventListeners() {
                // Login form
                const loginForm = document.getElementById('loginForm');
                if (loginForm) {
                    loginForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleLogin();
                    });
                }

                // Register form
                const registerForm = document.getElementById('registerForm');
                if (registerForm) {
                    registerForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleRegister();
                    });
                }

                // Logout button
                const logoutBtn = document.getElementById('logoutBtn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', () => this.handleLogout());
                }

                // Tab navigation
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.addEventListener('click', () => this.switchTab(tab.dataset.tab));
                });

                // Filter change handlers
                const dateRangeFilter = document.getElementById('dateRangeFilter');
                if (dateRangeFilter) {
                    dateRangeFilter.addEventListener('change', this.handleDateRangeChange.bind(this));
                }

                // Auto-refresh dashboard data every 5 minutes
                setInterval(() => {
                    if (this.currentUser) {
                        this.refreshData();
                    }
                }, 300000);
            }

            async checkAuthStatus() {
                try {
                    if (!this.supabase) {
                        this.showAuth();
                        return;
                    }

                    const { data: { session }, error } = await this.supabase.auth.getSession();
                    
                    if (error) {
                        console.error('‚ùå Auth session error:', error);
                        this.showAuth();
                        return;
                    }
                    
                    if (session) {
                        console.log('‚úÖ Active session found:', session.user.email);
                        await this.handleAuthSuccess(session.user);
                    } else {
                        console.log('‚ÑπÔ∏è No active session, showing auth');
                        this.showAuth();
                    }
                } catch (error) {
                    console.error('‚ùå Auth check error:', error);
                    this.showAuth();
                    this.showError(`Authentication check failed: ${error.message}`);
                }
            }

            async handleLogin() {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                const errorDiv = document.getElementById('authError');
                const submitBtn = document.querySelector('#loginForm button[type="submit"]');

                try {
                    this.hideMessages();
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Signing In...';

                    const { data, error } = await this.supabase.auth.signInWithPassword({
                        email,
                        password
                    });

                    if (error) throw error;

                    await this.handleAuthSuccess(data.user);
                } catch (error) {
                    console.error('‚ùå Login error:', error);
                    this.showError(error.message || 'Login failed. Please try again.');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Sign In';
                }
            }

            async handleRegister() {
                const name = document.getElementById('registerName').value;
                const email = document.getElementById('registerEmail').value;
                const password = document.getElementById('registerPassword').value;
                const department = document.getElementById('registerDepartment').value;
                const adminCode = document.getElementById('adminCode').value;
                const submitBtn = document.querySelector('#registerForm button[type="submit"]');

                try {
                    this.hideMessages();
                    
                    // Validate admin code
                    if (adminCode !== ADMIN_CODE) {
                        throw new Error('Invalid admin access code. Please contact your system administrator.');
                    }

                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Creating Account...';

                    // Create user account with admin metadata
                    const { data, error } = await this.supabase.auth.signUp({
                        email,
                        password,  // User's chosen password
                        options: {
                            data: {
                                full_name: name,
                                department: department,
                                admin_code: adminCode,  // This marks them as admin
                                is_admin: true
                            }
                        }
                    });

                    if (error) throw error;

                    if (data.user) {
                        console.log('‚úÖ User created, now creating admin record...');
                        
                        // Wait a moment for the user to be fully created
                        await new Promise(resolve => setTimeout(resolve, 2000));

                        // Create admin user record manually (more reliable than trigger)
                        try {
                            // Check if admin record already exists (trigger might have worked)
                            const { data: existingAdmin } = await this.supabase
                                .from('admin_users')
                                .select('id')
                                .eq('user_id', data.user.id)
                                .maybeSingle();

                            if (!existingAdmin) {
                                console.log('üîß No admin record found, creating manually...');
                                
                                // Check if this would be the first super_admin
                                const { data: existingSuperAdmins } = await this.supabase
                                    .from('admin_users')
                                    .select('id')
                                    .eq('role', 'super_admin')
                                    .eq('is_active', true);

                                const role = (!existingSuperAdmins || existingSuperAdmins.length === 0) ? 'super_admin' : 'admin';

                                // Use a function call to bypass RLS restrictions
                                const { data: functionResult, error: functionError } = await this.supabase
                                    .rpc('create_admin_user_manual', {
                                        p_user_id: data.user.id,
                                        p_full_name: name,
                                        p_email: email,
                                        p_department: department,
                                        p_role: role
                                    });

                                if (functionError) {
                                    console.error('‚ùå Function error:', functionError);
                                    console.log('üîß Function failed, trying direct insert...');
                                    
                                    // Fallback: try direct insert (will work if RLS allows)
                                    const { error: insertError } = await this.supabase
                                        .from('admin_users')
                                        .insert({
                                            user_id: data.user.id,
                                            full_name: name,
                                            email: email,
                                            role: role,
                                            department: department,
                                            is_active: true
                                        });

                                    if (insertError) {
                                        console.error('‚ùå Direct insert also failed:', insertError);
                                        throw new Error('Admin account created but setup incomplete. Please contact your system administrator to complete the setup.');
                                    }
                                }
                                
                                console.log('‚úÖ Admin record created successfully');
                            } else {
                                console.log('‚úÖ Admin record already exists (trigger worked)');
                            }

                            this.showSuccess(`üéâ Admin account created successfully! You can now sign in with your email and the password you created.`);
                            
                        } catch (adminError) {
                            console.error('‚ùå Admin creation error:', adminError);
                            this.showSuccess(`Account created, but admin setup needs completion. Please contact your system administrator. You can try signing in - it might work.`);
                        }
                        
                        // Switch to login tab after success
                        setTimeout(() => {
                            switchAuthTab('login');
                            // Pre-fill email
                            document.getElementById('loginEmail').value = email;
                        }, 3000);
                    }

                } catch (error) {
                    console.error('‚ùå Registration error:', error);
                    this.showError(error.message || 'Registration failed. Please try again.');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Create Account';
                }
            }

            async handleAuthSuccess(user) {
                try {
                    this.currentUser = user;
                    console.log('üîç Checking admin user for:', user.email);

                    // Get admin user details with simplified query to avoid RLS recursion
                    const { data: adminUser, error } = await this.supabase
                        .from('admin_users')
                        .select('*')
                        .eq('user_id', user.id)
                        .maybeSingle();

                    if (error) {
                        console.error('‚ùå Error querying admin_users:', error);
                        throw new Error(`Database error: ${error.message}`);
                    }

                    if (!adminUser) {
                        console.warn('‚ö†Ô∏è Admin user record not found for:', user.email);
                        
                        // Check if user signed up recently and admin record creation might have failed
                        const userCreatedAt = new Date(user.created_at);
                        const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
                        
                        if (userCreatedAt > fiveMinutesAgo) {
                            // Recent signup - trigger might have failed
                            throw new Error('Admin account setup incomplete. The automatic setup may have failed. Please contact your system administrator to complete your admin setup.');
                        } else {
                            throw new Error('Admin access denied. Your account does not have administrative privileges. Please contact your system administrator.');
                        }
                    }

                    if (!adminUser.is_active) {
                        throw new Error('Your admin account has been disabled. Please contact your system administrator.');
                    }

                    this.currentAdminUser = adminUser;
                    console.log('‚úÖ Admin user found:', adminUser.full_name, `(${adminUser.role})`);

                    // Update last login (this might fail due to RLS, but that's okay)
                    try {
                        await this.supabase
                            .from('admin_users')
                            .update({ last_login: new Date().toISOString() })
                            .eq('id', this.currentAdminUser.id);
                    } catch (updateError) {
                        console.warn('Could not update last login (RLS restriction):', updateError);
                    }

                    // Log activity (this might fail due to RLS, but that's okay)
                    try {
                        await this.logActivity('login', 'auth', null, { 
                            login_time: new Date().toISOString(),
                            user_agent: navigator.userAgent
                        });
                    } catch (logError) {
                        console.warn('Could not log activity (RLS restriction):', logError);
                    }

                    this.showDashboard();
                    await this.loadDashboardData();
                } catch (error) {
                    console.error('‚ùå Auth success handling error:', error);
                    this.showError(error.message);
                    if (this.supabase) {
                        await this.supabase.auth.signOut();
                    }
                    this.showAuth();
                }
            }

            async handleLogout() {
                try {
                    await this.logActivity('logout', 'auth');
                    await this.supabase.auth.signOut();
                    
                    this.currentUser = null;
                    this.currentAdminUser = null;
                    this.showAuth();
                } catch (error) {
                    console.error('‚ùå Logout error:', error);
                }
            }

            showAuth() {
                document.getElementById('authScreen').style.display = 'flex';
                document.getElementById('dashboard').classList.remove('active');
            }

            showDashboard() {
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('dashboard').classList.add('active');
                
                // Update user info
                document.getElementById('userName').textContent = this.currentAdminUser.full_name;
                document.getElementById('userRole').textContent = this.currentAdminUser.role.replace('_', ' ').toUpperCase();
            }

            switchTab(tabName) {
                // Update tab buttons
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

                // Update tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabName).classList.add('active');

                // Load tab-specific data
                this.loadTabData(tabName);
            }

            async loadTabData(tabName) {
                try {
                    switch (tabName) {
                        case 'overview':
                            await this.loadOverviewData();
                            break;
                        case 'surveys':
                            await this.loadSurveysData();
                            break;
                        case 'analytics':
                            await this.loadAnalyticsData();
                            break;
                        case 'follow-ups':
                            await this.loadFollowUpsData();
                            break;
                        case 'users':
                            await this.loadUsersData();
                            break;
                        case 'settings':
                            await this.loadSettingsData();
                            break;
                    }
                } catch (error) {
                    console.error(`‚ùå Error loading ${tabName} data:`, error);
                    this.showError(`Failed to load ${tabName} data`);
                }
            }

            async loadDashboardData() {
                await this.loadOverviewData();
                await this.populateFilterOptions();
            }

            async loadOverviewData() {
                try {
                    // Get today's date range
                    const today = new Date();
                    const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                    const endOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1);

                    // Get today's surveys using visit_date from JSONB
                    const { data: surveys, error } = await this.supabase
                        .from('patient_survey_responses')
                        .select('*')
                        .gte('patient_info->visit_date', startOfDay.toISOString().split('T')[0])
                        .lt('patient_info->visit_date', endOfDay.toISOString().split('T')[0]);

                    if (error) throw error;

                    // Calculate stats
                    const totalSurveys = surveys.length;
                    const validRatings = surveys.filter(s => s.experience_data?.overall_satisfaction);
                    const avgSatisfaction = validRatings.length > 0 
                        ? (validRatings.reduce((sum, s) => sum + parseInt(s.experience_data.overall_satisfaction), 0) / validRatings.length).toFixed(1)
                        : '0.0';
                    
                    const lowSatisfaction = validRatings.filter(s => 
                        parseInt(s.experience_data.overall_satisfaction) <= 2
                    ).length;

                    // Get pending follow-ups
                    const { data: followUps, error: followUpError } = await this.supabase
                        .from('follow_up_tasks')
                        .select('*')
                        .eq('status', 'pending');

                    const pendingFollowUps = followUpError ? 0 : followUps.length;

                    // Update stats
                    document.getElementById('totalSurveys').textContent = totalSurveys;
                    document.getElementById('avgSatisfaction').textContent = avgSatisfaction;
                    document.getElementById('pendingFollowUps').textContent = pendingFollowUps;
                    document.getElementById('lowSatisfaction').textContent = lowSatisfaction;

                    // Calculate trends (compare with yesterday)
                    const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
                    const yesterdayStart = new Date(yesterday.getFullYear(), yesterday.getMonth(), yesterday.getDate());
                    const yesterdayEnd = new Date(yesterday.getFullYear(), yesterday.getMonth(), yesterday.getDate() + 1);

                    const { data: yesterdaySurveys } = await this.supabase
                        .from('patient_survey_responses')
                        .select('*')
                        .gte('patient_info->visit_date', yesterdayStart.toISOString().split('T')[0])
                        .lt('patient_info->visit_date', yesterdayEnd.toISOString().split('T')[0]);

                    const yesterdayCount = yesterdaySurveys ? yesterdaySurveys.length : 0;
                    const surveyTrend = yesterdayCount > 0 ? 
                        `${totalSurveys > yesterdayCount ? '+' : ''}${totalSurveys - yesterdayCount} from yesterday` : 
                        totalSurveys > 0 ? 'First surveys today' : 'No surveys yet';

                    document.getElementById('surveyTrend').textContent = surveyTrend;
                    document.getElementById('satisfactionTrend').textContent = avgSatisfaction !== '0.0' ? 'Monitoring trends' : 'No data yet';
                    document.getElementById('followUpTrend').textContent = pendingFollowUps > 0 ? `${pendingFollowUps} pending tasks` : 'All caught up!';
                    document.getElementById('lowSatTrend').textContent = lowSatisfaction > 0 ? 'Needs attention' : 'Great job!';

                    // Load recent surveys table
                    await this.loadRecentSurveys();

                } catch (error) {
                    console.error('‚ùå Error loading overview data:', error);
                    this.showError('Failed to load dashboard data');
                }
            }

            async loadRecentSurveys() {
                try {
                    const { data: surveys, error } = await this.supabase
                        .from('patient_survey_responses')
                        .select('*')
                        .order('created_at', { ascending: false })
                        .limit(10);

                    if (error) throw error;

                    const tableBody = document.getElementById('recentSurveysTable');
                    
                    if (surveys.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #64748b;">No surveys found</td></tr>';
                        return;
                    }

                    tableBody.innerHTML = surveys.map(survey => `
                        <tr>
                            <td>${survey.patient_info?.full_name || 'N/A'}</td>
                            <td>${survey.patient_info?.department_visited || 'N/A'}</td>
                            <td>
                                <span class="status-badge ${this.getSatisfactionClass(survey.experience_data?.overall_satisfaction)}">
                                    ${survey.experience_data?.overall_satisfaction || 'N/A'}/5
                                </span>
                            </td>
                            <td>${survey.patient_info?.visit_date ? new Date(survey.patient_info.visit_date).toLocaleDateString() : 'N/A'}</td>
                            <td>${new Date(survey.created_at).toLocaleDateString()}</td>
                            <td>
                                <span class="status-badge status-completed">Submitted</span>
                            </td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick="viewSurvey('${survey.response_id}')">View</button>
                            </td>
                        </tr>
                    `).join('');

                } catch (error) {
                    console.error('‚ùå Error loading recent surveys:', error);
                    document.getElementById('recentSurveysTable').innerHTML = '<tr><td colspan="7" style="text-align: center; color: #dc2626;">Error loading surveys</td></tr>';
                }
            }

            async populateFilterOptions() {
                try {
                    // Get unique departments from JSONB field
                    const { data: surveys, error } = await this.supabase
                        .from('patient_survey_responses')
                        .select('patient_info')
                        .not('patient_info->department_visited', 'is', null);

                    if (!error && surveys) {
                        const uniqueDepartments = [...new Set(surveys
                            .map(s => s.patient_info?.department_visited)
                            .filter(Boolean)
                        )];
                        
                        const departmentFilter = document.getElementById('departmentFilter');
                        
                        // Clear existing options except "All Departments"
                        while (departmentFilter.children.length > 1) {
                            departmentFilter.removeChild(departmentFilter.lastChild);
                        }
                        
                        uniqueDepartments.forEach(dept => {
                            const option = document.createElement('option');
                            option.value = dept;
                            option.textContent = dept;
                            departmentFilter.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error('‚ùå Error populating filter options:', error);
                }
            }

            getSatisfactionClass(rating) {
                const r = parseInt(rating);
                if (isNaN(r)) return 'status-medium';
                if (r >= 4) return 'status-high';
                if (r === 3) return 'status-medium';
                return 'status-low';
            }

            async loadSurveysData() {
                try {
                    let query = this.supabase
                        .from('patient_survey_responses')
                        .select('*')
                        .order('created_at', { ascending: false });

                    // Apply current filters
                    query = this.applyFiltersToQuery(query);

                    const { data: surveys, error } = await query;

                    if (error) throw error;

                    this.filteredData = surveys;
                    this.renderSurveysTable(surveys);

                } catch (error) {
                    console.error('‚ùå Error loading surveys data:', error);
                    this.showError('Failed to load surveys data');
                }
            }

            renderSurveysTable(surveys) {
                const tableBody = document.getElementById('allSurveysTable');
                
                if (surveys.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #64748b;">No surveys found matching current filters</td></tr>';
                    return;
                }

                tableBody.innerHTML = surveys.map(survey => `
                    <tr>
                        <td title="${survey.response_id}">${survey.response_id.substring(0, 12)}...</td>
                        <td>${survey.patient_info?.full_name || 'N/A'}</td>
                        <td>${survey.patient_info?.email || 'N/A'}</td>
                        <td>${survey.patient_info?.department_visited || 'N/A'}</td>
                        <td>
                            <span class="status-badge ${this.getSatisfactionClass(survey.experience_data?.overall_satisfaction)}">
                                ${survey.experience_data?.overall_satisfaction || 'N/A'}/5
                            </span>
                        </td>
                        <td>${survey.patient_info?.visit_date || 'N/A'}</td>
                        <td>
                            <span class="status-badge ${survey.contact_preferences?.wants_contact === 'yes' ? 'status-pending' : 'status-completed'}">
                                ${survey.contact_preferences?.wants_contact === 'yes' ? 'Yes' : 'No'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="viewSurvey('${survey.response_id}')">View</button>
                        </td>
                    </tr>
                `).join('');
            }

            applyFiltersToQuery(query) {
                // Apply department filter using JSONB operator
                if (this.currentFilters.department) {
                    query = query.eq('patient_info->department_visited', this.currentFilters.department);
                }

                // Apply date range filter
                if (this.currentFilters.dateRange) {
                    const { startDate, endDate } = this.getDateRange(this.currentFilters.dateRange);
                    if (startDate && endDate) {
                        query = query
                            .gte('patient_info->visit_date', startDate)
                            .lte('patient_info->visit_date', endDate);
                    }
                }

                // Apply custom date range
                if (this.currentFilters.startDate && this.currentFilters.endDate) {
                    query = query
                        .gte('patient_info->visit_date', this.currentFilters.startDate)
                        .lte('patient_info->visit_date', this.currentFilters.endDate);
                }

                // Apply satisfaction filter using JSONB operator
                if (this.currentFilters.satisfaction) {
                    switch (this.currentFilters.satisfaction) {
                        case 'low':
                            query = query.lte('experience_data->overall_satisfaction', '2');
                            break;
                        case 'medium':
                            query = query.eq('experience_data->overall_satisfaction', '3');
                            break;
                        case 'high':
                            query = query.gte('experience_data->overall_satisfaction', '4');
                            break;
                    }
                }

                return query;
            }

            getDateRange(range) {
                const today = new Date();
                let startDate, endDate;

                switch (range) {
                    case 'today':
                        startDate = endDate = today.toISOString().split('T')[0];
                        break;
                    case 'yesterday':
                        const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
                        startDate = endDate = yesterday.toISOString().split('T')[0];
                        break;
                    case 'week':
                        const weekStart = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                        startDate = weekStart.toISOString().split('T')[0];
                        endDate = today.toISOString().split('T')[0];
                        break;
                    case 'month':
                        const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                        startDate = monthStart.toISOString().split('T')[0];
                        endDate = today.toISOString().split('T')[0];
                        break;
                    case 'quarter':
                        const quarterStart = new Date(today.getFullYear(), Math.floor(today.getMonth() / 3) * 3, 1);
                        startDate = quarterStart.toISOString().split('T')[0];
                        endDate = today.toISOString().split('T')[0];
                        break;
                    case 'year':
                        const yearStart = new Date(today.getFullYear(), 0, 1);
                        startDate = yearStart.toISOString().split('T')[0];
                        endDate = today.toISOString().split('T')[0];
                        break;
                }

                return { startDate, endDate };
            }

            async loadAnalyticsData() {
                try {
                    await this.updateAnalyticsMetrics();
                    await this.createSatisfactionTrendChart();
                    await this.createDepartmentPerformanceChart();
                    await this.createWaitTimeChart();
                    await this.createRatingDistributionChart();
                } catch (error) {
                    console.error('‚ùå Error loading analytics data:', error);
                    this.showError('Failed to load analytics data');
                }
            }

            async updateAnalyticsMetrics() {
                try {
                    // Get last 30 days of surveys
                    const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
                    
                    const { data: surveys, error } = await this.supabase
                        .from('patient_survey_responses')
                        .select('*')
                        .gte('created_at', thirtyDaysAgo.toISOString());

                    if (error) throw error;

                    const totalResponses = surveys.length;
                    const validRatings = surveys.filter(s => s.experience_data?.overall_satisfaction);
                    
                    const avgOverall = validRatings.length > 0 
                        ? (validRatings.reduce((sum, s) => sum + parseInt(s.experience_data.overall_satisfaction), 0) / validRatings.length).toFixed(1)
                        : '0.0';
                    
                    const satisfactionRate = validRatings.length > 0 
                        ? Math.round((validRatings.filter(s => parseInt(s.experience_data.overall_satisfaction) >= 4).length / validRatings.length) * 100)
                        : 0;
                    
                    const responseRate = surveys.length > 0 
                        ? Math.round((surveys.filter(s => s.contact_preferences?.wants_contact === 'yes').length / surveys.length) * 100)
                        : 0;

                    // Update metrics
                    document.getElementById('totalResponsesMetric').textContent = totalResponses;
                    document.getElementById('avgOverallMetric').textContent = avgOverall;
                    document.getElementById('satisfactionRateMetric').textContent = satisfactionRate + '%';
                    document.getElementById('responseRateMetric').textContent = responseRate + '%';

                } catch (error) {
                    console.error('‚ùå Error updating analytics metrics:', error);
                    // Set default values
                    document.getElementById('totalResponsesMetric').textContent = '0';
                    document.getElementById('avgOverallMetric').textContent = '0.0';
                    document.getElementById('satisfactionRateMetric').textContent = '0%';
                    document.getElementById('responseRateMetric').textContent = '0%';
                }
            }

            async createSatisfactionTrendChart() {
                const ctx = document.getElementById('satisfactionChart');
                if (!ctx) return;

                try {
                    // Clear existing chart
                    if (this.charts.satisfaction) {
                        this.charts.satisfaction.destroy();
                    }

                    // Get last 7 days of data
                    const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                    
                    const { data: surveys, error } = await this.supabase
                        .from('patient_survey_responses')
                        .select('*')
                        .gte('created_at', sevenDaysAgo.toISOString())
                        .order('created_at', { ascending: true });

                    if (error) throw error;

                    // Group by day
                    const dailyData = {};
                    const last7Days = [];
                    for (let i = 6; i >= 0; i--) {
                        const date = new Date();
                        date.setDate(date.getDate() - i);
                        const dateStr = date.toISOString().split('T')[0];
                        last7Days.push(dateStr);
                        dailyData[dateStr] = [];
                    }

                    surveys.forEach(survey => {
                        const visitDate = survey.patient_info?.visit_date;
                        if (visitDate && dailyData[visitDate] && survey.experience_data?.overall_satisfaction) {
                            dailyData[visitDate].push(parseInt(survey.experience_data.overall_satisfaction));
                        }
                    });

                    const chartData = last7Days.map(date => {
                        const ratings = dailyData[date];
                        return ratings.length > 0 
                            ? (ratings.reduce((sum, r) => sum + r, 0) / ratings.length).toFixed(1)
                            : null;
                    });

                    const labels = last7Days.map(date => {
                        const d = new Date(date);
                        return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                    });

                    this.charts.satisfaction = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Average Satisfaction',
                                data: chartData,
                                borderColor: '#2c5aa0',
                                backgroundColor: 'rgba(44, 90, 160, 0.1)',
                                tension: 0.4,
                                fill: true,
                                spanGaps: true
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 5,
                                    ticks: {
                                        stepSize: 1
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: true
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error('‚ùå Error creating satisfaction trend chart:', error);
                }
            }

            async createDepartmentPerformanceChart() {
                const ctx = document.getElementById('departmentChart');
                if (!ctx) return;

                try {
                    // Clear existing chart
                    if (this.charts.department) {
                        this.charts.department.destroy();
                    }

                    const { data: surveys, error } = await this.supabase
                        .from('patient_survey_responses')
                        .select('*')
                        .gte('created_at', new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString());

                    if (error) throw error;

                    // Group by department
                    const deptData = {};
                    surveys.forEach(survey => {
                        const dept = survey.patient_info?.department_visited;
                        const rating = survey.experience_data?.overall_satisfaction;
                        if (dept && rating) {
                            if (!deptData[dept]) deptData[dept] = [];
                            deptData[dept].push(parseInt(rating));
                        }
                    });

                    const departments = Object.keys(deptData).slice(0, 8); // Top 8 departments
                    const data = departments.map(dept => {
                        const ratings = deptData[dept];
                        return ratings.length > 0 
                            ? (ratings.reduce((sum, r) => sum + r, 0) / ratings.length).toFixed(1)
                            : 0;
                    });

                    const colors = [
                        '#10b981', '#f59e0b', '#3b82f6', '#ef4444', 
                        '#8b5cf6', '#06b6d4', '#84cc16', '#f97316'
                    ];

                    this.charts.department = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: departments.map(dept => dept.length > 15 ? dept.substring(0, 15) + '...' : dept),
                            datasets: [{
                                label: 'Average Rating',
                                data: data,
                                backgroundColor: colors.slice(0, departments.length)
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: { 
                                y: { 
                                    beginAtZero: true, 
                                    max: 5,
                                    ticks: {
                                        stepSize: 1
                                    }
                                } 
                            },
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error('‚ùå Error creating department chart:', error);
                }
            }

            async createWaitTimeChart() {
                const ctx = document.getElementById('waitTimeChart');
                if (!ctx) return;

                try {
                    // Clear existing chart
                    if (this.charts.waitTime) {
                        this.charts.waitTime.destroy();
                    }

                    const { data: surveys, error } = await this.supabase
                        .from('patient_survey_responses')
                        .select('experience_data')
                        .gte('created_at', new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString());

                    if (error) throw error;

                    const waitTimes = [
                        '0-5 minutes', '6-10 minutes', '11-15 minutes', 
                        '16-30 minutes', '31-45 minutes', '46-60 minutes', 
                        'More than 1 hour'
                    ];
                    
                    const counts = waitTimes.map(time => 
                        surveys.filter(s => s.experience_data?.wait_time_actual === time).length
                    );

                    this.charts.waitTime = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: waitTimes,
                            datasets: [{
                                data: counts,
                                backgroundColor: [
                                    '#10b981', '#22c55e', '#84cc16', 
                                    '#f59e0b', '#ef4444', '#dc2626', '#991b1b'
                                ]
                            }]
                        },
                        options: { 
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error('‚ùå Error creating wait time chart:', error);
                }
            }

            async createRatingDistributionChart() {
                const ctx = document.getElementById('ratingChart');
                if (!ctx) return;

                try {
                    // Clear existing chart
                    if (this.charts.rating) {
                        this.charts.rating.destroy();
                    }

                    const { data: surveys, error } = await this.supabase
                        .from('patient_survey_responses')
                        .select('experience_data')
                        .gte('created_at', new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString());

                    if (error) throw error;

                    const ratingCounts = [1, 2, 3, 4, 5].map(rating => 
                        surveys.filter(s => parseInt(s.experience_data?.overall_satisfaction) === rating).length
                    );

                    this.charts.rating = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['1 Star', '2 Stars', '3 Stars', '4 Stars', '5 Stars'],
                            datasets: [{
                                label: 'Number of Responses',
                                data: ratingCounts,
                                backgroundColor: '#2c5aa0'
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: { 
                                y: { 
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    }
                                } 
                            },
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error('‚ùå Error creating rating distribution chart:', error);
                }
            }

            async loadFollowUpsData() {
                try {
                    const { data: followUps, error } = await this.supabase
                        .from('follow_up_tasks')
                        .select(`
                            *,
                            admin_users!follow_up_tasks_assigned_to_fkey(full_name)
                        `)
                        .order('created_at', { ascending: false });

                    if (error) throw error;

                    this.renderFollowUpsTable(followUps);

                } catch (error) {
                    console.error('‚ùå Error loading follow-ups data:', error);
                    this.showError('Failed to load follow-ups data');
                }
            }

            renderFollowUpsTable(followUps) {
                const tableBody = document.getElementById('followUpsTable');
                
                if (followUps.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #64748b;">No follow-up tasks found</td></tr>';
                    return;
                }

                tableBody.innerHTML = followUps.map(followUp => `
                    <tr>
                        <td>${followUp.patient_name}</td>
                        <td>
                            <span class="status-badge ${followUp.contact_method === 'email' ? 'status-medium' : followUp.contact_method === 'phone' ? 'status-low' : 'status-high'}">
                                ${followUp.contact_method}
                            </span>
                        </td>
                        <td>
                            <span class="status-badge ${followUp.priority === 'urgent' ? 'status-high' : followUp.priority === 'high' ? 'status-medium' : 'status-low'}">
                                ${followUp.priority}
                            </span>
                        </td>
                        <td>${followUp.admin_users?.full_name || 'Unassigned'}</td>
                        <td>
                            <span class="status-badge status-${followUp.status}">
                                ${followUp.status.replace('_', ' ')}
                            </span>
                        </td>
                        <td>
                            <span class="status-badge status-medium">
                                Follow-up needed
                            </span>
                        </td>
                        <td>${new Date(followUp.created_at).toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="viewFollowUp('${followUp.id}')">View</button>
                            ${followUp.status === 'pending' ? 
                                `<button class="btn btn-success btn-sm" onclick="completeFollowUp('${followUp.id}')">Complete</button>` : ''
                            }
                        </td>
                    </tr>
                `).join('');
            }

            async loadUsersData() {
                try {
                    const { data: users, error } = await this.supabase
                        .from('admin_users')
                        .select('*')
                        .order('created_at', { ascending: false });

                    if (error) throw error;

                    this.renderUsersTable(users);

                } catch (error) {
                    console.error('‚ùå Error loading users data:', error);
                    this.showError('Failed to load users data');
                }
            }

            renderUsersTable(users) {
                const tableBody = document.getElementById('usersTable');
                
                if (users.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #64748b;">No users found</td></tr>';
                    return;
                }

                tableBody.innerHTML = users.map(user => `
                    <tr>
                        <td>${user.full_name}</td>
                        <td>${user.email}</td>
                        <td>
                            <span class="status-badge ${user.role === 'super_admin' ? 'status-high' : 'status-medium'}">
                                ${user.role.replace('_', ' ').toUpperCase()}
                            </span>
                        </td>
                        <td>${user.department || '-'}</td>
                        <td>${user.last_login ? new Date(user.last_login).toLocaleDateString() : 'Never'}</td>
                        <td>
                            <span class="status-badge ${user.is_active ? 'status-high' : 'status-low'}">
                                ${user.is_active ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td>
                            ${this.currentAdminUser.role === 'super_admin' && user.id !== this.currentAdminUser.id ? 
                                `<button class="btn btn-danger btn-sm" onclick="toggleUserStatus('${user.id}', ${!user.is_active})">${user.is_active ? 'Disable' : 'Enable'}</button>` 
                                : 'No actions available'
                            }
                        </td>
                    </tr>
                `).join('');
            }

            async loadSettingsData() {
                try {
                    const { data: settings, error } = await this.supabase
                        .from('system_settings')
                        .select('*');

                    if (error) throw error;

                    // Populate settings form
                    settings.forEach(setting => {
                        const element = document.getElementById(this.settingKeyToElementId(setting.setting_key));
                        if (element) {
                            element.value = setting.setting_value;
                        }
                    });

                } catch (error) {
                    console.error('‚ùå Error loading settings:', error);
                    this.showError('Failed to load settings');
                }
            }

            settingKeyToElementId(key) {
                const mapping = {
                    'survey_auto_restart_time': 'autoRestartTime',
                    'survey_idle_timeout': 'idleTimeout',
                    'dashboard_refresh_interval': 'dashboardRefresh',
                    'low_rating_threshold': 'lowRatingThreshold',
                    'max_follow_up_attempts': 'maxFollowUpAttempts',
                    'email_notifications_enabled': 'emailNotifications'
                };
                return mapping[key] || key;
            }

            handleDateRangeChange() {
                const dateRange = document.getElementById('dateRangeFilter').value;
                const customDateGroup = document.getElementById('customDateGroup');
                const customDateGroup2 = document.getElementById('customDateGroup2');

                if (dateRange === 'custom') {
                    customDateGroup.style.display = 'flex';
                    customDateGroup2.style.display = 'flex';
                } else {
                    customDateGroup.style.display = 'none';
                    customDateGroup2.style.display = 'none';
                }
            }

            async logActivity(action, resourceType = null, resourceId = null, details = null) {
                try {
                    await this.supabase
                        .from('admin_activity_log')
                        .insert({
                            admin_id: this.currentAdminUser.id,
                            action,
                            resource_type: resourceType,
                            resource_id: resourceId,
                            details
                        });
                } catch (error) {
                    console.warn('‚ùå Could not log activity (this is okay):', error);
                    // Don't throw error - activity logging is not critical
                }
            }

            showError(message) {
                this.showMessage(message, 'error');
            }

            showSuccess(message) {
                this.showMessage(message, 'success');
            }

            showMessage(message, type = 'error') {
                const errorDiv = document.getElementById('authError');
                const successDiv = document.getElementById('authSuccess');
                
                if (type === 'error') {
                    errorDiv.textContent = message;
                    errorDiv.style.display = 'block';
                    successDiv.style.display = 'none';
                } else {
                    successDiv.textContent = message;
                    successDiv.style.display = 'block';
                    errorDiv.style.display = 'none';
                }

                // Auto-hide after 5 seconds
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                    successDiv.style.display = 'none';
                }, 5000);
            }

            hideMessages() {
                document.getElementById('authError').style.display = 'none';
                document.getElementById('authSuccess').style.display = 'none';
            }

            async refreshData() {
                await this.loadDashboardData();
                console.log('‚úÖ Dashboard data refreshed');
            }
        }

        // Global functions for UI interactions
        function switchAuthTab(tabName) {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const loginTab = document.querySelector('.auth-tab:first-child');
            const registerTab = document.querySelector('.auth-tab:last-child');

            if (tabName === 'login') {
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                loginTab.classList.add('active');
                registerTab.classList.remove('active');
            } else {
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
                loginTab.classList.remove('active');
                registerTab.classList.add('active');
            }

            // Hide messages when switching tabs
            if (window.adminDashboard) {
                window.adminDashboard.hideMessages();
            }
        }

        function viewSurvey(responseId) {
            if (window.adminDashboard && window.adminDashboard.supabase) {
                window.adminDashboard.supabase
                    .from('patient_survey_responses')
                    .select('*')
                    .eq('response_id', responseId)
                    .single()
                    .then(({ data: survey, error }) => {
                        if (error) {
                            console.error('Error loading survey:', error);
                            return;
                        }

                        const modal = document.getElementById('surveyModal');
                        const details = document.getElementById('surveyDetails');
                        
                        details.innerHTML = `
                            <h3>Survey Details</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 20px;">
                                <div>
                                    <h4>Patient Information</h4>
                                    <p><strong>Name:</strong> ${survey.patient_info?.full_name || 'N/A'}</p>
                                    <p><strong>Email:</strong> ${survey.patient_info?.email || 'N/A'}</p>
                                    <p><strong>Phone:</strong> ${survey.patient_info?.phone || 'N/A'}</p>
                                    <p><strong>Visit Date:</strong> ${survey.patient_info?.visit_date || 'N/A'}</p>
                                    <p><strong>Visit Time:</strong> ${survey.patient_info?.visit_time || 'N/A'}</p>
                                    <p><strong>Department:</strong> ${survey.patient_info?.department_visited || 'N/A'}</p>
                                </div>
                                <div>
                                    <h4>Ratings (1-5 scale)</h4>
                                    <p><strong>Overall Satisfaction:</strong> ${survey.experience_data?.overall_satisfaction || 'N/A'}/5</p>
                                    <p><strong>Reception:</strong> ${survey.experience_data?.reception_rating || 'N/A'}/5</p>
                                    <p><strong>Doctor/Provider:</strong> ${survey.experience_data?.doctor_rating || 'N/A'}/5</p>
                                    <p><strong>Nursing:</strong> ${survey.experience_data?.nursing_rating || 'N/A'}/5</p>
                                    <p><strong>Staff Professionalism:</strong> ${survey.experience_data?.staff_professionalism || 'N/A'}/5</p>
                                </div>
                                <div>
                                    <h4>Experience Details</h4>
                                    <p><strong>Wait Time:</strong> ${survey.experience_data?.wait_time_actual || 'N/A'}</p>
                                    <p><strong>Appointment Timeliness:</strong> ${survey.experience_data?.appointment_timeliness || 'N/A'}</p>
                                </div>
                                <div>
                                    <h4>Contact Preferences</h4>
                                    <p><strong>Wants Contact:</strong> ${survey.contact_preferences?.wants_contact === 'yes' ? 'Yes' : 'No'}</p>
                                    <p><strong>Methods:</strong> ${survey.contact_preferences?.contact_methods?.join(', ') || 'None'}</p>
                                </div>
                            </div>
                            ${survey.experience_data?.additional_comments ? `
                                <div style="margin-top: 20px;">
                                    <h4>Additional Comments</h4>
                                    <p style="background: #f8f9fa; padding: 10px; border-radius: 6px;">${survey.experience_data.additional_comments}</p>
                                </div>
                            ` : ''}
                            <div style="margin-top: 20px; font-size: 12px; color: #666;">
                                <p><strong>Survey ID:</strong> ${survey.response_id}</p>
                                <p><strong>Submitted:</strong> ${new Date(survey.created_at).toLocaleString()}</p>
                            </div>
                        `;
                        
                        modal.style.display = 'block';
                    })
                    .catch(error => {
                        console.error('Error viewing survey:', error);
                        alert('Error loading survey details');
                    });
            }
        }

        function closeSurveyModal() {
            document.getElementById('surveyModal').style.display = 'none';
        }

        function viewFollowUp(followUpId) {
            // Implementation for viewing follow-up details
            alert(`Viewing follow-up task: ${followUpId}`);
        }

        function closeFollowUpModal() {
            document.getElementById('followUpModal').style.display = 'none';
        }

        async function completeFollowUp(followUpId) {
            if (confirm('Mark this follow-up as completed?')) {
                try {
                    await window.adminDashboard.supabase
                        .from('follow_up_tasks')
                        .update({ 
                            status: 'completed',
                            completed_date: new Date().toISOString()
                        })
                        .eq('id', followUpId);

                    await window.adminDashboard.loadFollowUpsData();
                    alert('Follow-up marked as completed');
                } catch (error) {
                    console.error('Error completing follow-up:', error);
                    alert('Error completing follow-up');
                }
            }
        }

        function applyFilters() {
            if (window.adminDashboard) {
                const filters = {
                    department: document.getElementById('departmentFilter').value,
                    dateRange: document.getElementById('dateRangeFilter').value,
                    satisfaction: document.getElementById('satisfactionFilter').value
                };

                if (filters.dateRange === 'custom') {
                    filters.startDate = document.getElementById('startDate').value;
                    filters.endDate = document.getElementById('endDate').value;
                }

                window.adminDashboard.currentFilters = filters;
                window.adminDashboard.loadSurveysData();
            }
        }

        function toggleExportDropdown() {
            const dropdown = document.querySelector('.export-dropdown');
            dropdown.classList.toggle('show');
        }

        function exportSurveys(format) {
            const dropdown = document.querySelector('.export-dropdown');
            dropdown.classList.remove('show');
            
            if (window.adminDashboard && window.adminDashboard.filteredData) {
                const data = window.adminDashboard.filteredData;
                
                switch (format) {
                    case 'excel':
                        exportToExcel(data, 'patient-surveys');
                        break;
                    case 'csv':
                        exportToCSV(data, 'patient-surveys');
                        break;
                    case 'json':
                        exportToJSON(data, 'patient-surveys');
                        break;
                }
            } else {
                alert('No data available for export');
            }
        }

        function exportToExcel(data, filename) {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Surveys');
            XLSX.writeFile(wb, `${filename}-${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function exportToCSV(data, filename) {
            const csv = convertToCSV(data);
            downloadFile(csv, `${filename}-${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
        }

        function exportToJSON(data, filename) {
            const json = JSON.stringify(data, null, 2);
            downloadFile(json, `${filename}-${new Date().toISOString().split('T')[0]}.json`, 'application/json');
        }

        function convertToCSV(data) {
            if (!data.length) return '';
            
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(field => {
                    const value = row[field];
                    return typeof value === 'object' ? JSON.stringify(value) : value;
                }).join(','))
            ].join('\n');
            
            return csvContent;
        }

        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function exportRecentSurveys() {
            if (window.adminDashboard && window.adminDashboard.supabase) {
                window.adminDashboard.supabase
                    .from('patient_survey_responses')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(10)
                    .then(({ data, error }) => {
                        if (error) {
                            alert('Error exporting data');
                            return;
                        }
                        exportToExcel(data, 'recent-surveys');
                    });
            }
        }

        function exportFollowUps() {
            if (window.adminDashboard && window.adminDashboard.supabase) {
                window.adminDashboard.supabase
                    .from('follow_up_tasks')
                    .select('*')
                    .then(({ data, error }) => {
                        if (error) {
                            alert('Error exporting data');
                            return;
                        }
                        exportToExcel(data, 'follow-up-tasks');
                    });
            }
        }

        async function toggleUserStatus(userId, newStatus) {
            if (confirm(`Are you sure you want to ${newStatus ? 'enable' : 'disable'} this user?`)) {
                try {
                    await window.adminDashboard.supabase
                        .from('admin_users')
                        .update({ is_active: newStatus })
                        .eq('id', userId);

                    await window.adminDashboard.loadUsersData();
                    alert(`User ${newStatus ? 'enabled' : 'disabled'} successfully`);
                } catch (error) {
                    console.error('Error updating user status:', error);
                    alert('Error updating user status');
                }
            }
        }

        async function saveSettings() {
            try {
                const settings = {
                    'survey_auto_restart_time': document.getElementById('autoRestartTime').value,
                    'survey_idle_timeout': document.getElementById('idleTimeout').value,
                    'dashboard_refresh_interval': document.getElementById('dashboardRefresh').value,
                    'low_rating_threshold': document.getElementById('lowRatingThreshold').value,
                    'max_follow_up_attempts': document.getElementById('maxFollowUpAttempts').value,
                    'email_notifications_enabled': document.getElementById('emailNotifications').value
                };

                for (const [key, value] of Object.entries(settings)) {
                    await window.adminDashboard.supabase
                        .from('system_settings')
                        .upsert({
                            setting_key: key,
                            setting_value: value,
                            updated_by: window.adminDashboard.currentAdminUser.id
                        });
                }

                alert('Settings saved successfully!');
            } catch (error) {
                console.error('Error saving settings:', error);
                alert('Error saving settings');
            }
        }

        function refreshData() {
            if (window.adminDashboard) {
                window.adminDashboard.refreshData();
            }
        }

        // Close dropdowns when clicking outside
        window.onclick = function(event) {
            if (!event.target.matches('.btn')) {
                const dropdowns = document.getElementsByClassName('export-dropdown-content');
                for (let i = 0; i < dropdowns.length; i++) {
                    const openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.adminDashboard = new AdminDashboard();
        });
    </script>
</body>
</html>
