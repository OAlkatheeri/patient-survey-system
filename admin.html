<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinic Survey Admin Dashboard</title>
    
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <!-- Export libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Auth Screen Styles */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .auth-form {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 450px;
        }

        .auth-form h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c5aa0;
            font-size: 28px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2c5aa0;
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
        }

        .btn-primary {
            width: 100%;
            background: linear-gradient(135deg, #2c5aa0 0%, #1e3a8a 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(44, 90, 160, 0.3);
        }

        .error-message {
            color: #dc2626;
            background: #fee2e2;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        /* Dashboard Layout */
        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #2c5aa0;
            font-size: 24px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info .role-badge {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .user-info .role-badge.super-admin {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        .btn-logout {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
        }

        .btn-logout:hover {
            background: #dc2626;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            padding: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            overflow-x: auto;
        }

        .nav-tab {
            background: none;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
            color: #64748b;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #2c5aa0 0%, #1e3a8a 100%);
            color: white;
        }

        .nav-tab:hover:not(.active) {
            background: #f1f5f9;
            color: #2c5aa0;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border-left: 4px solid;
        }

        .stat-card.primary { border-color: #2c5aa0; }
        .stat-card.success { border-color: #10b981; }
        .stat-card.warning { border-color: #f59e0b; }
        .stat-card.danger { border-color: #ef4444; }

        .stat-card h3 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-card p {
            color: #64748b;
            font-weight: 500;
        }

        .stat-card .trend {
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
        }

        .trend.up { color: #10b981; }
        .trend.down { color: #ef4444; }

        /* Tables */
        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .table-header {
            padding: 20px 25px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .table-header h3 {
            color: #1e293b;
            font-size: 18px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px 25px;
            text-align: left;
            border-bottom: 1px solid #f1f5f9;
        }

        th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
            cursor: pointer;
            position: relative;
            user-select: none;
        }

        th:hover {
            background: #f1f5f9;
        }

        th.sortable::after {
            content: '↕';
            position: absolute;
            right: 10px;
            opacity: 0.3;
        }

        th.sort-asc::after {
            content: '↑';
            opacity: 1;
        }

        th.sort-desc::after {
            content: '↓';
            opacity: 1;
        }

        tbody tr:hover {
            background: #f8fafc;
        }

        /* Charts */
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .chart-container h3 {
            margin-bottom: 20px;
            color: #1e293b;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
        }

        /* Buttons */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-primary { background: #2c5aa0; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-secondary { background: #6b7280; color: white; }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Status badges */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending { background: #fef3c7; color: #92400e; }
        .status-completed { background: #d1fae5; color: #065f46; }
        .status-high { background: #d1fae5; color: #065f46; }
        .status-medium { background: #fef3c7; color: #92400e; }
        .status-low { background: #fee2e2; color: #991b1b; }
        .status-active { background: #d1fae5; color: #065f46; }
        .status-inactive { background: #fee2e2; color: #991b1b; }

        /* Filters */
        .filters {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 20px;
            border-radius: 12px;
            width: 95%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .modal-header h3 {
            margin: 0;
            color: #1e293b;
            font-size: 1.25rem;
        }

        /* Survey Detail Modal Styles */
        .survey-detail-container {
            max-height: 70vh;
            overflow-y: auto;
            padding-right: 10px;
        }

        .detail-section {
            margin-bottom: 25px;
            background: #f8fafc;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e2e8f0;
        }

        .section-title {
            margin: 0 0 15px 0;
            color: #1e293b;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 8px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .detail-item.full-width {
            grid-column: 1 / -1;
        }

        .detail-item label {
            font-weight: 600;
            color: #475569;
            font-size: 0.9rem;
        }

        .detail-item span {
            color: #1e293b;
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            min-height: 38px;
            display: flex;
            align-items: center;
        }

        /* User Management Styles */
        .user-form {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .user-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        /* Loading spinner */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #2c5aa0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                justify-content: flex-start;
            }

            table {
                font-size: 14px;
            }

            th, td {
                padding: 10px 15px;
            }

            .chart-grid {
                grid-template-columns: 1fr;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Authentication Screen -->
    <div id="authScreen" class="auth-container">
        <div class="auth-form">
            <h1>🏥 Admin Portal</h1>
            
            <div id="authError" class="error-message"></div>

            <!-- Login Form -->
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email Address</label>
                    <input type="email" id="loginEmail" required placeholder="admin@clinic.com">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" required placeholder="Enter your password">
                </div>
                <button type="submit" class="btn-primary">Sign In</button>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <h1>📊 Clinic Survey Dashboard</h1>
                <div class="user-info">
                    <span id="userName">Admin User</span>
                    <span id="userRole" class="role-badge">Admin</span>
                    <button id="logoutBtn" class="btn-logout">Logout</button>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="nav-tabs">
                <button class="nav-tab active" data-tab="overview">📈 Overview</button>
                <button class="nav-tab" data-tab="surveys">📋 All Surveys</button>
                <button class="nav-tab" data-tab="analytics">📊 Analytics</button>
                <button class="nav-tab" data-tab="follow-ups">📞 Follow-ups</button>
                <button class="nav-tab super-admin-only" data-tab="users" style="display: none;">👥 Users</button>
            </div>

            <!-- Overview Tab -->
            <div id="overview" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card primary">
                        <h3 id="totalSurveys">0</h3>
                        <p>Total Surveys Today</p>
                        <div class="trend up">Loading...</div>
                    </div>
                    <div class="stat-card success">
                        <h3 id="avgSatisfaction">0.0</h3>
                        <p>Average Satisfaction</p>
                        <div class="trend up">Loading...</div>
                    </div>
                    <div class="stat-card warning">
                        <h3 id="pendingFollowUps">0</h3>
                        <p>Pending Follow-ups</p>
                        <div class="trend down">Loading...</div>
                    </div>
                    <div class="stat-card danger">
                        <h3 id="dissatisfiedCount">0</h3>
                        <p>Dissatisfied Patients</p>
                        <div class="trend down">Loading...</div>
                    </div>
                </div>

                <!-- Recent Surveys -->
                <div class="table-container">
                    <div class="table-header">
                        <h3>Recent Survey Responses</h3>
                        <div class="table-actions">
                            <button class="btn btn-primary btn-sm" onclick="refreshData()">🔄 Refresh</button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="patient_name">Patient Name</th>
                                <th>Contact Info</th>
                                <th class="sortable" data-sort="clinic_location">Clinic</th>
                                <th class="sortable" data-sort="overall_satisfaction">Overall Rating</th>
                                <th class="sortable" data-sort="visit_date">Visit Date</th>
                                <th class="sortable" data-sort="submitted_at">Submitted</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recentSurveysTable">
                            <tr>
                                <td colspan="7" class="loading">
                                    <div class="spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- All Surveys Tab -->
            <div id="surveys" class="tab-content">
                <div class="filters">
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label>Clinic</label>
                            <select id="clinicFilter">
                                <option value="">All Clinics</option>
                                <option value="clinic1">UAEU Main Campus Clinic - Al Ain</option>
                                <option value="clinic2">UAEU Medical Campus Clinic - Al Ain</option>
                                <option value="clinic3">EGA Dubai Clinic - Dubai</option>
                                <option value="clinic4">EGA Abu Dhabi Clinic - Abu Dhabi</option>
                                <option value="clinic5">UAEU Al Ain Campus Clinic - Al Ain</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Date Range</label>
                            <select id="dateRangeFilter">
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="all">All Time</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Satisfaction Level</label>
                            <select id="satisfactionFilter">
                                <option value="">All Ratings</option>
                                <option value="very_satisfied">Very Satisfied</option>
                                <option value="satisfied">Satisfied</option>
                                <option value="dissatisfied">Dissatisfied</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Search</label>
                            <input type="text" id="searchFilter" placeholder="Search by name, email, or phone...">
                        </div>
                        <div class="filter-group">
                            <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-header">
                        <h3>All Survey Responses</h3>
                        <div class="table-actions">
                            <button class="btn btn-success btn-sm" onclick="exportData('excel')">📊 Export Excel</button>
                            <button class="btn btn-warning btn-sm" onclick="exportData('pdf')">📄 Export PDF Summary</button>
                            <button class="btn btn-primary btn-sm" onclick="loadSurveysData()">🔄 Refresh</button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Survey ID</th>
                                <th class="sortable" data-sort="patient_name">Patient Name</th>
                                <th>Contact Info</th>
                                <th class="sortable" data-sort="clinic_location">Clinic</th>
                                <th class="sortable" data-sort="overall_satisfaction">Overall Rating</th>
                                <th class="sortable" data-sort="visit_date">Visit Date</th>
                                <th class="sortable" data-sort="want_contact">Follow-up</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="allSurveysTable">
                            <tr>
                                <td colspan="8" class="loading">
                                    <div class="spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics" class="tab-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="totalResponsesMetric">0</h3>
                        <p>Total Responses (30 days)</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="avgOverallMetric">0.0</h3>
                        <p>Average Overall Rating</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="satisfactionRateMetric">0%</h3>
                        <p>Satisfaction Rate</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="responseRateMetric">0%</h3>
                        <p>Follow-up Request Rate</p>
                    </div>
                </div>

                <div class="chart-grid">
                    <div class="chart-container">
                        <h3>Satisfaction Trends (Last 7 Days)</h3>
                        <canvas id="satisfactionChart" width="400" height="200"></canvas>
                    </div>

                    <div class="chart-container">
                        <h3>Clinic Performance</h3>
                        <canvas id="clinicChart" width="400" height="200"></canvas>
                    </div>

                    <div class="chart-container">
                        <h3>Department Ratings</h3>
                        <canvas id="departmentChart" width="400" height="200"></canvas>
                    </div>

                    <div class="chart-container">
                        <h3>Overall Rating Distribution</h3>
                        <canvas id="ratingChart" width="400" height="200"></canvas>
                    </div>
                </div>

                <!-- Additional Analytics Section -->
                <div class="chart-grid">
                    <div class="chart-container">
                        <h3>Visit Type Breakdown</h3>
                        <canvas id="visitTypeChart" width="400" height="200"></canvas>
                    </div>

                    <div class="chart-container">
                        <h3>Service Quality Metrics</h3>
                        <canvas id="serviceQualityChart" width="400" height="200"></canvas>
                    </div>

                    <div class="chart-container">
                        <h3>Recommendation Likelihood</h3>
                        <canvas id="recommendationChart" width="400" height="200"></canvas>
                    </div>

                    <div class="chart-container">
                        <h3>Follow-up Requests by Satisfaction</h3>
                        <canvas id="followupBySatisfactionChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>

            <!-- Follow-ups Tab -->
            <div id="follow-ups" class="tab-content">
                <div class="table-container">
                    <div class="table-header">
                        <h3>Follow-up Tasks</h3>
                        <div class="table-actions">
                            <button class="btn btn-primary btn-sm" onclick="loadFollowUpsData()">🔄 Refresh</button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="patient_name">Patient</th>
                                <th>Contact Info</th>
                                <th>Preferred Contact</th>
                                <th class="sortable" data-sort="clinic_location">Clinic</th>
                                <th class="sortable" data-sort="priority">Priority</th>
                                <th class="sortable" data-sort="status">Status</th>
                                <th class="sortable" data-sort="overall_satisfaction">Survey Rating</th>
                                <th class="sortable" data-sort="created_at">Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="followUpsTable">
                            <tr>
                                <td colspan="9" class="loading">
                                    <div class="spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Users Tab (Super Admin Only) -->
            <div id="users" class="tab-content">
                <div class="user-form">
                    <h3>Add New Admin User</h3>
                    <form id="userForm" class="user-form-grid">
                        <div class="filter-group">
                            <label>Name</label>
                            <input type="text" id="newUserName" required placeholder="Full Name">
                        </div>
                        <div class="filter-group">
                            <label>Email</label>
                            <input type="email" id="newUserEmail" required placeholder="email@clinic.com">
                        </div>
                        <div class="filter-group">
                            <label>Password</label>
                            <input type="password" id="newUserPassword" required placeholder="Password">
                        </div>
                        <div class="filter-group">
                            <label>Assigned Clinic</label>
                            <select id="newUserClinic" required>
                                <option value="">Select Clinic</option>
                                <option value="clinic1">UAEU Main Campus Clinic - Al Ain</option>
                                <option value="clinic2">UAEU Medical Campus Clinic - Al Ain</option>
                                <option value="clinic3">EGA Dubai Clinic - Dubai</option>
                                <option value="clinic4">EGA Abu Dhabi Clinic - Abu Dhabi</option>
                                <option value="clinic5">UAEU Al Ain Campus Clinic - Al Ain</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <button type="submit" class="btn btn-primary">Add User</button>
                        </div>
                    </form>
                </div>

                <div class="table-container">
                    <div class="table-header">
                        <h3>Manage Admin Users</h3>
                        <div class="table-actions">
                            <button class="btn btn-primary btn-sm" onclick="loadUsersData()">🔄 Refresh</button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="name">Name</th>
                                <th class="sortable" data-sort="email">Email</th>
                                <th class="sortable" data-sort="role">Role</th>
                                <th class="sortable" data-sort="assignedClinic">Assigned Clinic</th>
                                <th class="sortable" data-sort="status">Status</th>
                                <th class="sortable" data-sort="createdAt">Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable">
                            <tr>
                                <td colspan="7" class="loading">
                                    <div class="spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Survey Detail Modal -->
    <div id="surveyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Survey Details</h3>
                <span class="close" onclick="closeSurveyModal()">&times;</span>
            </div>
            <div id="surveyDetails"></div>
        </div>
    </div>

    
<!-- Supabase SDK -->
<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- Chart.js is already included in your HTML -->

<script>
    // Supabase configuration - REPLACE WITH YOUR ACTUAL VALUES
    const SUPABASE_URL = 'https://vqixnccfatvvythjcwtg.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZxaXhuY2NmYXR2dnl0aGpjd3RnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0ODMyNDMsImV4cCI6MjA2OTA1OTI0M30.WCJRdZ479ZdiLo1CvN4iEftOFm5Uy3YCseY5PcAxdfE';

    // Initialize Supabase client
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Configuration and clinic mapping
    const clinicMap = {
        'clinic1': 'UAEU Main Campus Clinic - Al Ain',
        'clinic2': 'UAEU Medical Campus Clinic - Al Ain',
        'clinic3': 'EGA Dubai Clinic - Dubai',
        'clinic4': 'EGA Abu Dhabi Clinic - Abu Dhabi',
        'clinic5': 'UAEU Al Ain Campus Clinic - Al Ain',
        'other': 'Other Location'
    };

    // Satisfaction scale mapping for calculations
    const satisfactionScales = {
        overall: {
            'dissatisfied': 2,
            'satisfied': 4,
            'very_satisfied': 5
        },
        detailed: {
            'very_dissatisfied': 1,
            'dissatisfied': 2,
            'neutral': 3,
            'satisfied': 4,
            'very_satisfied': 5
        },
        nursing: {
            'poor': 1,
            'fair': 2,
            'good': 3,
            'excellent': 4
        },
        recommendation: {
            'very_unlikely': 1,
            'unlikely': 2,
            'neutral': 3,
            'likely': 4,
            'very_likely': 5
        }
    };

    // Formatting functions
    function formatSatisfaction(satisfaction) {
        const formats = {
            'very_satisfied': 'Very Satisfied',
            'satisfied': 'Satisfied',
            'neutral': 'Neutral',
            'dissatisfied': 'Dissatisfied',
            'very_dissatisfied': 'Very Dissatisfied'
        };
        return formats[satisfaction] || satisfaction;
    }

    function formatProfessionalism(level) {
        const formats = {
            'poor': 'Poor',
            'fair': 'Fair',
            'good': 'Good',
            'excellent': 'Excellent'
        };
        return formats[level] || level;
    }

    function formatRecommendation(likelihood) {
        const formats = {
            'very_unlikely': 'Very Unlikely',
            'unlikely': 'Unlikely',
            'neutral': 'Neutral',
            'likely': 'Likely',
            'very_likely': 'Very Likely'
        };
        return formats[likelihood] || likelihood;
    }

    function formatYesNo(value) {
        return value === 'yes' ? 'Yes' : value === 'no' ? 'No' : value;
    }

    // Main dashboard class
    class AdminDashboard {
        constructor() {
            this.currentUser = null;
            this.charts = {};
            this.filteredData = [];
            this.sortState = {
                recent: { column: 'submitted_at', direction: 'desc' },
                surveys: { column: 'submitted_at', direction: 'desc' },
                followups: { column: 'created_at', direction: 'desc' },
                users: { column: 'createdAt', direction: 'desc' }
            };
            this.init();
        }

        init() {
            this.setupEventListeners();
            this.checkAuthStatus();
        }

        setupEventListeners() {
            // Login form
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleLogin();
                });
            }

            // User form
            const userForm = document.getElementById('userForm');
            if (userForm) {
                userForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleAddUser();
                });
            }

            // Logout button
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => this.handleLogout());
            }

            // Tab navigation
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => this.switchTab(tab.dataset.tab));
            });

            // Sorting headers
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('sortable')) {
                    this.handleSort(e.target);
                }
            });
        }

        async checkAuthStatus() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                
                if (!user) {
                    this.showAuth();
                    return;
                }

                // Get admin details
                const { data: adminUser } = await supabase
                    .from('admin_users')
                    .select('*')
                    .eq('email', user.email)
                    .eq('status', 'active')
                    .single();

                if (!adminUser) {
                    await supabase.auth.signOut();
                    this.showAuth();
                    return;
                }

                this.currentUser = adminUser;
                this.showDashboard();
                this.loadDashboardData();

            } catch (error) {
                console.error('Auth check error:', error);
                this.showAuth();
            }
        }

        async handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                // Sign in with Supabase Auth
                const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });

                if (authError) throw authError;

                // Get admin user details
                const { data: adminUser, error: adminError } = await supabase
                    .from('admin_users')
                    .select('*')
                    .eq('email', email)
                    .eq('status', 'active')
                    .single();

                if (adminError || !adminUser) {
                    await supabase.auth.signOut();
                    this.showError('Access denied. Not an active admin user.');
                    return;
                }

                this.currentUser = adminUser;
                localStorage.setItem('dashboardUser', JSON.stringify(adminUser));
                this.showDashboard();
                this.loadDashboardData();
                
            } catch (error) {
                console.error('Login error:', error);
                this.showError(error.message || 'Invalid credentials');
            }
        }

        async handleLogout() {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                
                localStorage.removeItem('dashboardUser');
                this.currentUser = null;
                this.showAuth();
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        async handleAddUser() {
            const name = document.getElementById('newUserName').value;
            const email = document.getElementById('newUserEmail').value;
            const password = document.getElementById('newUserPassword').value;
            const clinic = document.getElementById('newUserClinic').value;

            try {
                // Step 1: Create user in Supabase Auth using signUp
                const { data: authData, error: authError } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            name: name
                        }
                    }
                });

                if (authError) throw authError;

                // Step 2: Add to admin_users table
                const { data, error } = await supabase
                    .from('admin_users')
                    .insert({
                        name: name,
                        email: email,
                        role: 'admin',
                        assigned_clinic: clinic,
                        status: 'active',
                        created_by: this.currentUser.id
                    })
                    .select()
                    .single();

                if (error) throw error;

                document.getElementById('userForm').reset();
                this.loadUsersData();
                alert('User added successfully! They can now login with their credentials.');
                
            } catch (error) {
                console.error('Add user error:', error);
                
                // If auth succeeded but admin_users failed, we should clean up
                if (error.message && error.message.includes('duplicate key')) {
                    alert('This email already exists in the admin users table');
                } else {
                    alert('Failed to add user: ' + error.message);
                }
            }
        }
        showAuth() {
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('dashboard').classList.remove('active');
        }

        showDashboard() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            
            // Update user info
            document.getElementById('userName').textContent = this.currentUser.name;
            const roleElement = document.getElementById('userRole');
            roleElement.textContent = this.currentUser.role === 'super_admin' ? 'Super Admin' : 'Admin';
            
            if (this.currentUser.role === 'super_admin') {
                roleElement.classList.add('super-admin');
                document.querySelector('[data-tab="users"]').style.display = 'block';
            } else {
                roleElement.classList.remove('super-admin');
                document.querySelector('[data-tab="users"]').style.display = 'none';
            }

            this.setupClinicFilterRestrictions();
        }

        setupClinicFilterRestrictions() {
            const clinicFilter = document.getElementById('clinicFilter');
            const newUserClinic = document.getElementById('newUserClinic');
            
            if (this.currentUser.role === 'admin') {
                clinicFilter.value = this.currentUser.assigned_clinic;
                clinicFilter.disabled = true;
                
                if (newUserClinic) {
                    newUserClinic.value = this.currentUser.assigned_clinic;
                    newUserClinic.disabled = true;
                }
            } else {
                clinicFilter.disabled = false;
                if (newUserClinic) {
                    newUserClinic.disabled = false;
                }
            }
        }

        switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');

            // Load tab-specific data
            this.loadTabData(tabName);
        }

        async loadTabData(tabName) {
            switch (tabName) {
                case 'overview':
                    await this.loadOverviewData();
                    break;
                case 'surveys':
                    await this.loadSurveysData();
                    break;
                case 'analytics':
                    await this.loadAnalyticsData();
                    break;
                case 'follow-ups':
                    await this.loadFollowUpsData();
                    break;
                case 'users':
                    await this.loadUsersData();
                    break;
            }
        }

        loadDashboardData() {
            this.loadOverviewData();
        }

        async loadOverviewData() {
            try {
                const today = new Date().toISOString().split('T')[0];
                let baseQuery = supabase.from('surveys').select('*');

                // Apply clinic filter for non-super admins
                if (this.currentUser?.role === 'admin' && this.currentUser?.assigned_clinic) {
                    baseQuery = baseQuery.eq('clinic_location', this.currentUser.assigned_clinic);
                }

                // Get today's surveys
                const { data: todaySurveys, error: todayError } = await baseQuery
                    .gte('created_at', today + 'T00:00:00')
                    .lte('created_at', today + 'T23:59:59');

                if (todayError) throw todayError;

                // Get all surveys for calculations
                let allQuery = supabase.from('surveys').select('*');
                if (this.currentUser?.role === 'admin' && this.currentUser?.assigned_clinic) {
                    allQuery = allQuery.eq('clinic_location', this.currentUser.assigned_clinic);
                }
                
                const { data: allSurveys, error: allError } = await allQuery;
                if (allError) throw allError;

                // Calculate statistics
                const totalToday = todaySurveys?.length || 0;
                
                // Calculate average satisfaction
                const avgSatisfaction = allSurveys?.length > 0 
                    ? (allSurveys.reduce((sum, s) => sum + (satisfactionScales.overall[s.overall_satisfaction] || 3), 0) / allSurveys.length).toFixed(1)
                    : '0.0';

                // Count pending follow-ups
                let followUpQuery = supabase
                    .from('follow_ups')
                    .select('*', { count: 'exact', head: true })
                    .eq('status', 'pending');
                    
                if (this.currentUser?.role === 'admin' && this.currentUser?.assigned_clinic) {
                    followUpQuery = followUpQuery.eq('clinic_location', this.currentUser.assigned_clinic);
                }
                
                const { count: pendingCount } = await followUpQuery;

                // Count dissatisfied patients
                const dissatisfiedCount = allSurveys?.filter(s => s.overall_satisfaction === 'dissatisfied').length || 0;

                // Update UI
                document.getElementById('totalSurveys').textContent = totalToday;
                document.getElementById('avgSatisfaction').textContent = avgSatisfaction;
                document.getElementById('pendingFollowUps').textContent = pendingCount || 0;
                document.getElementById('dissatisfiedCount').textContent = dissatisfiedCount;

                // Update trends - Fix the selectors
                const statCards = document.querySelectorAll('.stat-card');
                
                // Update Total Surveys trend
                if (statCards[0]) {
                    const trendEl = statCards[0].querySelector('.trend');
                    if (trendEl) {
                        trendEl.textContent = totalToday > 0 ? '↑ Active today' : 'No surveys yet today';
                        trendEl.className = totalToday > 0 ? 'trend up' : 'trend';
                    }
                }
                
                // Update Average Satisfaction trend
                if (statCards[1]) {
                    const trendEl = statCards[1].querySelector('.trend');
                    if (trendEl) {
                        const avgNum = parseFloat(avgSatisfaction);
                        trendEl.textContent = avgNum >= 4 ? '↑ Excellent' : avgNum >= 3 ? '→ Good' : '↓ Needs attention';
                        trendEl.className = avgNum >= 4 ? 'trend up' : avgNum >= 3 ? 'trend' : 'trend down';
                    }
                }
                
                // Update Pending Follow-ups trend
                if (statCards[2]) {
                    const trendEl = statCards[2].querySelector('.trend');
                    if (trendEl) {
                        trendEl.textContent = pendingCount > 0 ? '⚠ Need attention' : '✓ All clear';
                        trendEl.className = pendingCount > 0 ? 'trend down' : 'trend up';
                    }
                }
                
                // Update Dissatisfied Patients trend
                if (statCards[3]) {
                    const trendEl = statCards[3].querySelector('.trend');
                    if (trendEl) {
                        trendEl.textContent = dissatisfiedCount > 0 ? '↓ Require follow-up' : '✓ Great job!';
                        trendEl.className = dissatisfiedCount > 0 ? 'trend down' : 'trend up';
                    }
                }
                
                // Load recent surveys table
                await this.loadRecentSurveys();
                
            } catch (error) {
                console.error('Failed to load overview data:', error);
                // Show zeros on error
                document.getElementById('totalSurveys').textContent = '0';
                document.getElementById('avgSatisfaction').textContent = '0.0';
                document.getElementById('pendingFollowUps').textContent = '0';
                document.getElementById('dissatisfiedCount').textContent = '0';
                
                // Update trends to show error state
                document.querySelectorAll('.stat-card .trend').forEach(el => {
                    el.textContent = 'Error loading data';
                    el.className = 'trend';
                });
            }
        }
        async loadRecentSurveys() {
            try {
                let query = supabase
                    .from('surveys')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(10);

                // Apply clinic filter for non-super admins
                if (this.currentUser?.role === 'admin' && this.currentUser?.assigned_clinic) {
                    query = query.eq('clinic_location', this.currentUser.assigned_clinic);
                }

                const { data, error } = await query;
                if (error) throw error;

                const tableBody = document.getElementById('recentSurveysTable');
                
                if (!data || data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #64748b;">No recent surveys found</td></tr>';
                    return;
                }

                tableBody.innerHTML = data.map(survey => `
                    <tr>
                        <td>${survey.patient_name}</td>
                        <td>
                            ${survey.patient_email}<br>
                            <small style="color: #64748b;">${survey.patient_phone || 'No phone'}</small>
                        </td>
                        <td>${clinicMap[survey.clinic_location] || survey.clinic_location}</td>
                        <td>
                            <span class="status-badge status-${survey.overall_satisfaction === 'very_satisfied' ? 'high' : 
                                survey.overall_satisfaction === 'satisfied' ? 'medium' : 'low'}">
                                ${formatSatisfaction(survey.overall_satisfaction)}
                            </span>
                        </td>
                        <td>${new Date(survey.visit_date).toLocaleDateString()}</td>
                        <td>${new Date(survey.created_at).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="viewSurvey('${survey.id}')">View</button>
                        </td>
                    </tr>
                `).join('');
                
            } catch (error) {
                console.error('Failed to load recent surveys:', error);
                const tableBody = document.getElementById('recentSurveysTable');
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #dc2626;">Error loading surveys</td></tr>';
            }
        }

        async loadSurveysData() {
            try {
                // Get filter values
                const clinicFilter = document.getElementById('clinicFilter').value;
                const dateRangeFilter = document.getElementById('dateRangeFilter').value;
                const satisfactionFilter = document.getElementById('satisfactionFilter').value;
                const searchFilter = document.getElementById('searchFilter').value.toLowerCase().trim();

                let query = supabase.from('surveys').select('*');

                // Apply clinic filter
                if (clinicFilter) {
                    query = query.eq('clinic_location', clinicFilter);
                } else if (this.currentUser?.role === 'admin' && this.currentUser?.assigned_clinic) {
                    query = query.eq('clinic_location', this.currentUser.assigned_clinic);
                }

                // Apply date range filter
                const now = new Date();
                switch (dateRangeFilter) {
                    case 'today':
                        const today = new Date().toISOString().split('T')[0];
                        query = query.gte('created_at', today + 'T00:00:00');
                        break;
                    case 'week':
                        const weekAgo = new Date(now.setDate(now.getDate() - 7)).toISOString();
                        query = query.gte('created_at', weekAgo);
                        break;
                    case 'month':
                        const monthAgo = new Date(now.setMonth(now.getMonth() - 1)).toISOString();
                        query = query.gte('created_at', monthAgo);
                        break;
                }

                // Apply satisfaction filter
                if (satisfactionFilter) {
                    query = query.eq('overall_satisfaction', satisfactionFilter);
                }

                // Apply search filter using Supabase's OR and ilike
                if (searchFilter) {
                    query = query.or(`patient_name.ilike.%${searchFilter}%,patient_email.ilike.%${searchFilter}%,patient_phone.ilike.%${searchFilter}%`);
                }

                // Apply sorting
                query = query.order('created_at', { ascending: false });

                const { data, error } = await query;
                if (error) throw error;

                const tableBody = document.getElementById('allSurveysTable');
                
                if (!data || data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #64748b;">No surveys found</td></tr>';
                    return;
                }

                tableBody.innerHTML = data.map(survey => `
                    <tr>
                        <td>${survey.id.substring(0, 8)}...</td>
                        <td>${survey.patient_name}</td>
                        <td>
                            ${survey.patient_email}<br>
                            <small style="color: #64748b;">${survey.patient_phone || 'No phone'}</small>
                        </td>
                        <td>${clinicMap[survey.clinic_location] || survey.clinic_location}</td>
                        <td>
                            <span class="status-badge status-${survey.overall_satisfaction === 'very_satisfied' ? 'high' : 
                                survey.overall_satisfaction === 'satisfied' ? 'medium' : 'low'}">
                                ${formatSatisfaction(survey.overall_satisfaction)}
                            </span>
                        </td>
                        <td>${new Date(survey.visit_date).toLocaleDateString()}</td>
                        <td>
                            <span class="status-badge status-${survey.want_contact === 'yes' ? 'pending' : 'completed'}">
                                ${survey.want_contact === 'yes' ? 'Requested' : 'Not Requested'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="viewSurvey('${survey.id}')">View</button>
                        </td>
                    </tr>
                `).join('');
                
            } catch (error) {
                console.error('Failed to load surveys:', error);
                const tableBody = document.getElementById('allSurveysTable');
                tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #dc2626;">Error loading surveys</td></tr>';
            }
        }
        async loadAnalyticsData() {
            try {
                let baseQuery = supabase.from('surveys').select('*');

                // Apply clinic filter for non-super admins
                if (this.currentUser?.role === 'admin' && this.currentUser?.assigned_clinic) {
                    baseQuery = baseQuery.eq('clinic_location', this.currentUser.assigned_clinic);
                }

                // Get last 30 days of data
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

                const { data: surveys, error } = await baseQuery
                    .gte('created_at', thirtyDaysAgo.toISOString());

                if (error) throw error;

                // Calculate metrics
                const totalResponses = surveys?.length || 0;
                
                const avgOverall = totalResponses > 0
                    ? (surveys.reduce((sum, s) => sum + (satisfactionScales.overall[s.overall_satisfaction] || 3), 0) / totalResponses).toFixed(1)
                    : '0.0';

                const satisfiedCount = surveys?.filter(s => 
                    s.overall_satisfaction === 'satisfied' || s.overall_satisfaction === 'very_satisfied'
                ).length || 0;

                const satisfactionRate = totalResponses > 0
                    ? Math.round((satisfiedCount / totalResponses) * 100)
                    : 0;

                const followUpRequests = surveys?.filter(s => s.want_contact === 'yes').length || 0;
                const followUpRate = totalResponses > 0
                    ? Math.round((followUpRequests / totalResponses) * 100)
                    : 0;

                // Update metrics
                document.getElementById('totalResponsesMetric').textContent = totalResponses;
                document.getElementById('avgOverallMetric').textContent = avgOverall;
                document.getElementById('satisfactionRateMetric').textContent = `${satisfactionRate}%`;
                document.getElementById('responseRateMetric').textContent = `${followUpRate}%`;

                // Create charts
                this.createCharts(surveys || []);
                
            } catch (error) {
                console.error('Failed to load analytics:', error);
                // Show default values on error
                document.getElementById('totalResponsesMetric').textContent = '0';
                document.getElementById('avgOverallMetric').textContent = '0.0';
                document.getElementById('satisfactionRateMetric').textContent = '0%';
                document.getElementById('responseRateMetric').textContent = '0%';
            }
        }

        createCharts(surveys) {
            // Destroy existing charts
            Object.values(this.charts).forEach(chart => chart?.destroy());
            this.charts = {};

            if (!surveys || surveys.length === 0) {
                this.createEmptyCharts();
                return;
            }

            // Satisfaction Trends (Last 7 Days)
            const last7Days = {};
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateKey = date.toLocaleDateString();
                last7Days[dateKey] = [];
            }

            surveys.forEach(survey => {
                const dateKey = new Date(survey.created_at).toLocaleDateString();
                if (last7Days[dateKey]) {
                    last7Days[dateKey].push(survey);
                }
            });

            const ctx1 = document.getElementById('satisfactionChart');
            if (ctx1) {
                this.charts.satisfaction = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: Object.keys(last7Days),
                        datasets: [{
                            label: 'Average Satisfaction',
                            data: Object.values(last7Days).map(daySurveys => {
                                if (daySurveys.length === 0) return 0;
                                const sum = daySurveys.reduce((acc, s) => 
                                    acc + (satisfactionScales.overall[s.overall_satisfaction] || 3), 0
                                );
                                return (sum / daySurveys.length).toFixed(1);
                            }),
                            borderColor: '#2c5aa0',
                            backgroundColor: 'rgba(44, 90, 160, 0.1)',
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 5
                            }
                        }
                    }
                });
            }

            // Clinic Performance
            const clinicStats = {};
            surveys.forEach(survey => {
                const clinic = clinicMap[survey.clinic_location] || survey.clinic_location;
                if (!clinicStats[clinic]) {
                    clinicStats[clinic] = { total: 0, satisfied: 0 };
                }
                clinicStats[clinic].total++;
                if (survey.overall_satisfaction === 'satisfied' || survey.overall_satisfaction === 'very_satisfied') {
                    clinicStats[clinic].satisfied++;
                }
            });

            const ctx2 = document.getElementById('clinicChart');
            if (ctx2) {
                this.charts.clinic = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(clinicStats),
                        datasets: [{
                            label: 'Satisfaction Rate (%)',
                            data: Object.values(clinicStats).map(stats => 
                                Math.round((stats.satisfied / stats.total) * 100)
                            ),
                            backgroundColor: '#10b981'
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
            }

            // Overall Rating Distribution
            const ratingCounts = {
                'Very Satisfied': surveys.filter(s => s.overall_satisfaction === 'very_satisfied').length,
                'Satisfied': surveys.filter(s => s.overall_satisfaction === 'satisfied').length,
                'Dissatisfied': surveys.filter(s => s.overall_satisfaction === 'dissatisfied').length
            };

            const ctx4 = document.getElementById('ratingChart');
            if (ctx4) {
                this.charts.rating = new Chart(ctx4, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(ratingCounts),
                        datasets: [{
                            data: Object.values(ratingCounts),
                            backgroundColor: ['#10b981', '#f59e0b', '#ef4444']
                        }]
                    },
                    options: {
                        responsive: true
                    }
                });
            }

            // Create remaining empty charts for now
            ['departmentChart', 'visitTypeChart', 'serviceQualityChart', 
             'recommendationChart', 'followupBySatisfactionChart'].forEach(chartId => {
                const ctx = document.getElementById(chartId);
                if (ctx && !this.charts[chartId]) {
                    this.charts[chartId] = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['No Data'],
                            datasets: [{
                                label: 'Coming Soon',
                                data: [0],
                                backgroundColor: '#e5e7eb'
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });
                }
            });
        }

        createEmptyCharts() {
            const chartIds = [
                'satisfactionChart',
                'clinicChart', 
                'departmentChart',
                'ratingChart',
                'visitTypeChart',
                'serviceQualityChart',
                'recommendationChart',
                'followupBySatisfactionChart'
            ];

            chartIds.forEach(chartId => {
                const ctx = document.getElementById(chartId);
                if (ctx) {
                    this.charts[chartId] = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['No Data'],
                            datasets: [{
                                label: 'No Data Available',
                                data: [0],
                                backgroundColor: '#e5e7eb'
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });
                }
            });
        }

        async loadFollowUpsData() {
            try {
                let query = supabase
                    .from('follow_ups')
                    .select(`
                        *,
                        surveys!inner(
                            overall_satisfaction
                        )
                    `)
                    .order('created_at', { ascending: false });

                // Apply clinic filter
                if (this.currentUser?.role === 'admin' && this.currentUser?.assigned_clinic) {
                    query = query.eq('clinic_location', this.currentUser.assigned_clinic);
                }

                const { data, error } = await query;
                if (error) throw error;

                const tableBody = document.getElementById('followUpsTable');
                
                if (!data || data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #64748b;">No follow-up tasks</td></tr>';
                    return;
                }

                tableBody.innerHTML = data.map(followUp => `
                    <tr>
                        <td>${followUp.patient_name}</td>
                        <td>
                            ${followUp.patient_email}<br>
                            <small style="color: #64748b;">${followUp.patient_phone || 'No phone'}</small>
                        </td>
                        <td>${followUp.contact_preference?.join(', ') || 'Any'}</td>
                        <td>${clinicMap[followUp.clinic_location] || followUp.clinic_location}</td>
                        <td>
                            <span class="status-badge status-${followUp.priority}">
                                ${followUp.priority.toUpperCase()}
                            </span>
                        </td>
                        <td>
                            <span class="status-badge status-${followUp.status === 'pending' ? 'pending' : 'completed'}">
                                ${followUp.status.toUpperCase()}
                            </span>
                        </td>
                        <td>
                            <span class="status-badge status-${followUp.surveys?.overall_satisfaction === 'very_satisfied' ? 'high' : 
                                followUp.surveys?.overall_satisfaction === 'satisfied' ? 'medium' : 'low'}">
                                ${formatSatisfaction(followUp.surveys?.overall_satisfaction || 'Unknown')}
                            </span>
                        </td>
                        <td>${new Date(followUp.created_at).toLocaleString()}</td>
                        <td>
                            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                <button class="btn btn-sm btn-primary" onclick="viewSurvey('${followUp.survey_id}')">View Survey</button>
                                ${followUp.status === 'pending' ? 
                                    `<button class="btn btn-sm btn-success" onclick="completeFollowUp('${followUp.id}')">Complete</button>` :
                                    '<span style="color: #10b981; align-self: center;">✓ Done</span>'
                                }
                            </div>
                        </td>
                    </tr>
                `).join('');
                
            } catch (error) {
                console.error('Failed to load follow-ups:', error);
                const tableBody = document.getElementById('followUpsTable');
                tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #dc2626;">Error loading follow-ups</td></tr>';
            }
        }
        async loadUsersData() {
            try {
                if (this.currentUser?.role !== 'super_admin') {
                    document.getElementById('usersTable').innerHTML = 
                        '<tr><td colspan="7" style="text-align: center; color: #dc2626;">Unauthorized</td></tr>';
                    return;
                }

                const { data, error } = await supabase
                    .from('admin_users')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const tableBody = document.getElementById('usersTable');
                
                if (!data || data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #64748b;">No users found</td></tr>';
                    return;
                }

                tableBody.innerHTML = data.map(user => `
                    <tr>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>
                            <span class="role-badge ${user.role === 'super_admin' ? 'super-admin' : ''}">
                                ${user.role === 'super_admin' ? 'Super Admin' : 'Admin'}
                            </span>
                        </td>
                        <td>${user.assigned_clinic ? clinicMap[user.assigned_clinic] : 'All Clinics'}</td>
                        <td>
                            <span class="status-badge status-${user.status === 'active' ? 'active' : 'inactive'}">
                                ${user.status.toUpperCase()}
                            </span>
                        </td>
                        <td>${new Date(user.created_at).toLocaleDateString()}</td>
                        <td>
                            ${user.id !== this.currentUser.id && user.role !== 'super_admin' ? 
                                `<button class="btn btn-sm btn-danger" onclick="deleteUser('${user.id}')">Delete</button>` :
                                '-'
                            }
                        </td>
                    </tr>
                `).join('');
                
            } catch (error) {
                console.error('Failed to load users:', error);
                const tableBody = document.getElementById('usersTable');
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #dc2626;">Error loading users</td></tr>';
            }
        }

        handleSort(header) {
            // Implementation remains the same
            const column = header.dataset.sort;
            const table = header.closest('table');
            const tableId = table.querySelector('tbody').id;
            
            let sortKey = '';
            if (tableId === 'recentSurveysTable') sortKey = 'recent';
            else if (tableId === 'allSurveysTable') sortKey = 'surveys';
            else if (tableId === 'followUpsTable') sortKey = 'followups';
            else if (tableId === 'usersTable') sortKey = 'users';
            
            if (this.sortState[sortKey].column === column) {
                this.sortState[sortKey].direction = 
                    this.sortState[sortKey].direction === 'asc' ? 'desc' : 'asc';
            } else {
                this.sortState[sortKey].column = column;
                this.sortState[sortKey].direction = 'desc';
            }
            
            table.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            
            header.classList.add(this.sortState[sortKey].direction === 'asc' ? 'sort-asc' : 'sort-desc');
            
            switch (sortKey) {
                case 'recent':
                    this.loadRecentSurveys();
                    break;
                case 'surveys':
                    this.loadSurveysData();
                    break;
                case 'followups':
                    this.loadFollowUpsData();
                    break;
                case 'users':
                    this.loadUsersData();
                    break;
            }
        }

        showError(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 3000);
        }

        refreshData() {
            this.loadDashboardData();
            console.log('Data refreshed at', new Date().toLocaleTimeString());
        }

        // Add these calculation helper methods to your AdminDashboard class
calculateAverageOverallSatisfaction(surveys) {
    if (!surveys || surveys.length === 0) return '0.0';
    
    const total = surveys.reduce((sum, s) => sum + (satisfactionScales.overall[s.overall_satisfaction] || 3), 0);
    return (total / surveys.length).toFixed(1);
}

calculateAverageDetailedSatisfaction(surveys, field) {
    if (!surveys || surveys.length === 0) return 0;
    
    const total = surveys.reduce((sum, s) => sum + (satisfactionScales.detailed[s[field]] || 3), 0);
    return parseFloat((total / surveys.length).toFixed(1));
}

calculateAverageNursingProfessionalism(surveys) {
    if (!surveys || surveys.length === 0) return 0;
    
    const total = surveys.reduce((sum, s) => sum + (satisfactionScales.nursing[s.nursing_professionalism] || 2), 0);
    // Convert to 5-point scale for consistency
    return parseFloat(((total / surveys.length) * 5 / 4).toFixed(1));
}

calculateYesPercentage(surveys, field) {
    if (!surveys || surveys.length === 0) return 0;
    
    const yesCount = surveys.filter(s => s[field] === 'yes').length;
    return Math.round((yesCount / surveys.length) * 100);
}

// Update the loadAnalyticsData method
async loadAnalyticsData() {
    try {
        let baseQuery = supabase.from('surveys').select('*');

        // Apply clinic filter for non-super admins
        if (this.currentUser?.role === 'admin' && this.currentUser?.assigned_clinic) {
            baseQuery = baseQuery.eq('clinic_location', this.currentUser.assigned_clinic);
        }

        // Get last 30 days of data
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

        const { data: surveys, error } = await baseQuery
            .gte('created_at', thirtyDaysAgo.toISOString());

        if (error) throw error;

        // Calculate metrics using proper methods
        const totalResponses = surveys?.length || 0;
        
        const avgOverall = this.calculateAverageOverallSatisfaction(surveys || []);

        const satisfiedCount = surveys?.filter(s => 
            s.overall_satisfaction === 'satisfied' || s.overall_satisfaction === 'very_satisfied'
        ).length || 0;

        const satisfactionRate = totalResponses > 0
            ? Math.round((satisfiedCount / totalResponses) * 100)
            : 0;

        const followUpRequests = surveys?.filter(s => s.want_contact === 'yes').length || 0;
        const followUpRate = totalResponses > 0
            ? Math.round((followUpRequests / totalResponses) * 100)
            : 0;

        // Update metrics
        document.getElementById('totalResponsesMetric').textContent = totalResponses;
        document.getElementById('avgOverallMetric').textContent = avgOverall;
        document.getElementById('satisfactionRateMetric').textContent = `${satisfactionRate}%`;
        document.getElementById('responseRateMetric').textContent = `${followUpRate}%`;

        // Create all charts
        this.createAllCharts(surveys || []);
        
    } catch (error) {
        console.error('Failed to load analytics:', error);
        // Show default values on error
        document.getElementById('totalResponsesMetric').textContent = '0';
        document.getElementById('avgOverallMetric').textContent = '0.0';
        document.getElementById('satisfactionRateMetric').textContent = '0%';
        document.getElementById('responseRateMetric').textContent = '0%';
        this.createEmptyCharts();
    }
}

// Create all charts with proper data
createAllCharts(surveys) {
    // Destroy existing charts
    Object.values(this.charts).forEach(chart => chart?.destroy());
    this.charts = {};

    if (!surveys || surveys.length === 0) {
        this.createEmptyCharts();
        return;
    }

    // Create each chart
    this.createSatisfactionTrendChart(surveys);
    this.createClinicPerformanceChart(surveys);
    this.createDepartmentChart(surveys);
    this.createRatingDistributionChart(surveys);
    this.createVisitTypeChart(surveys);
    this.createServiceQualityChart(surveys);
    this.createRecommendationChart(surveys);
    this.createFollowupBySatisfactionChart(surveys);
}

createSatisfactionTrendChart(surveys) {
    const ctx = document.getElementById('satisfactionChart');
    if (!ctx) return;

    // Get last 7 days data
    const last7Days = [];
    const labels = [];
    
    for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        labels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
        
        const daySurveys = surveys.filter(s => s.created_at.split('T')[0] === dateStr);
        const avgSatisfaction = this.calculateAverageOverallSatisfaction(daySurveys);
        last7Days.push(parseFloat(avgSatisfaction));
    }

    this.charts.satisfaction = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Average Satisfaction',
                data: last7Days,
                borderColor: '#2c5aa0',
                backgroundColor: 'rgba(44, 90, 160, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 5,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

createClinicPerformanceChart(surveys) {
    const ctx = document.getElementById('clinicChart');
    if (!ctx) return;

    // Calculate average satisfaction by clinic
    const clinicData = {};
    Object.keys(clinicMap).forEach(clinicId => {
        if (clinicId !== 'other') {
            const clinicSurveys = surveys.filter(s => s.clinic_location === clinicId);
            if (clinicSurveys.length > 0) {
                const clinicName = clinicMap[clinicId];
                clinicData[clinicName] = parseFloat(this.calculateAverageOverallSatisfaction(clinicSurveys));
            }
        }
    });

    this.charts.clinic = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(clinicData),
            datasets: [{
                label: 'Average Rating',
                data: Object.values(clinicData),
                backgroundColor: ['#10b981', '#f59e0b', '#3b82f6', '#ef4444', '#8b5cf6']
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 5,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

createDepartmentChart(surveys) {
    const ctx = document.getElementById('departmentChart');
    if (!ctx) return;

    // Calculate aspect ratings with correct field mapping
    const aspectData = {
        'Reception': this.calculateAverageDetailedSatisfaction(surveys, 'reception_satisfaction'),
        'Nursing': this.calculateAverageNursingProfessionalism(surveys),
        'Doctor': this.calculateAverageDetailedSatisfaction(surveys, 'doctor_satisfaction'),
        'Cleanliness': this.calculateAverageDetailedSatisfaction(surveys, 'clinic_cleanliness')
    };

    this.charts.department = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: Object.keys(aspectData),
            datasets: [{
                label: 'Average Rating',
                data: Object.values(aspectData),
                borderColor: '#2c5aa0',
                backgroundColor: 'rgba(44, 90, 160, 0.2)',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            scales: {
                r: {
                    beginAtZero: true,
                    max: 5,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

createRatingDistributionChart(surveys) {
    const ctx = document.getElementById('ratingChart');
    if (!ctx) return;

    // Only show the 3 options that exist in the survey
    const distribution = {
        'Dissatisfied': surveys.filter(s => s.overall_satisfaction === 'dissatisfied').length,
        'Satisfied': surveys.filter(s => s.overall_satisfaction === 'satisfied').length,
        'Very Satisfied': surveys.filter(s => s.overall_satisfaction === 'very_satisfied').length
    };

    this.charts.rating = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(distribution),
            datasets: [{
                data: Object.values(distribution),
                backgroundColor: ['#ef4444', '#3b82f6', '#10b981']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

createVisitTypeChart(surveys) {
    const ctx = document.getElementById('visitTypeChart');
    if (!ctx) return;

    const visitTypes = {
        'First Visit': surveys.filter(s => s.visit_type === 'first_visit').length,
        'Follow Up': surveys.filter(s => s.visit_type === 'follow_up').length
    };

    this.charts.visitType = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: Object.keys(visitTypes),
            datasets: [{
                data: Object.values(visitTypes),
                backgroundColor: ['#8b5cf6', '#06b6d4']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

createServiceQualityChart(surveys) {
    const ctx = document.getElementById('serviceQualityChart');
    if (!ctx) return;

    const metrics = {
        'Registration Smooth': this.calculateYesPercentage(surveys, 'registration_smooth'),
        'Nursing Prompt': this.calculateYesPercentage(surveys, 'nursing_prompt'),
        'Doctor Listening': this.calculateYesPercentage(surveys, 'doctor_listening'),
        'Clear Explanation': this.calculateYesPercentage(surveys, 'doctor_explanation'),
        'Acceptable Wait Time': this.calculateYesPercentage(surveys, 'waiting_time_acceptable')
    };

    this.charts.serviceQuality = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(metrics),
            datasets: [{
                label: 'Yes (%)',
                data: Object.values(metrics),
                backgroundColor: '#10b981'
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.parsed.y + '%';
                        }
                    }
                }
            }
        }
    });
}

createRecommendationChart(surveys) {
    const ctx = document.getElementById('recommendationChart');
    if (!ctx) return;

    const recommendations = {
        'Very Unlikely': surveys.filter(s => s.recommendation_likelihood === 'very_unlikely').length,
        'Unlikely': surveys.filter(s => s.recommendation_likelihood === 'unlikely').length,
        'Neutral': surveys.filter(s => s.recommendation_likelihood === 'neutral').length,
        'Likely': surveys.filter(s => s.recommendation_likelihood === 'likely').length,
        'Very Likely': surveys.filter(s => s.recommendation_likelihood === 'very_likely').length
    };

    this.charts.recommendation = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(recommendations),
            datasets: [{
                label: 'Count',
                data: Object.values(recommendations),
                backgroundColor: ['#991b1b', '#ef4444', '#f59e0b', '#3b82f6', '#10b981']
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

createFollowupBySatisfactionChart(surveys) {
    const ctx = document.getElementById('followupBySatisfactionChart');
    if (!ctx) return;

    const data = ['dissatisfied', 'satisfied', 'very_satisfied'].map(level => {
        const levelSurveys = surveys.filter(s => s.overall_satisfaction === level);
        const followupRequests = levelSurveys.filter(s => s.want_contact === 'yes').length;
        return levelSurveys.length > 0 ? Math.round((followupRequests / levelSurveys.length) * 100) : 0;
    });

    this.charts.followupBySatisfaction = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Dissatisfied', 'Satisfied', 'Very Satisfied'],
            datasets: [{
                label: 'Follow-up Request Rate (%)',
                data: data,
                backgroundColor: ['#ef4444', '#3b82f6', '#10b981']
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.parsed.y + '%';
                        }
                    }
                }
            }
        }
    });
}
    }

    // Global functions
    let dashboardInstance;

    document.addEventListener('DOMContentLoaded', () => {
        // Check if Supabase is properly configured
        if (SUPABASE_URL === 'YOUR_SUPABASE_PROJECT_URL' || 
            SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
            alert('Please update Supabase configuration in the dashboard code!');
            return;
        }
        
        dashboardInstance = new AdminDashboard();
    });

    // Survey detail modal
    async function viewSurvey(surveyId) {
        try {
            const { data: survey, error } = await supabase
                .from('surveys')
                .select('*')
                .eq('id', surveyId)
                .single();

            if (error) throw error;

            const modalContent = document.getElementById('surveyDetails');
            modalContent.innerHTML = `
                <div class="survey-detail-container">
                    <div class="detail-section">
                        <h4 class="section-title">📋 Basic Information</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>Patient Name</label>
                                <span>${survey.patient_name}</span>
                            </div>
                            <div class="detail-item">
                                <label>Email</label>
                                <span>${survey.patient_email}</span>
                            </div>
                            <div class="detail-item">
                                <label>Phone</label>
                                <span>${survey.patient_phone || 'Not provided'}</span>
                            </div>
                            <div class="detail-item">
                                <label>Visit Date</label>
                                <span>${new Date(survey.visit_date).toLocaleDateString()}</span>
                            </div>
                            <div class="detail-item">
                                <label>Clinic</label>
                                <span>${clinicMap[survey.clinic_location] || survey.clinic_location}</span>
                            </div>
                            <div class="detail-item">
                                <label>Submitted At</label>
                                <span>${new Date(survey.created_at).toLocaleString()}</span>
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h4 class="section-title">⭐ Overall Experience</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>Overall Satisfaction</label>
                                <span>${formatSatisfaction(survey.overall_satisfaction)}</span>
                            </div>
                            <div class="detail-item">
                                <label>Visit Type</label>
                                <span>${survey.visit_type === 'first_visit' ? 'First Visit' : 'Follow Up'}</span>
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h4 class="section-title">🏢 Reception Staff</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>Satisfaction</label>
                                <span>${formatSatisfaction(survey.reception_satisfaction)}</span>
                            </div>
                            <div class="detail-item">
                                <label>Registration Smooth</label>
                                <span>${formatYesNo(survey.registration_smooth)}</span>
                            </div>
                            ${survey.reception_comments ? `
                            <div class="detail-item full-width">
                                <label>Comments</label>
                                <span>${survey.reception_comments}</span>
                            </div>` : ''}
                        </div>
                    </div>

                    <div class="detail-section">
                        <h4 class="section-title">👩‍⚕️ Nursing Staff</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>Professionalism</label>
                                <span>${formatProfessionalism(survey.nursing_professionalism)}</span>
                            </div>
                            <div class="detail-item">
                                <label>Prompt Service</label>
                                <span>${formatYesNo(survey.nursing_prompt)}</span>
                            </div>
                            ${survey.nursing_comments ? `
                            <div class="detail-item full-width">
                                <label>Comments</label>
                                <span>${survey.nursing_comments}</span>
                            </div>` : ''}
                        </div>
                    </div>

                    <div class="detail-section">
                        <h4 class="section-title">👨‍⚕️ Doctor Consultation</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>Satisfaction</label>
                                <span>${formatSatisfaction(survey.doctor_satisfaction)}</span>
                            </div>
                            <div class="detail-item">
                                <label>Listened to Concerns</label>
                                <span>${formatYesNo(survey.doctor_listening)}</span>
                            </div>
                            <div class="detail-item">
                                <label>Clear Explanation</label>
                                <span>${formatYesNo(survey.doctor_explanation)}</span>
                            </div>
                            ${survey.doctor_comments ? `
                            <div class="detail-item full-width">
                                <label>Comments</label>
                                <span>${survey.doctor_comments}</span>
                            </div>` : ''}
                        </div>
                    </div>

                    <div class="detail-section">
                        <h4 class="section-title">🏥 Clinic Environment</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>Cleanliness</label>
                                <span>${formatSatisfaction(survey.clinic_cleanliness)}</span>
                            </div>
                            <div class="detail-item">
                                <label>Waiting Time Acceptable</label>
                                <span>${formatYesNo(survey.waiting_time_acceptable)}</span>
                            </div>
                            ${survey.environment_comments ? `
                            <div class="detail-item full-width">
                                <label>Comments</label>
                                <span>${survey.environment_comments}</span>
                            </div>` : ''}
                        </div>
                    </div>

                    ${survey.liked_most || survey.areas_improve ? `
                    <div class="detail-section">
                        <h4 class="section-title">📝 Additional Feedback</h4>
                        <div class="detail-grid">
                            ${survey.liked_most ? `
                            <div class="detail-item full-width">
                                <label>What they liked most</label>
                                <span>${survey.liked_most}</span>
                            </div>` : ''}
                            ${survey.areas_improve ? `
                            <div class="detail-item full-width">
                                <label>Areas to improve</label>
                                <span>${survey.areas_improve}</span>
                            </div>` : ''}
                        </div>
                    </div>` : ''}

                    <div class="detail-section">
                        <h4 class="section-title">👥 Recommendation</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>Likelihood to Recommend</label>
                                <span>${formatRecommendation(survey.recommendation_likelihood)}</span>
                            </div>
                            ${survey.recommendation_comments ? `
                            <div class="detail-item full-width">
                                <label>Comments</label>
                                <span>${survey.recommendation_comments}</span>
                            </div>` : ''}
                        </div>
                    </div>

                    <div class="detail-section">
                        <h4 class="section-title">📞 Contact Preferences</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>Want Contact</label>
                                <span>${formatYesNo(survey.want_contact)}</span>
                            </div>
                            ${survey.want_contact === 'yes' ? `
                            <div class="detail-item">
                                <label>Preferred Contact Method</label>
                                <span>${survey.contact_preference?.join(', ') || 'Any'}</span>
                            </div>` : ''}
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('surveyModal').style.display = 'block';
            
        } catch (error) {
            console.error('Error viewing survey:', error);
            alert('Error loading survey details');
        }
    }

    function closeSurveyModal() {
        document.getElementById('surveyModal').style.display = 'none';
    }

    function refreshData() {
        dashboardInstance?.refreshData();
    }

    function loadSurveysData() {
        dashboardInstance?.loadSurveysData();
    }

    function loadFollowUpsData() {
        dashboardInstance?.loadFollowUpsData();
    }

    function loadUsersData() {
        dashboardInstance?.loadUsersData();
    }

    function applyFilters() {
        dashboardInstance?.loadSurveysData();
    }

    async function completeFollowUp(followUpId) {
        try {
            const { error } = await supabase
                .from('follow_ups')
                .update({ 
                    status: 'completed',
                    completed_at: new Date().toISOString()
                })
                .eq('id', followUpId);

            if (error) throw error;
            
            dashboardInstance?.loadFollowUpsData();
            alert('Follow-up marked as completed!');
            
        } catch (error) {
            console.error('Error completing follow-up:', error);
            alert('Failed to complete follow-up');
        }
    }

    async function deleteUser(userId) {
        if (confirm('Are you sure you want to delete this user?')) {
            try {
                const { error } = await supabase
                    .from('admin_users')
                    .update({ status: 'inactive' })
                    .eq('id', userId);

                if (error) throw error;
                
                dashboardInstance?.loadUsersData();
                alert('User deactivated successfully!');
                
            } catch (error) {
                console.error('Error deleting user:', error);
                alert('Failed to delete user');
            }
        }
    }

   async function exportData(format) {
    try {
        // Show loading
        const loadingEl = document.createElement('div');
        loadingEl.className = 'loading show';
        loadingEl.innerHTML = '<div class="spinner"></div>';
        document.body.appendChild(loadingEl);

        // Get filter values
        const clinicFilter = document.getElementById('clinicFilter').value;
        const dateRangeFilter = document.getElementById('dateRangeFilter').value;
        const satisfactionFilter = document.getElementById('satisfactionFilter').value;
        const searchFilter = document.getElementById('searchFilter')?.value.toLowerCase().trim() || '';

        let query = supabase.from('surveys').select('*');

        // Apply clinic filter
        if (clinicFilter) {
            query = query.eq('clinic_location', clinicFilter);
        } else if (dashboardInstance?.currentUser?.role === 'admin' && dashboardInstance?.currentUser?.assigned_clinic) {
            query = query.eq('clinic_location', dashboardInstance.currentUser.assigned_clinic);
        }

        // Apply date range filter
        const now = new Date();
        switch (dateRangeFilter) {
            case 'today':
                const today = new Date().toISOString().split('T')[0];
                query = query.gte('created_at', today + 'T00:00:00');
                break;
            case 'week':
                const weekAgo = new Date(now.setDate(now.getDate() - 7)).toISOString();
                query = query.gte('created_at', weekAgo);
                break;
            case 'month':
                const monthAgo = new Date(now.setMonth(now.getMonth() - 1)).toISOString();
                query = query.gte('created_at', monthAgo);
                break;
        }

        // Apply satisfaction filter
        if (satisfactionFilter) {
            query = query.eq('overall_satisfaction', satisfactionFilter);
        }

        // Apply search filter
        if (searchFilter) {
            query = query.or(`patient_name.ilike.%${searchFilter}%,patient_email.ilike.%${searchFilter}%,patient_phone.ilike.%${searchFilter}%`);
        }

        // Apply sorting
        query = query.order('created_at', { ascending: false });

        const { data, error } = await query;
        if (error) throw error;

        if (!data || data.length === 0) {
            alert('No data to export');
            document.body.removeChild(loadingEl);
            return;
        }

        if (format === 'excel') {
            exportToExcel(data);
        } else if (format === 'pdf') {
            exportToPDF(data);
        }

        // Remove loading
        document.body.removeChild(loadingEl);

    } catch (error) {
        console.error('Export error:', error);
        alert('Failed to export data: ' + error.message);
        const loadingEl = document.querySelector('.loading.show');
        if (loadingEl) document.body.removeChild(loadingEl);
    }
}

function exportToExcel(data) {
    try {
        // Prepare data for Excel
        const excelData = data.map(survey => ({
            'Survey ID': survey.id,
            'Patient Name': survey.patient_name,
            'Email': survey.patient_email,
            'Phone': survey.patient_phone || 'N/A',
            'Visit Date': new Date(survey.visit_date).toLocaleDateString(),
            'Clinic': clinicMap[survey.clinic_location] || survey.clinic_location,
            'Overall Satisfaction': formatSatisfaction(survey.overall_satisfaction),
            'Visit Type': survey.visit_type === 'first_visit' ? 'First Visit' : 'Follow Up',
            'Reception Satisfaction': formatSatisfaction(survey.reception_satisfaction),
            'Registration Smooth': formatYesNo(survey.registration_smooth),
            'Reception Comments': survey.reception_comments || '',
            'Nursing Professionalism': formatProfessionalism(survey.nursing_professionalism),
            'Nursing Prompt': formatYesNo(survey.nursing_prompt),
            'Nursing Comments': survey.nursing_comments || '',
            'Doctor Satisfaction': formatSatisfaction(survey.doctor_satisfaction),
            'Doctor Listening': formatYesNo(survey.doctor_listening),
            'Doctor Explanation': formatYesNo(survey.doctor_explanation),
            'Doctor Comments': survey.doctor_comments || '',
            'Clinic Cleanliness': formatSatisfaction(survey.clinic_cleanliness),
            'Waiting Time Acceptable': formatYesNo(survey.waiting_time_acceptable),
            'Environment Comments': survey.environment_comments || '',
            'Liked Most': survey.liked_most || '',
            'Areas to Improve': survey.areas_improve || '',
            'Recommendation Likelihood': formatRecommendation(survey.recommendation_likelihood),
            'Recommendation Comments': survey.recommendation_comments || '',
            'Want Contact': formatYesNo(survey.want_contact),
            'Contact Preference': Array.isArray(survey.contact_preference) ? survey.contact_preference.join(', ') : '',
            'Submitted At': new Date(survey.created_at).toLocaleString()
        }));

        // Create workbook
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(excelData);

        // Auto-size columns
        const colWidths = [];
        Object.keys(excelData[0]).forEach((key, i) => {
            const maxLength = Math.max(
                key.length,
                ...excelData.map(row => String(row[key] || '').length)
            );
            colWidths[i] = { wch: Math.min(maxLength + 2, 50) };
        });
        ws['!cols'] = colWidths;

        // Add worksheet to workbook
        XLSX.utils.book_append_sheet(wb, ws, 'Survey Responses');

        // Generate filename with date
        const filename = `survey_responses_${new Date().toISOString().split('T')[0]}.xlsx`;

        // Save file
        XLSX.writeFile(wb, filename);

        console.log(`Exported ${data.length} surveys to Excel`);

    } catch (error) {
        console.error('Excel export error:', error);
        alert('Failed to export to Excel: ' + error.message);
    }
}

function exportToPDF(data) {
    try {
        // Create new PDF document
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
            orientation: 'landscape',
            unit: 'mm',
            format: 'a4'
        });

        // Add title
        doc.setFontSize(20);
        doc.setTextColor(44, 90, 160); // Primary color
        doc.text('Clinic Survey Report', 14, 15);

        // Add date
        doc.setFontSize(12);
        doc.setTextColor(100, 116, 139); // Text light color
        doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 14, 23);
        doc.text(`Total Surveys: ${data.length}`, 14, 30);

        // Calculate statistics using the proper methods
        const stats = calculateDetailedStatistics(data);

        // Add summary statistics
        doc.setFontSize(14);
        doc.setTextColor(30, 41, 59); // Text color
        doc.text('Summary Statistics', 14, 40);

        doc.setFontSize(11);
        doc.setTextColor(71, 85, 105);
        doc.text(`Average Overall Satisfaction: ${stats.avgOverallSatisfaction}/5`, 14, 48);
        doc.text(`Satisfaction Rate: ${stats.satisfactionRate}%`, 14, 55);
        doc.text(`Follow-up Request Rate: ${stats.followUpRate}%`, 14, 62);

        // Add service quality metrics
        doc.text('Service Quality Metrics:', 120, 48);
        doc.text(`Registration Smooth: ${stats.registrationSmooth}%`, 120, 55);
        doc.text(`Doctor Listened: ${stats.doctorListening}%`, 120, 62);
        doc.text(`Acceptable Wait Time: ${stats.acceptableWaitTime}%`, 120, 69);

        // Add clinic breakdown
        let yPos = 75;
        doc.setFontSize(14);
        doc.setTextColor(30, 41, 59);
        doc.text('Clinic Performance', 14, yPos);
        yPos += 10;

        doc.setFontSize(10);
        Object.entries(stats.clinicStats).forEach(([clinic, data]) => {
            doc.setTextColor(71, 85, 105);
            doc.text(`${clinic}: ${data.count} surveys, ${data.avgRating}/5 avg rating, ${data.satisfactionRate}% satisfaction`, 20, yPos);
            yPos += 7;
        });

        // Add detailed table on new page
        doc.addPage();
        doc.setFontSize(16);
        doc.setTextColor(44, 90, 160);
        doc.text('Survey Details', 14, 15);

        // Prepare table data
        const tableData = data.map(survey => [
            survey.patient_name,
            survey.patient_email,
            new Date(survey.visit_date).toLocaleDateString(),
            clinicMap[survey.clinic_location] || survey.clinic_location,
            formatSatisfaction(survey.overall_satisfaction),
            formatYesNo(survey.want_contact),
            new Date(survey.created_at).toLocaleDateString()
        ]);

        // Add table
        doc.autoTable({
            head: [['Patient Name', 'Email', 'Visit Date', 'Clinic', 'Satisfaction', 'Follow-up', 'Submitted']],
            body: tableData,
            startY: 25,
            styles: {
                fontSize: 9,
                cellPadding: 3
            },
            headStyles: {
                fillColor: [44, 90, 160],
                textColor: 255,
                fontStyle: 'bold'
            },
            alternateRowStyles: {
                fillColor: [248, 250, 252]
            }
        });

        // Add charts summary page
        doc.addPage();
        doc.setFontSize(16);
        doc.setTextColor(44, 90, 160);
        doc.text('Department Performance', 14, 15);

        // Add department ratings
        yPos = 30;
        doc.setFontSize(12);
        doc.setTextColor(30, 41, 59);
        doc.text('Average Department Ratings (out of 5):', 14, yPos);
        yPos += 10;

        doc.setFontSize(11);
        doc.setTextColor(71, 85, 105);
        doc.text(`Reception: ${stats.departmentRatings.reception}/5`, 20, yPos);
        yPos += 7;
        doc.text(`Nursing: ${stats.departmentRatings.nursing}/5`, 20, yPos);
        yPos += 7;
        doc.text(`Doctor: ${stats.departmentRatings.doctor}/5`, 20, yPos);
        yPos += 7;
        doc.text(`Cleanliness: ${stats.departmentRatings.cleanliness}/5`, 20, yPos);

        // Save PDF
        const filename = `survey_report_${new Date().toISOString().split('T')[0]}.pdf`;
        doc.save(filename);

        console.log(`Exported ${data.length} surveys to PDF`);

    } catch (error) {
        console.error('PDF export error:', error);
        alert('Failed to export to PDF: ' + error.message);
    }
}

function calculateDetailedStatistics(data) {
    const totalSurveys = data.length;
    
    // Calculate average overall satisfaction using the correct scale
    const avgOverallSatisfaction = calculateAverageOverallSatisfaction(data);

    // Calculate satisfaction rate
    const satisfiedCount = data.filter(s => 
        s.overall_satisfaction === 'satisfied' || s.overall_satisfaction === 'very_satisfied'
    ).length;
    const satisfactionRate = totalSurveys > 0
        ? Math.round((satisfiedCount / totalSurveys) * 100)
        : 0;

    // Calculate follow-up rate
    const followUpRequests = data.filter(s => s.want_contact === 'yes').length;
    const followUpRate = totalSurveys > 0
        ? Math.round((followUpRequests / totalSurveys) * 100)
        : 0;

    // Calculate service quality metrics
    const registrationSmooth = calculateYesPercentage(data, 'registration_smooth');
    const doctorListening = calculateYesPercentage(data, 'doctor_listening');
    const acceptableWaitTime = calculateYesPercentage(data, 'waiting_time_acceptable');

    // Calculate department ratings
    const departmentRatings = {
        reception: calculateAverageDetailedSatisfaction(data, 'reception_satisfaction'),
        nursing: calculateAverageNursingProfessionalism(data),
        doctor: calculateAverageDetailedSatisfaction(data, 'doctor_satisfaction'),
        cleanliness: calculateAverageDetailedSatisfaction(data, 'clinic_cleanliness')
    };

    // Calculate clinic statistics
    const clinicStats = {};
    Object.keys(clinicMap).forEach(clinicId => {
        const clinicSurveys = data.filter(s => s.clinic_location === clinicId);
        if (clinicSurveys.length > 0) {
            const clinicName = clinicMap[clinicId];
            const clinicSatisfied = clinicSurveys.filter(s => 
                s.overall_satisfaction === 'satisfied' || s.overall_satisfaction === 'very_satisfied'
            ).length;
            
            clinicStats[clinicName] = {
                count: clinicSurveys.length,
                avgRating: calculateAverageOverallSatisfaction(clinicSurveys),
                satisfactionRate: Math.round((clinicSatisfied / clinicSurveys.length) * 100)
            };
        }
    });

    return {
        avgOverallSatisfaction,
        satisfactionRate,
        followUpRate,
        registrationSmooth,
        doctorListening,
        acceptableWaitTime,
        departmentRatings,
        clinicStats
    };
}

// Helper functions from the provided code
function calculateAverageOverallSatisfaction(surveys) {
    if (!surveys || surveys.length === 0) return '0.0';
    
    const total = surveys.reduce((sum, s) => sum + (satisfactionScales.overall[s.overall_satisfaction] || 3), 0);
    return (total / surveys.length).toFixed(1);
}

function calculateAverageDetailedSatisfaction(surveys, field) {
    if (!surveys || surveys.length === 0) return 0;
    
    const total = surveys.reduce((sum, s) => sum + (satisfactionScales.detailed[s[field]] || 3), 0);
    return parseFloat((total / surveys.length).toFixed(1));
}

function calculateAverageNursingProfessionalism(surveys) {
    if (!surveys || surveys.length === 0) return 0;
    
    const total = surveys.reduce((sum, s) => sum + (satisfactionScales.nursing[s.nursing_professionalism] || 2), 0);
    // Convert to 5-point scale for consistency
    return parseFloat(((total / surveys.length) * 5 / 4).toFixed(1));
}

function calculateYesPercentage(surveys, field) {
    if (!surveys || surveys.length === 0) return 0;
    
    const yesCount = surveys.filter(s => s[field] === 'yes').length;
    return Math.round((yesCount / surveys.length) * 100);
}// Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('surveyModal');
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    }

    // Setup auth state listener
    supabase.auth.onAuthStateChange((event, session) => {
        if (event === 'SIGNED_OUT') {
            if (dashboardInstance) {
                dashboardInstance.showAuth();
            }
        }
    });
</script>
</body>
</html>
