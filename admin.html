<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Survey Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8fafc;
            color: #1e293b;
        }

        .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 100%);
            color: white;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #2c5aa0;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #2c5aa0;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 12px 12px 0 0;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .tab {
            flex: 1;
            padding: 16px 24px;
            background: #f1f5f9;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            background: white;
            border-bottom-color: #2c5aa0;
            color: #2c5aa0;
        }

        .tab-content {
            background: white;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            min-height: 400px;
        }

        .tab-panel {
            display: none;
            padding: 24px;
        }

        .tab-panel.active {
            display: block;
        }

        .response-card {
            background: #f8fafc;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
            border-left: 4px solid #10b981;
        }

        .response-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .response-id {
            font-weight: 600;
            color: #2c5aa0;
            font-size: 14px;
        }

        .response-date {
            font-size: 14px;
            color: #64748b;
        }

        .ratings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .rating-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .rating-label {
            font-size: 14px;
            color: #475569;
        }

        .rating-value {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .rating-emoji {
            font-size: 18px;
        }

        .comments {
            background: white;
            padding: 12px;
            border-radius: 6px;
            font-style: italic;
            color: #475569;
            margin-top: 12px;
            border-left: 3px solid #e2e8f0;
        }

        .email-notification {
            background: #fef3c7;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid #f59e0b;
        }

        .email-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .email-subject {
            font-weight: 600;
            color: #92400e;
        }

        .email-date {
            font-size: 12px;
            color: #78716c;
        }

        .email-body {
            background: white;
            padding: 12px;
            border-radius: 4px;
            font-size: 14px;
            white-space: pre-line;
            color: #374151;
        }

        .refresh-btn {
            background: #2c5aa0;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 24px;
            transition: background 0.3s ease;
        }

        .refresh-btn:hover {
            background: #1e3a8a;
        }

        .empty-state {
            text-align: center;
            color: #64748b;
            padding: 48px 24px;
        }

        .empty-state h3 {
            margin-bottom: 8px;
            font-size: 18px;
        }

        .export-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 12px;
        }

        .export-btn:hover {
            background: #059669;
        }

        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .ratings-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Patient Survey Dashboard</h1>
        <p>Monitor patient feedback and satisfaction scores in real-time</p>
    </div>

    <div class="container">
        <!-- Statistics Overview -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-value" id="totalResponses">0</div>
                <div class="stat-label">Total Responses</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgSatisfaction">-</div>
                <div class="stat-label">Avg Overall Satisfaction</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgStaff">-</div>
                <div class="stat-label">Avg Staff Rating</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="emailsSent">0</div>
                <div class="stat-label">Email Notifications</div>
            </div>
        </div>

        <button class="refresh-btn" onclick="loadDashboardData()">🔄 Refresh Data</button>
        <button class="export-btn" onclick="exportData()">📊 Export CSV</button>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('responses')">Survey Responses</button>
            <button class="tab" onclick="showTab('reports')">Full Reports</button>
            <button class="tab" onclick="showTab('emails')">Email Notifications</button>
            <button class="tab" onclick="showTab('analytics')">Analytics</button>
        </div>

        <div class="tab-content">
            <!-- Survey Responses Tab -->
            <div id="responses" class="tab-panel active">
                <div style="margin-bottom: 20px; display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
                    <input type="text" id="searchInput" placeholder="Search by patient name or email..." 
                           style="flex: 1; min-width: 250px; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px;">
                    <select id="ratingFilter" style="padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px;">
                        <option value="">All Ratings</option>
                        <option value="5">5 Stars Only</option>
                        <option value="4">4+ Stars</option>
                        <option value="3">3+ Stars</option>
                        <option value="low">Low Ratings (1-2)</option>
                    </select>
                    <button onclick="applyFilters()" style="padding: 10px 20px; background: #2c5aa0; color: white; border: none; border-radius: 6px; cursor: pointer;">Filter</button>
                </div>
                <div id="responsesContainer">
                    <div class="empty-state">
                        <h3>No survey responses yet</h3>
                        <p>Patient responses will appear here once surveys are submitted</p>
                    </div>
                </div>
            </div>

            <!-- Full Reports Tab -->
            <div id="reports" class="tab-panel">
                <div style="margin-bottom: 24px; display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
                    <input type="date" id="startDate" style="padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px;">
                    <span>to</span>
                    <input type="date" id="endDate" style="padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px;">
                    <button onclick="generateReport()" style="padding: 10px 20px; background: #2c5aa0; color: white; border: none; border-radius: 6px; cursor: pointer;">Generate Report</button>
                    <button onclick="exportFullReport()" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer;">Export Detailed CSV</button>
                </div>
                <div id="reportsContainer">
                    <div class="empty-state">
                        <h3>Patient Satisfaction Report</h3>
                        <p>Select a date range and click "Generate Report" to view comprehensive analytics</p>
                    </div>
                </div>
            </div>

            <!-- Email Notifications Tab -->
            <div id="emails" class="tab-panel">
                <div id="emailsContainer">
                    <div class="empty-state">
                        <h3>No email notifications yet</h3>
                        <p>Email notifications will appear here when surveys are submitted</p>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics" class="tab-panel">
                <div id="analyticsContainer">
                    <div class="empty-state">
                        <h3>Analytics Dashboard</h3>
                        <p>Detailed analytics will be available once you have survey data</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Emoji mapping for ratings
        const emojiMap = {
            1: '😞',
            2: '😕', 
            3: '😐',
            4: '🙂',
            5: '😄'
        };

        // Load and display dashboard data
        function loadDashboardData() {
            const responses = JSON.parse(localStorage.getItem('surveyResponses') || '[]');
            const emails = JSON.parse(localStorage.getItem('emailNotifications') || '[]');

            updateStatistics(responses, emails);
            displayResponses(responses);
            displayEmails(emails);
            displayAnalytics(responses);
        }

        function updateStatistics(responses, emails) {
            document.getElementById('totalResponses').textContent = responses.length;
            document.getElementById('emailsSent').textContent = emails.length;

            if (responses.length > 0) {
                const avgSatisfaction = responses.reduce((sum, r) => sum + parseInt(r.overall_satisfaction), 0) / responses.length;
                const avgStaff = responses.reduce((sum, r) => sum + parseInt(r.staff_professionalism), 0) / responses.length;
                
                document.getElementById('avgSatisfaction').textContent = avgSatisfaction.toFixed(1);
                document.getElementById('avgStaff').textContent = avgStaff.toFixed(1);
            } else {
                document.getElementById('avgSatisfaction').textContent = '-';
                document.getElementById('avgStaff').textContent = '-';
            }
        }

        function displayResponses(responses) {
            const container = document.getElementById('responsesContainer');
            
            if (responses.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No survey responses yet</h3>
                        <p>Patient responses will appear here once surveys are submitted</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = responses.map(response => `
                <div class="response-card">
                    <div class="response-header">
                        <div style="flex: 1;">
                            <div class="response-id">Response ID: ${response.id}</div>
                            <div style="margin-top: 8px;">
                                <strong style="color: #1e293b; font-size: 16px;">${response.patient_name || 'Anonymous Patient'}</strong>
                                <div style="font-size: 14px; color: #64748b; margin-top: 4px;">
                                    📧 ${response.patient_email || 'No email provided'} 
                                    ${response.patient_phone ? '| 📞 ' + response.patient_phone : ''}
                                </div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div class="response-date">${response.submittedAt}</div>
                            <div style="font-size: 14px; color: #64748b; margin-top: 4px;">
                                🏥 ${response.department_visited || 'Department not specified'}
                            </div>
                            <div style="font-size: 12px; color: #64748b; margin-top: 2px;">
                                📅 ${response.visit_date || 'Date not provided'} | ⏰ ${response.visit_time || 'Time not specified'}
                            </div>
                        </div>
                    </div>

                    <!-- Wait Times Information -->
                    <div style="background: #f8fafc; padding: 12px; border-radius: 6px; margin: 16px 0;">
                        <div style="font-weight: 600; margin-bottom: 8px; color: #1e293b;">⏱️ Wait Times</div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; font-size: 14px;">
                            <div><strong>Actual wait:</strong> ${response.wait_time_actual || 'Not specified'}</div>
                            <div><strong>Timeliness:</strong> ${response.appointment_timeliness || 'Not specified'}</div>
                        </div>
                    </div>

                    <!-- Overall Satisfaction Ratings -->
                    <div style="margin-bottom: 16px;">
                        <div style="font-weight: 600; margin-bottom: 12px; color: #1e293b;">📊 Overall Experience</div>
                        <div class="ratings-grid">
                            <div class="rating-item">
                                <span class="rating-label">Overall Satisfaction</span>
                                <div class="rating-value">
                                    <span class="rating-emoji">${emojiMap[response.overall_satisfaction]}</span>
                                    <span>${response.overall_satisfaction}/5</span>
                                </div>
                            </div>
                            <div class="rating-item">
                                <span class="rating-label">Staff Professionalism</span>
                                <div class="rating-value">
                                    <span class="rating-emoji">${emojiMap[response.staff_professionalism]}</span>
                                    <span>${response.staff_professionalism}/5</span>
                                </div>
                            </div>
                            <div class="rating-item">
                                <span class="rating-label">Waiting Time</span>
                                <div class="rating-value">
                                    <span class="rating-emoji">${emojiMap[response.waiting_time]}</span>
                                    <span>${response.waiting_time}/5</span>
                                </div>
                            </div>
                            <div class="rating-item">
                                <span class="rating-label">Feeling Heard</span>
                                <div class="rating-value">
                                    <span class="rating-emoji">${emojiMap[response.feeling_heard]}</span>
                                    <span>${response.feeling_heard}/5</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Service-Specific Ratings -->
                    ${response.reception_rating || response.doctor_rating || response.nursing_rating ? `
                    <div style="margin-bottom: 16px;">
                        <div style="font-weight: 600; margin-bottom: 12px; color: #1e293b;">🏥 Service-Specific Ratings</div>
                        <div class="ratings-grid">
                            ${response.reception_rating ? `
                            <div class="rating-item">
                                <span class="rating-label">Reception/Front Desk</span>
                                <div class="rating-value">
                                    <span class="rating-emoji">${emojiMap[response.reception_rating]}</span>
                                    <span>${response.reception_rating}/5</span>
                                </div>
                            </div>` : ''}
                            ${response.doctor_rating ? `
                            <div class="rating-item">
                                <span class="rating-label">Doctor Consultation</span>
                                <div class="rating-value">
                                    <span class="rating-emoji">${emojiMap[response.doctor_rating]}</span>
                                    <span>${response.doctor_rating}/5</span>
                                </div>
                            </div>` : ''}
                            ${response.nursing_rating ? `
                            <div class="rating-item">
                                <span class="rating-label">Nursing Services</span>
                                <div class="rating-value">
                                    <span class="rating-emoji">${emojiMap[response.nursing_rating]}</span>
                                    <span>${response.nursing_rating}/5</span>
                                </div>
                            </div>` : ''}
                        </div>
                    </div>` : ''}

                    <!-- Staff Interaction Ratings -->
                    ${response.communication_clarity || response.staff_courtesy ? `
                    <div style="margin-bottom: 16px;">
                        <div style="font-weight: 600; margin-bottom: 12px; color: #1e293b;">👥 Staff Interaction</div>
                        <div class="ratings-grid">
                            ${response.communication_clarity ? `
                            <div class="rating-item">
                                <span class="rating-label">Communication Clarity</span>
                                <div class="rating-value">
                                    <span class="rating-emoji">${emojiMap[response.communication_clarity]}</span>
                                    <span>${response.communication_clarity}/5</span>
                                </div>
                            </div>` : ''}
                            ${response.staff_courtesy ? `
                            <div class="rating-item">
                                <span class="rating-label">Staff Courtesy</span>
                                <div class="rating-value">
                                    <span class="rating-emoji">${emojiMap[response.staff_courtesy]}</span>
                                    <span>${response.staff_courtesy}/5</span>
                                </div>
                            </div>` : ''}
                        </div>
                    </div>` : ''}

                    <!-- Issues Reported -->
                    ${response.had_issues === 'yes' ? `
                    <div style="background: #fef2f2; padding: 12px; border-radius: 6px; margin: 16px 0; border-left: 4px solid #dc2626;">
                        <div style="font-weight: 600; margin-bottom: 8px; color: #dc2626;">⚠️ Issues Reported</div>
                        <div style="color: #7f1d1d;">${response.issue_description || 'Issue reported but no details provided'}</div>
                    </div>` : ''}

                    <!-- Follow-up Needs -->
                    ${response.followup_needs_array && response.followup_needs_array.length > 0 ? `
                    <div style="background: #f0f9ff; padding: 12px; border-radius: 6px; margin: 16px 0; border-left: 4px solid #0ea5e9;">
                        <div style="font-weight: 600; margin-bottom: 8px; color: #0c4a6e;">📋 Follow-up Required</div>
                        <div style="color: #0c4a6e; margin-bottom: 4px;"><strong>Requested:</strong> ${response.followup_needs_array.join(', ')}</div>
                        ${response.followup_details ? `<div style="color: #0c4a6e;"><strong>Details:</strong> ${response.followup_details}</div>` : ''}
                        ${response.contact_preference_array && response.contact_preference_array.length > 0 ? `<div style="color: #0c4a6e; margin-top: 4px;"><strong>Contact via:</strong> ${response.contact_preference_array.join(', ')}</div>` : ''}
                    </div>` : ''}

                    <!-- General Comments -->
                    ${response.comments ? `<div class="comments"><strong>Patient Comments:</strong> "${response.comments}"</div>` : ''}
                    
                    <!-- Alert for low satisfaction -->
                    ${parseInt(response.overall_satisfaction) <= 2 || response.had_issues === 'yes' ? '<div style="background: #fef2f2; color: #dc2626; padding: 8px; border-radius: 4px; margin-top: 12px; font-weight: 500;">🚨 PRIORITY: Follow-up required within 24 hours!</div>' : ''}
                </div>
            `).join('');
        }

        function displayEmails(emails) {
            const container = document.getElementById('emailsContainer');
            
            if (emails.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No email notifications yet</h3>
                        <p>Email notifications will appear here when surveys are submitted</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = emails.map(email => `
                <div class="email-notification">
                    <div class="email-header">
                        <div class="email-subject">${email.subject}</div>
                        <div class="email-date">Sent: ${email.sentAt}</div>
                    </div>
                    <div><strong>To:</strong> ${email.to}</div>
                    <div class="email-body">${email.body}</div>
                </div>
            `).join('');
        }

        function displayAnalytics(responses) {
            const container = document.getElementById('analyticsContainer');
            
            if (responses.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>Analytics Dashboard</h3>
                        <p>Detailed analytics will be available once you have survey data</p>
                    </div>
                `;
                return;
            }

            // Calculate analytics
            const totalResponses = responses.length;
            const satisfactionCounts = {1: 0, 2: 0, 3: 0, 4: 0, 5: 0};
            const staffCounts = {1: 0, 2: 0, 3: 0, 4: 0, 5: 0};
            
            responses.forEach(r => {
                satisfactionCounts[r.overall_satisfaction]++;
                staffCounts[r.staff_professionalism]++;
            });

            const highSatisfaction = ((satisfactionCounts[4] + satisfactionCounts[5]) / totalResponses * 100).toFixed(1);
            const highStaff = ((staffCounts[4] + staffCounts[5]) / totalResponses * 100).toFixed(1);

            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div class="stat-card">
                        <div class="stat-value">${highSatisfaction}%</div>
                        <div class="stat-label">High Satisfaction (4-5 rating)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${highStaff}%</div>
                        <div class="stat-label">High Staff Rating (4-5 rating)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${responses.filter(r => r.comments).length}</div>
                        <div class="stat-label">Responses with Comments</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${responses.filter(r => parseInt(r.overall_satisfaction) <= 2).length}</div>
                        <div class="stat-label">Low Satisfaction Alerts</div>
                    </div>
                </div>
                <div style="margin-top: 24px; background: white; padding: 20px; border-radius: 8px;">
                    <h3 style="margin-bottom: 16px; color: #1e293b;">Rating Distribution</h3>
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; text-align: center;">
                        ${[1,2,3,4,5].map(rating => `
                            <div style="padding: 12px; background: #f8fafc; border-radius: 6px;">
                                <div style="font-size: 24px;">${emojiMap[rating]}</div>
                                <div style="font-weight: 600; margin: 8px 0;">${rating}</div>
                                <div style="font-size: 14px; color: #64748b;">${satisfactionCounts[rating]} responses</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function showTab(tabName) {
            // Remove active class from all tabs and panels
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
            
            // Add active class to selected tab and panel
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        function exportData() {
            const responses = JSON.parse(localStorage.getItem('surveyResponses') || '[]');
            
            if (responses.length === 0) {
                alert('No data to export');
                return;
            }

            // Create comprehensive CSV content with all required data points
            const headers = [
                'Response ID', 'Submission Date', 'Patient Name', 'Patient Email', 'Patient Phone', 
                'Visit Date', 'Visit Time', 'Department Visited',
                'Wait Time Actual', 'Appointment Timeliness',
                'Overall Satisfaction', 'Staff Professionalism', 'Waiting Time Rating', 'Feeling Heard',
                'Reception Rating', 'Doctor Rating', 'Nursing Rating',
                'Communication Clarity', 'Staff Courtesy',
                'Had Issues', 'Issue Description',
                'Follow-up Needs', 'Follow-up Details', 'Contact Preferences',
                'General Comments'
            ];
            
            const csvContent = [
                headers.join(','),
                ...responses.map(r => [
                    r.id,
                    r.submittedAt,
                    `"${r.patient_name || ''}"`,
                    r.patient_email || '',
                    r.patient_phone || '',
                    r.visit_date || '',
                    r.visit_time || '',
                    `"${r.department_visited || ''}"`,
                    `"${r.wait_time_actual || ''}"`,
                    `"${r.appointment_timeliness || ''}"`,
                    r.overall_satisfaction,
                    r.staff_professionalism,
                    r.waiting_time,
                    r.feeling_heard,
                    r.reception_rating || '',
                    r.doctor_rating || '',
                    r.nursing_rating || '',
                    r.communication_clarity || '',
                    r.staff_courtesy || '',
                    r.had_issues || '',
                    `"${(r.issue_description || '').replace(/"/g, '""')}"`,
                    `"${(r.followup_needs_array || []).join('; ')}"`,
                    `"${(r.followup_details || '').replace(/"/g, '""')}"`,
                    `"${(r.contact_preference_array || []).join('; ')}"`,
                    `"${(r.comments || '').replace(/"/g, '""')}"`
                ].join(','))
            ].join('\n');

            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', `comprehensive_patient_survey_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Filter functionality
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const ratingFilter = document.getElementById('ratingFilter').value;
            
            const responses = JSON.parse(localStorage.getItem('surveyResponses') || '[]');
            
            let filteredResponses = responses.filter(response => {
                // Search filter
                const matchesSearch = !searchTerm || 
                    (response.patient_name && response.patient_name.toLowerCase().includes(searchTerm)) ||
                    (response.patient_email && response.patient_email.toLowerCase().includes(searchTerm));
                
                // Rating filter
                let matchesRating = true;
                if (ratingFilter === '5') {
                    matchesRating = response.overall_satisfaction == 5;
                } else if (ratingFilter === '4') {
                    matchesRating = response.overall_satisfaction >= 4;
                } else if (ratingFilter === '3') {
                    matchesRating = response.overall_satisfaction >= 3;
                } else if (ratingFilter === 'low') {
                    matchesRating = response.overall_satisfaction <= 2;
                }
                
                return matchesSearch && matchesRating;
            });
            
            displayResponses(filteredResponses);
        }

        // Report generation
        function generateReport() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const responses = JSON.parse(localStorage.getItem('surveyResponses') || '[]');
            
            let filteredResponses = responses;
            if (startDate && endDate) {
                filteredResponses = responses.filter(r => {
                    const responseDate = new Date(r.appointment_date || r.timestamp);
                    return responseDate >= new Date(startDate) && responseDate <= new Date(endDate);
                });
            }
            
            if (filteredResponses.length === 0) {
                document.getElementById('reportsContainer').innerHTML = `
                    <div class="empty-state">
                        <h3>No data found for selected period</h3>
                        <p>Try adjusting your date range or check if surveys have been submitted</p>
                    </div>
                `;
                return;
            }
            
            generateFullReport(filteredResponses, startDate, endDate);
        }

        function generateFullReport(responses, startDate, endDate) {
            const container = document.getElementById('reportsContainer');
            
            // Calculate comprehensive statistics
            const totalResponses = responses.length;
            const avgSatisfaction = (responses.reduce((sum, r) => sum + parseInt(r.overall_satisfaction), 0) / totalResponses).toFixed(2);
            const avgStaff = (responses.reduce((sum, r) => sum + parseInt(r.staff_professionalism), 0) / totalResponses).toFixed(2);
            const avgWaiting = (responses.reduce((sum, r) => sum + parseInt(r.waiting_time), 0) / totalResponses).toFixed(2);
            const avgHeard = (responses.reduce((sum, r) => sum + parseInt(r.feeling_heard), 0) / totalResponses).toFixed(2);
            
            // Service-specific analysis
            const serviceRatings = {
                reception: responses.filter(r => r.reception_rating).map(r => parseInt(r.reception_rating)),
                doctor: responses.filter(r => r.doctor_rating).map(r => parseInt(r.doctor_rating)),
                nursing: responses.filter(r => r.nursing_rating).map(r => parseInt(r.nursing_rating))
            };

            // Wait times analysis
            const waitTimeStats = {};
            responses.forEach(r => {
                const waitTime = r.wait_time_actual;
                if (waitTime) {
                    waitTimeStats[waitTime] = (waitTimeStats[waitTime] || 0) + 1;
                }
            });

            // Department analysis
            const departmentStats = {};
            responses.forEach(r => {
                const dept = r.department_visited || 'Not specified';
                if (!departmentStats[dept]) {
                    departmentStats[dept] = { count: 0, totalSatisfaction: 0, avgSatisfaction: 0 };
                }
                departmentStats[dept].count++;
                departmentStats[dept].totalSatisfaction += parseInt(r.overall_satisfaction);
                departmentStats[dept].avgSatisfaction = (departmentStats[dept].totalSatisfaction / departmentStats[dept].count).toFixed(1);
            });

            // Issues analysis
            const issuesReported = responses.filter(r => r.had_issues === 'yes');
            const issueRate = ((issuesReported.length / totalResponses) * 100).toFixed(1);

            // Follow-up analysis
            const followupNeeds = {};
            responses.forEach(r => {
                if (r.followup_needs_array && r.followup_needs_array.length > 0) {
                    r.followup_needs_array.forEach(need => {
                        followupNeeds[need] = (followupNeeds[need] || 0) + 1;
                    });
                }
            });

            // Low/high satisfaction analysis
            const lowSatisfactionResponses = responses.filter(r => parseInt(r.overall_satisfaction) <= 2);
            const highSatisfactionResponses = responses.filter(r => parseInt(r.overall_satisfaction) >= 4);
            
            container.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);">
                    <div style="text-align: center; margin-bottom: 32px; padding-bottom: 24px; border-bottom: 2px solid #e2e8f0;">
                        <h2 style="color: #1e293b; margin-bottom: 8px;">Comprehensive Patient Satisfaction Report</h2>
                        <p style="color: #64748b; font-size: 16px;">
                            ${startDate && endDate ? `Period: ${startDate} to ${endDate}` : 'All Time Data'} | 
                            Total Responses: ${totalResponses}
                        </p>
                    </div>
                    
                    <!-- Executive Summary -->
                    <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 24px;">
                        <h3 style="color: #1e293b; margin-bottom: 16px;">📊 Executive Summary</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px;">
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #2c5aa0;">${avgSatisfaction}/5</div>
                                <div style="font-size: 14px; color: #64748b;">Overall Satisfaction</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #2c5aa0;">${((highSatisfactionResponses.length / totalResponses) * 100).toFixed(1)}%</div>
                                <div style="font-size: 14px; color: #64748b;">High Satisfaction (4-5)</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: ${lowSatisfactionResponses.length > 0 ? '#dc2626' : '#10b981'};">${lowSatisfactionResponses.length}</div>
                                <div style="font-size: 14px; color: #64748b;">Low Satisfaction Alerts</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: ${issueRate > 10 ? '#dc2626' : '#10b981'};">${issueRate}%</div>
                                <div style="font-size: 14px; color: #64748b;">Issue Rate</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #2c5aa0;">${Object.values(followupNeeds).reduce((a, b) => a + b, 0)}</div>
                                <div style="font-size: 14px; color: #64748b;">Follow-up Requests</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Core Satisfaction Metrics -->
                    <div style="margin-bottom: 24px;">
                        <h3 style="color: #1e293b; margin-bottom: 16px;">📈 Core Satisfaction Metrics</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                            <div style="background: #f1f5f9; padding: 16px; border-radius: 8px;">
                                <div style="font-weight: 600; margin-bottom: 8px;">Staff Professionalism</div>
                                <div style="font-size: 20px; color: #2c5aa0;">${avgStaff}/5</div>
                            </div>
                            <div style="background: #f1f5f9; padding: 16px; border-radius: 8px;">
                                <div style="font-weight: 600; margin-bottom: 8px;">Waiting Time Satisfaction</div>
                                <div style="font-size: 20px; color: #2c5aa0;">${avgWaiting}/5</div>
                            </div>
                            <div style="background: #f1f5f9; padding: 16px; border-radius: 8px;">
                                <div style="font-weight: 600; margin-bottom: 8px;">Feeling Heard</div>
                                <div style="font-size: 20px; color: #2c5aa0;">${avgHeard}/5</div>
                            </div>
                        </div>
                    </div>

                    <!-- Service-Specific Performance -->
                    <div style="margin-bottom: 24px;">
                        <h3 style="color: #1e293b; margin-bottom: 16px;">🏥 Service-Specific Performance</h3>
                        <div style="background: #f8fafc; padding: 16px; border-radius: 8px;">
                            ${serviceRatings.reception.length > 0 ? `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e2e8f0;">
                                <span style="font-weight: 500;">Reception/Front Desk</span>
                                <div style="text-align: right;">
                                    <span style="font-weight: 600; color: #2c5aa0;">${(serviceRatings.reception.reduce((a,b) => a+b, 0) / serviceRatings.reception.length).toFixed(1)}/5</span>
                                    <span style="font-size: 12px; color: #64748b; margin-left: 8px;">(${serviceRatings.reception.length} ratings)</span>
                                </div>
                            </div>` : ''}
                            ${serviceRatings.doctor.length > 0 ? `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e2e8f0;">
                                <span style="font-weight: 500;">Doctor Consultation</span>
                                <div style="text-align: right;">
                                    <span style="font-weight: 600; color: #2c5aa0;">${(serviceRatings.doctor.reduce((a,b) => a+b, 0) / serviceRatings.doctor.length).toFixed(1)}/5</span>
                                    <span style="font-size: 12px; color: #64748b; margin-left: 8px;">(${serviceRatings.doctor.length} ratings)</span>
                                </div>
                            </div>` : ''}
                            ${serviceRatings.nursing.length > 0 ? `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e2e8f0;">
                                <span style="font-weight: 500;">Nursing Services</span>
                                <div style="text-align: right;">
                                    <span style="font-weight: 600; color: #2c5aa0;">${(serviceRatings.nursing.reduce((a,b) => a+b, 0) / serviceRatings.nursing.length).toFixed(1)}/5</span>
                                    <span style="font-size: 12px; color: #64748b; margin-left: 8px;">(${serviceRatings.nursing.length} ratings)</span>
                                </div>
                            </div>` : ''}
                        </div>
                    </div>

                    <!-- Wait Times Analysis -->
                    <div style="margin-bottom: 24px;">
                        <h3 style="color: #1e293b; margin-bottom: 16px;">⏱️ Wait Times Analysis</h3>
                        <div style="background: #f8fafc; padding: 16px; border-radius: 8px;">
                            ${Object.entries(waitTimeStats).map(([time, count]) => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0;">
                                    <span style="font-weight: 500;">${time}</span>
                                    <div style="text-align: right;">
                                        <span style="font-weight: 600; color: #2c5aa0;">${count} patients</span>
                                        <span style="font-size: 12px; color: #64748b; margin-left: 8px;">(${((count/totalResponses)*100).toFixed(1)}%)</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Department Performance -->
                    <div style="margin-bottom: 24px;">
                        <h3 style="color: #1e293b; margin-bottom: 16px;">🏢 Department Performance</h3>
                        <div style="background: #f8fafc; padding: 16px; border-radius: 8px;">
                            ${Object.entries(departmentStats).map(([dept, stats]) => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e2e8f0;">
                                    <span style="font-weight: 500;">${dept}</span>
                                    <div style="text-align: right;">
                                        <span style="font-weight: 600; color: #2c5aa0;">${stats.avgSatisfaction}/5</span>
                                        <span style="font-size: 12px; color: #64748b; margin-left: 8px;">(${stats.count} visits)</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Follow-up Needs Analysis -->
                    ${Object.keys(followupNeeds).length > 0 ? `
                    <div style="margin-bottom: 24px;">
                        <h3 style="color: #1e293b; margin-bottom: 16px;">📋 Follow-up Needs Analysis</h3>
                        <div style="background: #f0f9ff; padding: 16px; border-radius: 8px;">
                            ${Object.entries(followupNeeds).map(([need, count]) => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0;">
                                    <span style="font-weight: 500;">${need.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>
                                    <div style="text-align: right;">
                                        <span style="font-weight: 600; color: #0ea5e9;">${count} requests</span>
                                        <span style="font-size: 12px; color: #64748b; margin-left: 8px;">(${((count/totalResponses)*100).toFixed(1)}%)</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>` : ''}

                    ${issuesReported.length > 0 ? `
                    <!-- Issues Reported -->
                    <div style="margin-bottom: 24px;">
                        <h3 style="color: #dc2626; margin-bottom: 16px;">⚠️ Issues Requiring Attention</h3>
                        <div style="background: #fef2f2; padding: 16px; border-radius: 8px; border-left: 4px solid #dc2626;">
                            <div style="margin-bottom: 12px; font-weight: 600; color: #dc2626;">${issuesReported.length} patients reported issues (${issueRate}% of total)</div>
                            ${issuesReported.slice(0, 5).map(r => `
                                <div style="margin-bottom: 12px; padding: 12px; background: white; border-radius: 6px;">
                                    <div style="font-weight: 600; color: #1e293b;">${r.patient_name} - ${r.visit_date}</div>
                                    <div style="font-size: 14px; color: #64748b;">${r.patient_email} | Department: ${r.department_visited}</div>
                                    <div style="font-style: italic; margin-top: 8px; color: #7f1d1d;">"${r.issue_description || 'Issue reported but no details provided'}"</div>
                                </div>
                            `).join('')}
                            ${issuesReported.length > 5 ? `<div style="text-align: center; color: #64748b; font-style: italic;">... and ${issuesReported.length - 5} more issues reported</div>` : ''}
                        </div>
                    </div>` : ''}
                    
                    ${lowSatisfactionResponses.length > 0 ? `
                    <!-- Low Satisfaction Follow-up -->
                    <div style="margin-bottom: 24px;">
                        <h3 style="color: #dc2626; margin-bottom: 16px;">🚨 Urgent Follow-up Required</h3>
                        <div style="background: #fef2f2; padding: 16px; border-radius: 8px; border-left: 4px solid #dc2626;">
                            ${lowSatisfactionResponses.map(r => `
                                <div style="margin-bottom: 12px; padding: 12px; background: white; border-radius: 6px;">
                                    <div style="font-weight: 600; color: #1e293b;">${r.patient_name}</div>
                                    <div style="font-size: 14px; color: #64748b;">${r.patient_email} | ${r.patient_phone || 'No phone'} | ${r.visit_date}</div>
                                    <div style="font-size: 14px; margin-top: 4px;">Overall Satisfaction: ${r.overall_satisfaction}/5 | Department: ${r.department_visited}</div>
                                    ${r.comments ? `<div style="font-style: italic; margin-top: 8px; color: #475569;">"${r.comments}"</div>` : ''}
                                    ${r.followup_needs_array && r.followup_needs_array.length > 0 ? `<div style="margin-top: 4px; color: #0ea5e9;"><strong>Follow-up requested:</strong> ${r.followup_needs_array.join(', ')}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>` : ''}
                    
                    <!-- Operational Recommendations -->
                    <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; border-left: 4px solid #2c5aa0;">
                        <h3 style="color: #1e293b; margin-bottom: 16px;">💡 Operational Recommendations</h3>
                        <ul style="color: #475569; line-height: 1.6;">
                            ${avgSatisfaction < 4.0 ? '<li><strong>Priority:</strong> Overall satisfaction below 4.0 - implement comprehensive patient experience review</li>' : ''}
                            ${avgWaiting < 3.5 ? '<li><strong>Wait Times:</strong> Patient waiting time satisfaction is low - review scheduling efficiency and wait time management</li>' : ''}
                            ${lowSatisfactionResponses.length > 0 ? `<li><strong>Urgent:</strong> ${lowSatisfactionResponses.length} patient(s) require immediate follow-up within 24 hours</li>` : ''}
                            ${issueRate > 10 ? `<li><strong>Quality Alert:</strong> ${issueRate}% issue rate exceeds 10% threshold - investigate common problem areas</li>` : ''}
                            ${Object.keys(followupNeeds).length > 0 ? '<li><strong>Follow-up System:</strong> Implement systematic follow-up process for patient requests</li>' : ''}
                            ${serviceRatings.reception.length > 0 && (serviceRatings.reception.reduce((a,b) => a+b, 0) / serviceRatings.reception.length) < 4.0 ? '<li><strong>Front Desk:</strong> Reception service scores indicate need for customer service training</li>' : ''}
                            ${avgSatisfaction >= 4.5 ? '<li><strong>Success:</strong> Excellent satisfaction scores - consider patient testimonial program</li>' : ''}
                            <li><strong>Continuous Improvement:</strong> Schedule monthly review of feedback trends and implement action plans</li>
                            <li><strong>Staff Recognition:</strong> Share positive feedback with teams to maintain high service standards</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        function exportFullReport() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const responses = JSON.parse(sessionStorage.getItem('surveyResponses') || '[]');
            
            let filteredResponses = responses;
            if (startDate && endDate) {
                filteredResponses = responses.filter(r => {
                    const responseDate = new Date(r.appointment_date || r.timestamp);
                    return responseDate >= new Date(startDate) && responseDate <= new Date(endDate);
                });
            }
            
            if (filteredResponses.length === 0) {
                alert('No data to export for selected period');
                return;
            }
            
            // Create detailed CSV with additional calculated fields
            const headers = [
                'Response ID', 'Submission Date', 'Patient Name', 'Patient Email', 'Patient Phone', 
                'Appointment Date', 'Overall Satisfaction', 'Staff Professionalism', 'Waiting Time', 'Feeling Heard', 
                'Average Rating', 'High Satisfaction (4+)', 'Low Satisfaction (1-2)', 'Has Comments', 'Comments'
            ];
            
            const csvContent = [
                headers.join(','),
                ...filteredResponses.map(r => {
                    const avgRating = ((parseInt(r.overall_satisfaction) + parseInt(r.staff_professionalism) + parseInt(r.waiting_time) + parseInt(r.feeling_heard)) / 4).toFixed(2);
                    const isHighSatisfaction = parseInt(r.overall_satisfaction) >= 4 ? 'Yes' : 'No';
                    const isLowSatisfaction = parseInt(r.overall_satisfaction) <= 2 ? 'Yes' : 'No';
                    const hasComments = r.comments ? 'Yes' : 'No';
                    
                    return [
                        r.id,
                        r.submittedAt,
                        `"${r.patient_name || ''}"`,
                        r.patient_email || '',
                        r.patient_phone || '',
                        r.appointment_date || '',
                        r.overall_satisfaction,
                        r.staff_professionalism,
                        r.waiting_time,
                        r.feeling_heard,
                        avgRating,
                        isHighSatisfaction,
                        isLowSatisfaction,
                        hasComments,
                        `"${(r.comments || '').replace(/"/g, '""')}"`
                    ].join(',');
                })
            ].join('\n');

            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', `detailed_patient_report_${startDate || 'all_time'}_to_${endDate || 'present'}.csv`);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Load data when page loads
        window.addEventListener('load', loadDashboardData);
        
        // Auto-refresh every 30 seconds
        setInterval(loadDashboardData, 30000);
    </script>
</body>
</html>
