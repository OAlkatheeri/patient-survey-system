<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Survey Admin Dashboard</title>
    
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <!-- Export libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Auth Screen Styles */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .auth-form {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 450px;
        }

        .auth-form h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c5aa0;
            font-size: 28px;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
            background: #f1f5f9;
            border-radius: 8px;
            padding: 4px;
        }

        .auth-tab {
            flex: 1;
            background: none;
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #64748b;
        }

        .auth-tab.active {
            background: white;
            color: #2c5aa0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #2c5aa0;
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
        }

        .form-group small {
            color: #64748b;
            font-size: 14px;
        }

        .btn-primary {
            width: 100%;
            background: linear-gradient(135deg, #2c5aa0 0%, #1e3a8a 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(44, 90, 160, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .error-message {
            color: #dc2626;
            background: #fee2e2;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .success-message {
            color: #059669;
            background: #d1fae5;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        /* Dashboard Layout */
        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #2c5aa0;
            font-size: 24px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info .role-badge {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .btn-logout {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
        }

        .btn-logout:hover {
            background: #dc2626;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            padding: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            overflow-x: auto;
        }

        .nav-tab {
            background: none;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
            color: #64748b;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #2c5aa0 0%, #1e3a8a 100%);
            color: white;
        }

        .nav-tab:hover:not(.active) {
            background: #f1f5f9;
            color: #2c5aa0;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border-left: 4px solid;
        }

        .stat-card.primary { border-color: #2c5aa0; }
        .stat-card.success { border-color: #10b981; }
        .stat-card.warning { border-color: #f59e0b; }
        .stat-card.danger { border-color: #ef4444; }

        .stat-card h3 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-card p {
            color: #64748b;
            font-weight: 500;
        }

        .stat-card .trend {
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
        }

        .trend.up { color: #10b981; }
        .trend.down { color: #ef4444; }

        /* Tables */
        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .table-header {
            padding: 20px 25px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .table-header h3 {
            color: #1e293b;
            font-size: 18px;
        }

        .table-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px 25px;
            text-align: left;
            border-bottom: 1px solid #f1f5f9;
        }

        th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        tbody tr:hover {
            background: #f8fafc;
        }

        /* Charts */
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .chart-container h3 {
            margin-bottom: 20px;
            color: #1e293b;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
        }

        /* Buttons */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-primary { background: #2c5aa0; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-secondary { background: #6b7280; color: white; }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Status badges */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending { background: #fef3c7; color: #92400e; }
        .status-completed { background: #d1fae5; color: #065f46; }
        .status-high { background: #fee2e2; color: #991b1b; }
        .status-medium { background: #fef3c7; color: #92400e; }
        .status-low { background: #d1fae5; color: #065f46; }

        /* Loading spinner */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #2c5aa0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Filters */
        .filters {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #2c5aa0;
        }

        /* Enhanced Department Select Styling */
        .department-select {
            position: relative;
        }

        .department-select select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .department-select select:focus {
            outline: none;
            border-color: #2c5aa0;
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
        }

        .department-select select:hover {
            border-color: #94a3b8;
        }

        .department-select optgroup {
            font-weight: 600;
            color: #2c5aa0;
            background: #f8fafc;
            padding: 8px 0;
        }

        .department-select option {
            padding: 10px 16px;
            color: #374151;
            background: white;
        }

        .department-select option:hover {
            background: #f1f5f9;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        /* Alert styles */
        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #3b82f6;
        }

        /* Export dropdown */
        .export-dropdown {
            position: relative;
            display: inline-block;
        }

        .export-dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 120px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 6px;
            right: 0;
        }
        /* Enhanced export dropdown styles */
        .export-dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 200px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1000;
            border-radius: 6px;
            right: 0;
            border: 1px solid #e5e7eb;
        }

        .export-dropdown-content a {
            color: #374151;
            padding: 10px 15px;
            text-decoration: none;
            display: block;
            font-size: 14px;
            border-bottom: 1px solid #f1f5f9;
            transition: background-color 0.2s;
        }

        .export-dropdown-content a:last-child {
            border-bottom: none;
        }

        .export-dropdown-content a:hover {
            background-color: #f8fafc;
            color: #2c5aa0;
        }

        .export-dropdown-content hr {
            margin: 5px 0;
            border: none;
            border-top: 1px solid #e5e7eb;
        }

        .export-dropdown.show .export-dropdown-content {
            display: block;
            animation: slideDown 0.2s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Export progress styles */
        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #2c5aa0;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Export actions */
        .export-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .export-actions .btn {
            font-size: 12px;
            padding: 6px 12px;
        }

        /* Responsive export buttons */
        @media (max-width: 768px) {
            .export-actions {
                flex-direction: column;
                width: 100%;
            }
            
            .export-actions .btn {
                width: 100%;
                margin-bottom: 5px;
            }
            
            .export-dropdown-content {
                min-width: 180px;
                right: 0;
                left: auto;
            }
        }
        .export-dropdown-content a {
            color: #374151;
            padding: 8px 12px;
            text-decoration: none;
            display: block;
            font-size: 14px;
        }

        .export-dropdown-content a:hover {
            background-color: #f8fafc;
        }

        .export-dropdown.show .export-dropdown-content {
            display: block;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                justify-content: flex-start;
            }

            table {
                font-size: 14px;
            }

            th, td {
                padding: 10px 15px;
            }

            .chart-grid {
                grid-template-columns: 1fr;
            }

            .table-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <!-- Authentication Screen -->
    <div id="authScreen" class="auth-container">
        <div class="auth-form">
            <h1>üè• Admin Portal</h1>
            
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login')">Sign In</button>
                <button class="auth-tab" onclick="switchAuthTab('register')">Register</button>
            </div>

            <div id="authError" class="error-message" style="display: none;"></div>
            <div id="authSuccess" class="success-message" style="display: none;"></div>

            <!-- Login Form -->
            <form id="loginForm" style="display: block;">
                <div class="form-group">
                    <label for="loginEmail">Email Address</label>
                    <input type="email" id="loginEmail" required placeholder="admin@hospital.com">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" required placeholder="Enter your password">
                </div>
                <button type="submit" class="btn-primary">Sign In</button>
            </form>

            <!-- Register Form -->
            <form id="registerForm" style="display: none;">
                <div class="form-group">
                    <label for="registerName">Full Name</label>
                    <input type="text" id="registerName" required placeholder="John Doe">
                </div>
                <div class="form-group">
                    <label for="registerEmail">Email Address</label>
                    <input type="email" id="registerEmail" required placeholder="john@hospital.com">
                </div>
                <div class="form-group">
                    <label for="registerPassword">Password</label>
                    <input type="password" id="registerPassword" required placeholder="Create your login password" minlength="6">
                    <small>This will be your personal login password.</small>
                </div>
                <div class="form-group">
                    <label for="registerDepartment">Department</label>
                    <div class="department-select">
                        <select id="registerDepartment" required>
                            <option value="" disabled selected>üè• Select your department</option>
                            
                            <optgroup label="üè• Patient Care Services">
                                <option value="Reception/Front Desk">üìù Reception / Front Desk</option>
                                <option value="General Practice">üë©‚Äç‚öïÔ∏è General Practice</option>
                                <option value="Specialist Consultation">ü©∫ Specialist Consultation</option>
                                <option value="Nursing Services">üë©‚Äç‚öïÔ∏è Nursing Services</option>
                                <option value="Emergency/Urgent Care">üöë Emergency / Urgent Care</option>
                            </optgroup>
                            
                            <optgroup label="üî¨ Diagnostic Services">
                                <option value="Laboratory">üß™ Laboratory</option>
                                <option value="Radiology/Imaging">üì∏ Radiology / Imaging</option>
                            </optgroup>
                            
                            <optgroup label="üíä Support Services">
                                <option value="Pharmacy">üíä Pharmacy</option>
                                <option value="Physical Therapy">üèÉ‚Äç‚ôÇÔ∏è Physical Therapy</option>
                            </optgroup>
                            
                            <optgroup label="üè¢ Administration">
                                <option value="Administration">üè¢ Administration</option>
                                <option value="IT">üíª Information Technology</option>
                                <option value="Other">üìã Other</option>
                            </optgroup>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="adminCode">Admin Access Code</label>
                    <input type="password" id="adminCode" required placeholder="Enter admin code">
                    <small>Contact your system administrator for the admin access code.</small>
                </div>
                <button type="submit" class="btn-primary">Create Account</button>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <h1>üìä Patient Survey Dashboard</h1>
                <div class="user-info">
                    <span id="userName">Loading...</span>
                    <span id="userRole" class="role-badge">Admin</span>
                    <button id="logoutBtn" class="btn-logout">Logout</button>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="nav-tabs">
                <button class="nav-tab active" data-tab="overview">üìà Overview</button>
                <button class="nav-tab" data-tab="surveys">üìã All Surveys</button>
                <button class="nav-tab" data-tab="analytics">üìä Analytics</button>
                <button class="nav-tab" data-tab="follow-ups">üìû Follow-ups</button>
                <button class="nav-tab" data-tab="users">üë• Users</button>
                <button class="nav-tab" data-tab="settings">‚öôÔ∏è Settings</button>
            </div>

            <!-- Overview Tab -->
            <div id="overview" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card primary">
                        <h3 id="totalSurveys">0</h3>
                        <p>Total Surveys Today</p>
                        <div class="trend up" id="surveyTrend">Loading...</div>
                    </div>
                    <div class="stat-card success">
                        <h3 id="avgSatisfaction">0.0</h3>
                        <p>Average Satisfaction</p>
                        <div class="trend up" id="satisfactionTrend">Loading...</div>
                    </div>
                    <div class="stat-card warning">
                        <h3 id="pendingFollowUps">0</h3>
                        <p>Pending Follow-ups</p>
                        <div class="trend down" id="followUpTrend">Loading...</div>
                    </div>
                    <div class="stat-card danger">
                        <h3 id="lowSatisfaction">0</h3>
                        <p>Low Satisfaction (‚â§2)</p>
                        <div class="trend down" id="lowSatTrend">Loading...</div>
                    </div>
                </div>

                <!-- Recent Surveys -->
                <div class="table-container">
                    <div class="table-header">
                        <h3>Recent Survey Responses</h3>
                        <div class="table-actions">
                            <button class="btn btn-primary btn-sm" onclick="refreshData()">üîÑ Refresh</button>
                            <div class="export-dropdown">
                                <button class="btn btn-success btn-sm" onclick="toggleExportDropdown(this)">üì• Export Recent ‚ñº</button>
                                <div class="export-dropdown-content">
                                    <a href="#" onclick="exportRecentSurveys('excel')">üìä Excel Report</a>
                                    <a href="#" onclick="exportRecentSurveys('csv')">üìã CSV Data</a>
                                    <a href="#" onclick="exportRecentSurveys('pdf')">üìÑ PDF Report</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Patient</th>
                                <th>Department</th>
                                <th>Overall Rating</th>
                                <th>Visit Date</th>
                                <th>Submitted</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recentSurveysTable">
                            <tr>
                                <td colspan="7" class="loading">
                                    <div class="spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- All Surveys Tab -->
            <div id="surveys" class="tab-content">
                <div class="filters">
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label>Department</label>
                            <select id="departmentFilter">
                                <option value="">All Departments</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Date Range</label>
                            <select id="dateRangeFilter">
                                <option value="today">Today</option>
                                <option value="yesterday">Yesterday</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="quarter">This Quarter</option>
                                <option value="year">This Year</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        <div class="filter-group" id="customDateGroup" style="display: none;">
                            <label>From Date</label>
                            <input type="date" id="startDate">
                        </div>
                        <div class="filter-group" id="customDateGroup2" style="display: none;">
                            <label>To Date</label>
                            <input type="date" id="endDate">
                        </div>
                        <div class="filter-group">
                            <label>Satisfaction Level</label>
                            <select id="satisfactionFilter">
                                <option value="">All Ratings</option>
                                <option value="low">Low (1-2)</option>
                                <option value="medium">Medium (3)</option>
                                <option value="high">High (4-5)</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-header">
                        <h3>All Survey Responses</h3>
                        <div class="table-actions">
                            <div class="export-dropdown">
                                <button class="btn btn-success btn-sm" onclick="toggleExportDropdown(this)">üì• Export Data ‚ñº</button>
                                <div class="export-dropdown-content">
                                    <a href="#" onclick="exportSurveys('excel')">üìä Excel Report (Multi-Sheet)</a>
                                    <a href="#" onclick="exportSurveys('csv')">üìã CSV Data</a>
                                    <a href="#" onclick="exportSurveys('pdf')">üìÑ PDF Report</a>
                                    <a href="#" onclick="exportSurveys('json')">üîß JSON Data</a>
                                    <hr style="margin: 5px 0;">
                                    <a href="#" onclick="exportCustomRange()">üìÖ Custom Date Range</a>
                                    <a href="#" onclick="exportAnalytics()">üìà Analytics Report</a>
                                </div>
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="loadSurveysData()">üîÑ Refresh</button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Survey ID</th>
                                <th>Patient Name</th>
                                <th>Email</th>
                                <th>Department</th>
                                <th>Overall Rating</th>
                                <th>Visit Date</th>
                                <th>Follow-up</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="allSurveysTable">
                            <tr>
                                <td colspan="8" class="loading">
                                    <div class="spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics" class="tab-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="totalResponsesMetric">0</h3>
                        <p>Total Responses (30 days)</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="avgOverallMetric">0.0</h3>
                        <p>Average Overall Rating</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="satisfactionRateMetric">0%</h3>
                        <p>Satisfaction Rate (4-5)</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="responseRateMetric">0%</h3>
                        <p>Follow-up Request Rate</p>
                    </div>
                </div>

                <div class="chart-grid">
                    <div class="chart-container">
                        <h3>Satisfaction Trends (Last 7 Days)</h3>
                        <canvas id="satisfactionChart" width="400" height="200"></canvas>
                    </div>

                    <div class="chart-container">
                        <h3>Department Performance</h3>
                        <canvas id="departmentChart" width="400" height="200"></canvas>
                    </div>

                    <div class="chart-container">
                        <h3>Wait Time Distribution</h3>
                        <canvas id="waitTimeChart" width="400" height="200"></canvas>
                    </div>

                    <div class="chart-container">
                        <h3>Rating Distribution</h3>
                        <canvas id="ratingChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>

            <!-- Follow-ups Tab -->
            <div id="follow-ups" class="tab-content">
                <div class="table-container">
                    <div class="table-header">
                        <h3>Follow-up Tasks</h3>
                        <div class="table-actions">
                            <button class="btn btn-primary btn-sm" onclick="loadFollowUpsData()">üîÑ Refresh</button>
                            <div class="export-dropdown">
                                <button class="btn btn-success btn-sm" onclick="toggleExportDropdown(this)">üì• Export Tasks ‚ñº</button>
                                <div class="export-dropdown-content">
                                    <a href="#" onclick="exportFollowUps('excel')">üìä Excel Report</a>
                                    <a href="#" onclick="exportFollowUps('csv')">üìã CSV Data</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Patient</th>
                                <th>Contact Method</th>
                                <th>Priority</th>
                                <th>Assigned To</th>
                                <th>Status</th>
                                <th>Survey Rating</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="followUpsTable">
                            <tr>
                                <td colspan="8" class="loading">
                                    <div class="spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="users" class="tab-content">
                <div class="table-container">
                    <div class="table-header">
                        <h3>Admin Users</h3>
                        <div class="table-actions">
                            <button class="btn btn-secondary btn-sm" onclick="loadUsersData()">üîÑ Refresh</button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Department</th>
                                <th>Last Login</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable">
                            <tr>
                                <td colspan="7" class="loading">
                                    <div class="spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <div class="table-container">
                    <div class="table-header">
                        <h3>System Settings</h3>
                        <div class="table-actions">
                            <button class="btn btn-success btn-sm" onclick="saveSettings()">üíæ Save Changes</button>
                        </div>
                    </div>
                    <div style="padding: 25px;">
                        <div class="filters-grid">
                            <div class="filter-group">
                                <label>Survey Auto-restart Time (seconds)</label>
                                <input type="number" id="autoRestartTime" value="30" min="10" max="300">
                            </div>
                            <div class="filter-group">
                                <label>Survey Idle Timeout (seconds)</label>
                                <input type="number" id="idleTimeout" value="300" min="60" max="1800">
                            </div>
                            <div class="filter-group">
                                <label>Dashboard Refresh Interval (seconds)</label>
                                <input type="number" id="dashboardRefresh" value="300" min="30" max="1800">
                            </div>
                            <div class="filter-group">
                                <label>Low Rating Threshold (1-5)</label>
                                <input type="number" id="lowRatingThreshold" value="2" min="1" max="4">
                            </div>
                            <div class="filter-group">
                                <label>Max Follow-up Attempts</label>
                                <input type="number" id="maxFollowUpAttempts" value="3" min="1" max="10">
                            </div>
                            <div class="filter-group">
                                <label>Email Notifications</label>
                                <select id="emailNotifications">
                                    <option value="true">Enabled</option>
                                    <option value="false">Disabled</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Survey Detail Modal -->
    <div id="surveyModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeSurveyModal()">&times;</span>
            <h2>Survey Details</h2>
            <div id="surveyDetails"></div>
        </div>
    </div>

    <!-- Follow-up Task Modal -->
    <div id="followUpModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeFollowUpModal()">&times;</span>
            <h2>Follow-up Task</h2>
            <div id="followUpDetails"></div>
        </div>
    </div>

    <script>
        // üîß SUPABASE CONFIGURATION  
        const SUPABASE_CONFIG = {
            url: 'https://haeephlyfcoxrioohhjj.supabase.co',
            anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhhZWVwaGx5ZmNveHJpb29oaGpqIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MTQ4MTgwOSwiZXhwIjoyMDY3MDU3ODA5fQ.srXbETt6h-zFXuW41b_fKFZTlRquNOCS1I_nwKZIyhY'
        };

        const ADMIN_CODE = '5865'; // Admin access code for registration

        class AdminDashboard {
            constructor() {
                this.supabase = null;
                this.currentUser = null;
                this.currentAdminUser = null;
                this.charts = {};
                this.filteredData = [];
                this.currentFilters = {};
                this.init();
            }

            init() {
                try {
                    this.initSupabase();
                    this.setupEventListeners();
                    this.checkAuthStatus();
                } catch (error) {
                    console.error('‚ùå Initialization error:', error);
                    this.showError('Failed to initialize dashboard. Please refresh the page.');
                }
            }

            initSupabase() {
                try {
                    if (typeof supabase !== 'undefined') {
                        this.supabase = supabase.createClient(
                            SUPABASE_CONFIG.url,
                            SUPABASE_CONFIG.anonKey
                        );
                        console.log('‚úÖ Supabase initialized');
                    } else {
                        console.error('‚ùå Supabase client not loaded');
                        this.showError('Supabase client not available. Please check your configuration.');
                    }
                } catch (error) {
                    console.error('‚ùå Supabase initialization error:', error);
                    this.showError('Failed to initialize Supabase connection.');
                }
            }

            setupEventListeners() {
                // Login form
                const loginForm = document.getElementById('loginForm');
                if (loginForm) {
                    loginForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleLogin();
                    });
                }

                // Register form
                const registerForm = document.getElementById('registerForm');
                if (registerForm) {
                    registerForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleRegister();
                    });
                }

                // Logout button
                const logoutBtn = document.getElementById('logoutBtn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', () => this.handleLogout());
                }

                // Tab navigation
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.addEventListener('click', () => this.switchTab(tab.dataset.tab));
                });

                // Filter change handlers
                const dateRangeFilter = document.getElementById('dateRangeFilter');
                if (dateRangeFilter) {
                    dateRangeFilter.addEventListener('change', this.handleDateRangeChange.bind(this));
                }

                // Auto-refresh dashboard data every 5 minutes
                setInterval(() => {
                    if (this.currentUser) {
                        this.refreshData();
                    }
                }, 300000);
            }

            async checkAuthStatus() {
                try {
                    if (!this.supabase) {
                        this.showAuth();
                        return;
                    }

                    const { data: { session }, error } = await this.supabase.auth.getSession();
                    
                    if (error) {
                        console.error('‚ùå Auth session error:', error);
                        this.showAuth();
                        return;
                    }
                    
                    if (session) {
                        console.log('‚úÖ Active session found:', session.user.email);
                        await this.handleAuthSuccess(session.user);
                    } else {
                        console.log('‚ÑπÔ∏è No active session, showing auth');
                        this.showAuth();
                    }
                } catch (error) {
                    console.error('‚ùå Auth check error:', error);
                    this.showAuth();
                    this.showError(`Authentication check failed: ${error.message}`);
                }
            }

            async handleLogin() {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                const errorDiv = document.getElementById('authError');
                const submitBtn = document.querySelector('#loginForm button[type="submit"]');

                try {
                    this.hideMessages();
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Signing In...';

                    const { data, error } = await this.supabase.auth.signInWithPassword({
                        email,
                        password
                    });

                    if (error) throw error;

                    await this.handleAuthSuccess(data.user);
                } catch (error) {
                    console.error('‚ùå Login error:', error);
                    this.showError(error.message || 'Login failed. Please try again.');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Sign In';
                }
            }

            async handleRegister() {
                const name = document.getElementById('registerName').value;
                const email = document.getElementById('registerEmail').value;
                const password = document.getElementById('registerPassword').value;
                const department = document.getElementById('registerDepartment').value;
                const adminCode = document.getElementById('adminCode').value;
                const submitBtn = document.querySelector('#registerForm button[type="submit"]');

                try {
                    this.hideMessages();
                    
                    // Validate admin code
                    if (adminCode !== ADMIN_CODE) {
                        throw new Error('Invalid admin access code. Please contact your system administrator.');
                    }

                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Creating Account...';

                    // Create user account with admin metadata
                    const { data, error } = await this.supabase.auth.signUp({
                        email,
                        password,  // User's chosen password
                        options: {
                            data: {
                                full_name: name,
                                department: department,
                                admin_code: adminCode,  // This marks them as admin
                                is_admin: true
                            }
                        }
                    });

                    if (error) throw error;

                    if (data.user) {
                        console.log('‚úÖ User created, now creating admin record...');
                        
                        // Wait a moment for the user to be fully created
                        await new Promise(resolve => setTimeout(resolve, 2000));

                        // Create admin user record manually (more reliable than trigger)
                        try {
                            // Check if admin record already exists (trigger might have worked)
                            const { data: existingAdmin } = await this.supabase
                                .from('admin_users')
                                .select('id')
                                .eq('user_id', data.user.id)
                                .maybeSingle();

                            if (!existingAdmin) {
                                console.log('üîß No admin record found, creating manually...');
                                
                                // Check if this would be the first super_admin
                                const { data: existingSuperAdmins } = await this.supabase
                                    .from('admin_users')
                                    .select('id')
                                    .eq('role', 'super_admin')
                                    .eq('is_active', true);

                                const role = (!existingSuperAdmins || existingSuperAdmins.length === 0) ? 'super_admin' : 'admin';

                                // Use a function call to bypass RLS restrictions
                                const { data: functionResult, error: functionError } = await this.supabase
                                    .rpc('create_admin_user_manual', {
                                        p_user_id: data.user.id,
                                        p_full_name: name,
                                        p_email: email,
                                        p_department: department,
                                        p_role: role
                                    });

                                if (functionError) {
                                    console.error('‚ùå Function error:', functionError);
                                    console.log('üîß Function failed, trying direct insert...');
                                    
                                    // Fallback: try direct insert (will work if RLS allows)
                                    const { error: insertError } = await this.supabase
                                        .from('admin_users')
                                        .insert({
                                            user_id: data.user.id,
                                            full_name: name,
                                            email: email,
                                            role: role,
                                            department: department,
                                            is_active: true
                                        });

                                    if (insertError) {
                                        console.error('‚ùå Direct insert also failed:', insertError);
                                        throw new Error('Admin account created but setup incomplete. Please contact your system administrator to complete the setup.');
                                    }
                                }
                                
                                console.log('‚úÖ Admin record created successfully');
                            } else {
                                console.log('‚úÖ Admin record already exists (trigger worked)');
                            }

                            this.showSuccess(`üéâ Admin account created successfully! You can now sign in with your email and the password you created.`);
                            
                            // Clear only the register form on successful registration
                            this.clearAuthForms(false, true); // Don't clear login, do clear register
                            
                        } catch (adminError) {
                            console.error('‚ùå Admin creation error:', adminError);
                            this.showSuccess(`Account created, but admin setup needs completion. Please contact your system administrator. You can try signing in - it might work.`);
                        }
                        
                        // Switch to login tab after success
                        setTimeout(() => {
                            switchAuthTab('login');
                            // Pre-fill email in login form for convenience
                            document.getElementById('loginEmail').value = email;
                        }, 3000);
                    }

                } catch (error) {
                    console.error('‚ùå Registration error:', error);
                    this.showError(error.message || 'Registration failed. Please try again.');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Create Account';
                }
            }

            async handleAuthSuccess(user) {
                try {
                    this.currentUser = user;
                    console.log('üîç Checking admin user for:', user.email);

                    // Get admin user details with simplified query to avoid RLS recursion
                    const { data: adminUser, error } = await this.supabase
                        .from('admin_users')
                        .select('*')
                        .eq('user_id', user.id)
                        .maybeSingle();

                    if (error) {
                        console.error('‚ùå Error querying admin_users:', error);
                        throw new Error(`Database error: ${error.message}`);
                    }

                    if (!adminUser) {
                        console.warn('‚ö†Ô∏è Admin user record not found for:', user.email);
                        
                        // Check if user signed up recently and admin record creation might have failed
                        const userCreatedAt = new Date(user.created_at);
                        const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
                        
                        if (userCreatedAt > fiveMinutesAgo) {
                            // Recent signup - trigger might have failed
                            throw new Error('Admin account setup incomplete. The automatic setup may have failed. Please contact your system administrator to complete your admin setup.');
                        } else {
                            throw new Error('Admin access denied. Your account does not have administrative privileges. Please contact your system administrator.');
                        }
                    }

                    if (!adminUser.is_active) {
                        throw new Error('Your admin account has been disabled. Please contact your system administrator.');
                    }

                    this.currentAdminUser = adminUser;
                    console.log('‚úÖ Admin user found:', adminUser.full_name, `(${adminUser.role})`);

                    // Update last login (this might fail due to RLS, but that's okay)
                    try {
                        await this.supabase
                            .from('admin_users')
                            .update({ last_login: new Date().toISOString() })
                            .eq('id', this.currentAdminUser.id);
                    } catch (updateError) {
                        console.warn('Could not update last login (RLS restriction):', updateError);
                    }

                    // Log activity (this might fail due to RLS, but that's okay)
                    try {
                        await this.logActivity('login', 'auth', null, { 
                            login_time: new Date().toISOString(),
                            user_agent: navigator.userAgent
                        });
                    } catch (logError) {
                        console.warn('Could not log activity (RLS restriction):', logError);
                    }

                    this.showDashboard();
                    await this.loadDashboardData();
                    
                    // Clear both forms on successful login
                    this.clearAuthForms(true, true);
                } catch (error) {
                    console.error('‚ùå Auth success handling error:', error);
                    this.showError(error.message);
                    if (this.supabase) {
                        await this.supabase.auth.signOut();
                    }
                    this.showAuth();
                }
            }

            async handleLogout() {
                try {
                    await this.logActivity('logout', 'auth');
                    await this.supabase.auth.signOut();
                    
                    this.currentUser = null;
                    this.currentAdminUser = null;
                    this.showAuth();
                    
                    // Clear forms after logout for security
                    this.clearAuthForms(true, true);
                } catch (error) {
                    console.error('‚ùå Logout error:', error);
                }
            }

            showAuth() {
                document.getElementById('authScreen').style.display = 'flex';
                document.getElementById('dashboard').classList.remove('active');
            }

            showDashboard() {
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('dashboard').classList.add('active');
                
                // Update user info
                document.getElementById('userName').textContent = this.currentAdminUser.full_name;
                document.getElementById('userRole').textContent = this.currentAdminUser.role.replace('_', ' ').toUpperCase();
            }

            switchTab(tabName) {
                // Update tab buttons
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

                // Update tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabName).classList.add('active');

                // Load tab-specific data
                this.loadTabData(tabName);
            }

            async loadTabData(tabName) {
                try {
                    switch (tabName) {
                        case 'overview':
                            await this.loadOverviewData();
                            break;
                        case 'surveys':
                            await this.loadSurveysData();
                            break;
                        case 'analytics':
                            await this.loadAnalyticsData();
                            break;
                        case 'follow-ups':
                            await this.loadFollowUpsData();
                            break;
                        case 'users':
                            await this.loadUsersData();
                            break;
                        case 'settings':
                            await this.loadSettingsData();
                            break;
                    }
                } catch (error) {
                    console.error(`‚ùå Error loading ${tabName} data:`, error);
                    this.showError(`Failed to load ${tabName} data`);
                }
            }

            async loadDashboardData() {
                await this.loadOverviewData();
                await this.populateFilterOptions();
            }

            async loadOverviewData() {
                try {
                    console.log('üîÑ Loading overview data...');
                    
                    // Get today's date range
                    const today = new Date();
                    const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                    const endOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1);

                    // Get today's surveys using created_at (more reliable than visit_date)
                    const { data: todaySurveys, error: todayError } = await this.supabase
                        .from('patient_survey_responses')
                        .select('*')
                        .gte('created_at', startOfDay.toISOString())
                        .lt('created_at', endOfDay.toISOString());

                    if (todayError) {
                        console.error('‚ùå Error fetching today surveys:', todayError);
                        throw todayError;
                    }

                    console.log('üìä Today surveys:', todaySurveys?.length || 0);

                    // Get all surveys for averages (last 7 days)
                    const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                    const { data: allSurveys, error: allError } = await this.supabase
                        .from('patient_survey_responses')
                        .select('*')
                        .gte('created_at', sevenDaysAgo.toISOString());

                    if (allError) {
                        console.error('‚ùå Error fetching all surveys:', allError);
                        // Continue with today's data only
                    }

                    const surveysForStats = allSurveys || todaySurveys || [];
                    console.log('üìä Surveys for stats:', surveysForStats.length);

                    // Calculate stats
                    const totalSurveys = todaySurveys?.length || 0;
                    
                    // Calculate average satisfaction
                    const validRatings = surveysForStats.filter(s => {
                        const rating = s.experience_data?.overall_satisfaction;
                        return rating && !isNaN(parseInt(rating));
                    });
                    
                    const avgSatisfaction = validRatings.length > 0 
                        ? (validRatings.reduce((sum, s) => sum + parseInt(s.experience_data.overall_satisfaction), 0) / validRatings.length).toFixed(1)
                        : '0.0';
                    
                    // Calculate low satisfaction (‚â§2)
                    const lowSatisfaction = validRatings.filter(s => 
                        parseInt(s.experience_data.overall_satisfaction) <= 2
                    ).length;

                    console.log('üìä Stats calculated:', { totalSurveys, avgSatisfaction, lowSatisfaction });

                    // Get pending follow-ups
                    const { data: followUps, error: followUpError } = await this.supabase
                        .from('follow_up_tasks')
                        .select('*')
                        .eq('status', 'pending');

                    if (followUpError) {
                        console.error('‚ùå Error fetching follow-ups:', followUpError);
                    }

                    const pendingFollowUps = followUps?.length || 0;
                    console.log('üìä Pending follow-ups:', pendingFollowUps);

                    // Update stats in UI
                    document.getElementById('totalSurveys').textContent = totalSurveys;
                    document.getElementById('avgSatisfaction').textContent = avgSatisfaction;
                    document.getElementById('pendingFollowUps').textContent = pendingFollowUps;
                    document.getElementById('lowSatisfaction').textContent = lowSatisfaction;

                    // Calculate and show trends
                    this.updateTrends(totalSurveys, avgSatisfaction, pendingFollowUps, lowSatisfaction);

                    // Load recent surveys table
                    await this.loadRecentSurveys();

                } catch (error) {
                    console.error('‚ùå Error loading overview data:', error);
                    this.showError('Failed to load dashboard data: ' + error.message);
                    
                    // Set fallback values
                    document.getElementById('totalSurveys').textContent = '0';
                    document.getElementById('avgSatisfaction').textContent = '0.0';
                    document.getElementById('pendingFollowUps').textContent = '0';
                    document.getElementById('lowSatisfaction').textContent = '0';
                }
            }

            updateTrends(totalSurveys, avgSatisfaction, pendingFollowUps, lowSatisfaction) {
                // Update trends with meaningful messages
                document.getElementById('surveyTrend').textContent = totalSurveys > 0 
                    ? `${totalSurveys} surveys submitted today` 
                    : 'No surveys today yet';
                    
                document.getElementById('satisfactionTrend').textContent = avgSatisfaction !== '0.0' 
                    ? `Average over last 7 days` 
                    : 'No rating data yet';
                    
                document.getElementById('followUpTrend').textContent = pendingFollowUps > 0 
                    ? `${pendingFollowUps} tasks need attention` 
                    : 'All caught up!';
                    
                document.getElementById('lowSatTrend').textContent = lowSatisfaction > 0 
                    ? `${lowSatisfaction} need attention` 
                    : 'Great job!';
            }

            async loadRecentSurveys() {
                try {
                    console.log('üîÑ Loading recent surveys...');
                    
                    const { data: surveys, error } = await this.supabase
                        .from('patient_survey_responses')
                        .select('*')
                        .order('created_at', { ascending: false })
                        .limit(10);

                    if (error) {
                        console.error('‚ùå Error fetching recent surveys:', error);
                        throw error;
                    }

                    console.log('üìä Recent surveys fetched:', surveys?.length || 0);
                    
                    const tableBody = document.getElementById('recentSurveysTable');
                    
                    if (!surveys || surveys.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #64748b;">No surveys found</td></tr>';
                        return;
                    }

                    tableBody.innerHTML = surveys.map(survey => {
                        const patientName = survey.patient_info?.full_name || 'N/A';
                        const department = survey.patient_info?.department_visited || 'N/A';
                        const overallRating = survey.experience_data?.overall_satisfaction || 'N/A';
                        const visitDate = survey.patient_info?.visit_date || 'N/A';
                        const submittedDate = new Date(survey.created_at).toLocaleDateString();
                        
                        return `
                            <tr>
                                <td>${patientName}</td>
                                <td>${department}</td>
                                <td>
                                    <span class="status-badge ${this.getSatisfactionClass(overallRating)}">
                                        ${overallRating}/5
                                    </span>
                                </td>
                                <td>${visitDate}</td>
                                <td>${submittedDate}</td>
                                <td>
                                    <span class="status-badge status-completed">Submitted</span>
                                </td>
                                <td>
                                    <button class="btn btn-primary btn-sm" onclick="viewSurvey('${survey.response_id}')">View</button>
                                </td>
                            </tr>
                        `;
                    }).join('');

                } catch (error) {
                    console.error('‚ùå Error loading recent surveys:', error);
                    document.getElementById('recentSurveysTable').innerHTML = 
                        '<tr><td colspan="7" style="text-align: center; color: #dc2626;">Error loading surveys: ' + error.message + '</td></tr>';
                }
            }

            async populateFilterOptions() {
                try {
                    // Get unique departments from JSONB field
                    const { data: surveys, error } = await this.supabase
                        .from('patient_survey_responses')
                        .select('patient_info')
                        .not('patient_info->department_visited', 'is', null);

                    if (!error && surveys) {
                        const uniqueDepartments = [...new Set(surveys
                            .map(s => s.patient_info?.department_visited)
                            .filter(Boolean)
                        )];
                        
                        const departmentFilter = document.getElementById('departmentFilter');
                        
                        // Clear existing options except "All Departments"
                        while (departmentFilter.children.length > 1) {
                            departmentFilter.removeChild(departmentFilter.lastChild);
                        }
                        
                        uniqueDepartments.forEach(dept => {
                            const option = document.createElement('option');
                            option.value = dept;
                            option.textContent = dept;
                            departmentFilter.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error('‚ùå Error populating filter options:', error);
                }
            }

            getSatisfactionClass(rating) {
                const r = parseInt(rating);
                if (isNaN(r)) return 'status-medium';
                if (r >= 4) return 'status-high';
                if (r === 3) return 'status-medium';
                return 'status-low';
            }

            async loadSurveysData() {
                try {
                    console.log('üîÑ Loading surveys data with filters:', this.currentFilters);
                    
                    // Show loading state
                    document.getElementById('allSurveysTable').innerHTML = 
                        '<tr><td colspan="8" class="loading"><div class="spinner"></div></td></tr>';
                    
                    let query = this.supabase
                        .from('patient_survey_responses')
                        .select('*')
                        .order('created_at', { ascending: false });

                    // Apply current filters
                    query = this.applyFiltersToQuery(query);

                    console.log('üîç Executing query with filters...');
                    const { data: surveys, error } = await query;

                    if (error) {
                        console.error('‚ùå Query error:', error);
                        throw error;
                    }

                    console.log('üìä Surveys loaded:', surveys?.length || 0);
                    this.filteredData = surveys || [];
                    this.renderSurveysTable(this.filteredData);

                    // Update status message
                    if (surveys && surveys.length > 0) {
                        const hasFilters = Object.values(this.currentFilters || {}).some(v => v);
                        if (hasFilters) {
                            console.log('‚úÖ Filtered results:', surveys.length, 'surveys found');
                        }
                    }

                } catch (error) {
                    console.error('‚ùå Error loading surveys data:', error);
                    this.showError('Failed to load surveys data: ' + error.message);
                    
                    // Show error state
                    document.getElementById('allSurveysTable').innerHTML = 
                        `<tr><td colspan="8" style="text-align: center; color: #dc2626;">
                            Error loading surveys: ${error.message}
                            <br><small>Try refreshing or clearing filters</small>
                        </td></tr>`;
                }
            }
            
            renderSurveysTable(surveys) {
                const tableBody = document.getElementById('allSurveysTable');
                
                if (surveys.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #64748b;">No surveys found matching current filters</td></tr>';
                    return;
                }

                tableBody.innerHTML = surveys.map(survey => `
                    <tr>
                        <td title="${survey.response_id}">${survey.response_id.substring(0, 12)}...</td>
                        <td>${survey.patient_info?.full_name || 'N/A'}</td>
                        <td>${survey.patient_info?.email || 'N/A'}</td>
                        <td>${survey.patient_info?.department_visited || 'N/A'}</td>
                        <td>
                            <span class="status-badge ${this.getSatisfactionClass(survey.experience_data?.overall_satisfaction)}">
                                ${survey.experience_data?.overall_satisfaction || 'N/A'}/5
                            </span>
                        </td>
                        <td>${survey.patient_info?.visit_date || 'N/A'}</td>
                        <td>
                            <span class="status-badge ${survey.contact_preferences?.wants_contact === 'yes' ? 'status-pending' : 'status-completed'}">
                                ${survey.contact_preferences?.wants_contact === 'yes' ? 'Yes' : 'No'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="viewSurvey('${survey.response_id}')">View</button>
                        </td>
                    </tr>
                `).join('');
            }

            applyFiltersToQuery(query) {
                console.log('üîç Applying filters:', this.currentFilters);

                // Apply department filter using JSONB operator
                if (this.currentFilters.department) {
                    console.log('üè• Department filter:', this.currentFilters.department);
                    query = query.eq('patient_info->>department_visited', this.currentFilters.department);
                }

                // Apply date range filter using created_at (more reliable than JSONB visit_date)
                if (this.currentFilters.dateRange && this.currentFilters.dateRange !== 'custom') {
                    const { startDate, endDate } = this.getDateRange(this.currentFilters.dateRange);
                    if (startDate && endDate) {
                        console.log('üìÖ Date range filter:', startDate, 'to', endDate);
                        // Convert visit_date to comparison with created_at
                        const startDateTime = new Date(startDate + 'T00:00:00').toISOString();
                        const endDateTime = new Date(endDate + 'T23:59:59').toISOString();
                        query = query
                            .gte('created_at', startDateTime)
                            .lte('created_at', endDateTime);
                    }
                }

                // Apply custom date range
                if (this.currentFilters.startDate && this.currentFilters.endDate) {
                    console.log('üìÖ Custom date range:', this.currentFilters.startDate, 'to', this.currentFilters.endDate);
                    const startDateTime = new Date(this.currentFilters.startDate + 'T00:00:00').toISOString();
                    const endDateTime = new Date(this.currentFilters.endDate + 'T23:59:59').toISOString();
                    query = query
                        .gte('created_at', startDateTime)
                        .lte('created_at', endDateTime);
                }

                // Apply satisfaction filter using JSONB operator with ->> for text comparison
                if (this.currentFilters.satisfaction) {
                    console.log('‚≠ê Satisfaction filter:', this.currentFilters.satisfaction);
                    switch (this.currentFilters.satisfaction) {
                        case 'low':
                            query = query.in('experience_data->>overall_satisfaction', ['1', '2']);
                            break;
                        case 'medium':
                            query = query.eq('experience_data->>overall_satisfaction', '3');
                            break;
                        case 'high':
                            query = query.in('experience_data->>overall_satisfaction', ['4', '5']);
                            break;
                    }
                }

                return query;
            }

            getDateRange(range) {
                const today = new Date();
                let startDate, endDate;

                switch (range) {
                    case 'today':
                        startDate = endDate = today.toISOString().split('T')[0];
                        break;
                    case 'yesterday':
                        const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
                        startDate = endDate = yesterday.toISOString().split('T')[0];
                        break;
                    case 'week':
                        const weekStart = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                        startDate = weekStart.toISOString().split('T')[0];
                        endDate = today.toISOString().split('T')[0];
                        break;
                    case 'month':
                        const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                        startDate = monthStart.toISOString().split('T')[0];
                        endDate = today.toISOString().split('T')[0];
                        break;
                    case 'quarter':
                        const quarterStart = new Date(today.getFullYear(), Math.floor(today.getMonth() / 3) * 3, 1);
                        startDate = quarterStart.toISOString().split('T')[0];
                        endDate = today.toISOString().split('T')[0];
                        break;
                    case 'year':
                        const yearStart = new Date(today.getFullYear(), 0, 1);
                        startDate = yearStart.toISOString().split('T')[0];
                        endDate = today.toISOString().split('T')[0];
                        break;
                }

                console.log('üìÖ Date range calculated:', { range, startDate, endDate });
                return { startDate, endDate };
            }
            
            async loadAnalyticsData() {
                try {
                    await this.updateAnalyticsMetrics();
                    await this.createSatisfactionTrendChart();
                    await this.createDepartmentPerformanceChart();
                    await this.createWaitTimeChart();
                    await this.createRatingDistributionChart();
                } catch (error) {
                    console.error('‚ùå Error loading analytics data:', error);
                    this.showError('Failed to load analytics data');
                }
            }

            async updateAnalyticsMetrics() {
                try {
                    // Get last 30 days of surveys
                    const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
                    
                    const { data: surveys, error } = await this.supabase
                        .from('patient_survey_responses')
                        .select('*')
                        .gte('created_at', thirtyDaysAgo.toISOString());

                    if (error) throw error;

                    const totalResponses = surveys.length;
                    const validRatings = surveys.filter(s => s.experience_data?.overall_satisfaction);
                    
                    const avgOverall = validRatings.length > 0 
                        ? (validRatings.reduce((sum, s) => sum + parseInt(s.experience_data.overall_satisfaction), 0) / validRatings.length).toFixed(1)
                        : '0.0';
                    
                    const satisfactionRate = validRatings.length > 0 
                        ? Math.round((validRatings.filter(s => parseInt(s.experience_data.overall_satisfaction) >= 4).length / validRatings.length) * 100)
                        : 0;
                    
                    const responseRate = surveys.length > 0 
                        ? Math.round((surveys.filter(s => s.contact_preferences?.wants_contact === 'yes').length / surveys.length) * 100)
                        : 0;

                    // Update metrics
                    document.getElementById('totalResponsesMetric').textContent = totalResponses;
                    document.getElementById('avgOverallMetric').textContent = avgOverall;
                    document.getElementById('satisfactionRateMetric').textContent = satisfactionRate + '%';
                    document.getElementById('responseRateMetric').textContent = responseRate + '%';

                } catch (error) {
                    console.error('‚ùå Error updating analytics metrics:', error);
                    // Set default values
                    document.getElementById('totalResponsesMetric').textContent = '0';
                    document.getElementById('avgOverallMetric').textContent = '0.0';
                    document.getElementById('satisfactionRateMetric').textContent = '0%';
                    document.getElementById('responseRateMetric').textContent = '0%';
                }
            }

            async createSatisfactionTrendChart() {
                const ctx = document.getElementById('satisfactionChart');
                if (!ctx) return;

                try {
                    // Clear existing chart
                    if (this.charts.satisfaction) {
                        this.charts.satisfaction.destroy();
                    }

                    // Get last 7 days of data
                    const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                    
                    const { data: surveys, error } = await this.supabase
                        .from('patient_survey_responses')
                        .select('*')
                        .gte('created_at', sevenDaysAgo.toISOString())
                        .order('created_at', { ascending: true });

                    if (error) throw error;

                    // Group by day
                    const dailyData = {};
                    const last7Days = [];
                    for (let i = 6; i >= 0; i--) {
                        const date = new Date();
                        date.setDate(date.getDate() - i);
                        const dateStr = date.toISOString().split('T')[0];
                        last7Days.push(dateStr);
                        dailyData[dateStr] = [];
                    }

                    surveys.forEach(survey => {
                        const visitDate = survey.patient_info?.visit_date;
                        if (visitDate && dailyData[visitDate] && survey.experience_data?.overall_satisfaction) {
                            dailyData[visitDate].push(parseInt(survey.experience_data.overall_satisfaction));
                        }
                    });

                    const chartData = last7Days.map(date => {
                        const ratings = dailyData[date];
                        return ratings.length > 0 
                            ? (ratings.reduce((sum, r) => sum + r, 0) / ratings.length).toFixed(1)
                            : null;
                    });

                    const labels = last7Days.map(date => {
                        const d = new Date(date);
                        return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                    });

                    this.charts.satisfaction = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Average Satisfaction',
                                data: chartData,
                                borderColor: '#2c5aa0',
                                backgroundColor: 'rgba(44, 90, 160, 0.1)',
                                tension: 0.4,
                                fill: true,
                                spanGaps: true
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 5,
                                    ticks: {
                                        stepSize: 1
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: true
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error('‚ùå Error creating satisfaction trend chart:', error);
                }
            }

            async createDepartmentPerformanceChart() {
                const ctx = document.getElementById('departmentChart');
                if (!ctx) return;

                try {
                    // Clear existing chart
                    if (this.charts.department) {
                        this.charts.department.destroy();
                    }

                    const { data: surveys, error } = await this.supabase
                        .from('patient_survey_responses')
                        .select('*')
                        .gte('created_at', new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString());

                    if (error) throw error;

                    // Group by department
                    const deptData = {};
                    surveys.forEach(survey => {
                        const dept = survey.patient_info?.department_visited;
                        const rating = survey.experience_data?.overall_satisfaction;
                        if (dept && rating) {
                            if (!deptData[dept]) deptData[dept] = [];
                            deptData[dept].push(parseInt(rating));
                        }
                    });

                    const departments = Object.keys(deptData).slice(0, 8); // Top 8 departments
                    const data = departments.map(dept => {
                        const ratings = deptData[dept];
                        return ratings.length > 0 
                            ? (ratings.reduce((sum, r) => sum + r, 0) / ratings.length).toFixed(1)
                            : 0;
                    });

                    const colors = [
                        '#10b981', '#f59e0b', '#3b82f6', '#ef4444', 
                        '#8b5cf6', '#06b6d4', '#84cc16', '#f97316'
                    ];

                    this.charts.department = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: departments.map(dept => dept.length > 15 ? dept.substring(0, 15) + '...' : dept),
                            datasets: [{
                                label: 'Average Rating',
                                data: data,
                                backgroundColor: colors.slice(0, departments.length)
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: { 
                                y: { 
                                    beginAtZero: true, 
                                    max: 5,
                                    ticks: {
                                        stepSize: 1
                                    }
                                } 
                            },
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error('‚ùå Error creating department chart:', error);
                }
            }

            async createWaitTimeChart() {
                const ctx = document.getElementById('waitTimeChart');
                if (!ctx) return;

                try {
                    // Clear existing chart
                    if (this.charts.waitTime) {
                        this.charts.waitTime.destroy();
                    }

                    const { data: surveys, error } = await this.supabase
                        .from('patient_survey_responses')
                        .select('experience_data')
                        .gte('created_at', new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString());

                    if (error) throw error;

                    const waitTimes = [
                        '0-5 minutes', '6-10 minutes', '11-15 minutes', 
                        '16-30 minutes', '31-45 minutes', '46-60 minutes', 
                        'More than 1 hour'
                    ];
                    
                    const counts = waitTimes.map(time => 
                        surveys.filter(s => s.experience_data?.wait_time_actual === time).length
                    );

                    this.charts.waitTime = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: waitTimes,
                            datasets: [{
                                data: counts,
                                backgroundColor: [
                                    '#10b981', '#22c55e', '#84cc16', 
                                    '#f59e0b', '#ef4444', '#dc2626', '#991b1b'
                                ]
                            }]
                        },
                        options: { 
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error('‚ùå Error creating wait time chart:', error);
                }
            }

            async createRatingDistributionChart() {
                const ctx = document.getElementById('ratingChart');
                if (!ctx) return;

                try {
                    // Clear existing chart
                    if (this.charts.rating) {
                        this.charts.rating.destroy();
                    }

                    const { data: surveys, error } = await this.supabase
                        .from('patient_survey_responses')
                        .select('experience_data')
                        .gte('created_at', new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString());

                    if (error) throw error;

                    const ratingCounts = [1, 2, 3, 4, 5].map(rating => 
                        surveys.filter(s => parseInt(s.experience_data?.overall_satisfaction) === rating).length
                    );

                    this.charts.rating = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['1 Star', '2 Stars', '3 Stars', '4 Stars', '5 Stars'],
                            datasets: [{
                                label: 'Number of Responses',
                                data: ratingCounts,
                                backgroundColor: '#2c5aa0'
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: { 
                                y: { 
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    }
                                } 
                            },
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error('‚ùå Error creating rating distribution chart:', error);
                }
            }

            async loadFollowUpsData() {
                try {
                    const { data: followUps, error } = await this.supabase
                        .from('follow_up_tasks')
                        .select(`
                            *,
                            admin_users!follow_up_tasks_assigned_to_fkey(full_name)
                        `)
                        .order('created_at', { ascending: false });

                    if (error) throw error;

                    this.renderFollowUpsTable(followUps);

                } catch (error) {
                    console.error('‚ùå Error loading follow-ups data:', error);
                    this.showError('Failed to load follow-ups data');
                }
            }

            renderFollowUpsTable(followUps) {
                const tableBody = document.getElementById('followUpsTable');
                
                if (followUps.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #64748b;">No follow-up tasks found</td></tr>';
                    return;
                }

                tableBody.innerHTML = followUps.map(followUp => `
                    <tr>
                        <td>${followUp.patient_name}</td>
                        <td>
                            <span class="status-badge ${followUp.contact_method === 'email' ? 'status-medium' : followUp.contact_method === 'phone' ? 'status-low' : 'status-high'}">
                                ${followUp.contact_method}
                            </span>
                        </td>
                        <td>
                            <span class="status-badge ${this.getPriorityClass(followUp.priority)}">
                                ${followUp.priority.toUpperCase()}
                            </span>
                        </td>
                        <td>${followUp.admin_users?.full_name || 'Unassigned'}</td>
                        <td>
                            <span class="status-badge status-${followUp.status}">
                                ${followUp.status.replace('_', ' ')}
                            </span>
                        </td>
                        <td title="${followUp.notes || ''}">${followUp.notes ? followUp.notes.substring(0, 30) + '...' : 'No notes'}</td>
                        <td>${new Date(followUp.created_at).toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="viewFollowUp('${followUp.id}')">View</button>
                            ${followUp.status === 'pending' ? 
                                `<button class="btn btn-success btn-sm" onclick="completeFollowUp('${followUp.id}')">Complete</button>` : ''
                            }
                            <button class="btn btn-danger btn-sm" onclick="removeFollowUp('${followUp.id}', '${followUp.patient_name.replace(/'/g, "\\'")}')">Remove</button>
                        </td>
                    </tr>
                `).join('');
            }

            // Add priority class helper
            getPriorityClass(priority) {
                switch(priority) {
                    case 'urgent': return 'status-high';
                    case 'high': return 'status-medium'; 
                    case 'medium': return 'status-low';
                    case 'low': return 'status-completed';
                    default: return 'status-medium';
                }
            }

            async loadUsersData() {
                try {
                    console.log('üë• Loading users data...');
                    
                    // Show loading state
                    document.getElementById('usersTable').innerHTML = 
                        '<tr><td colspan="7" class="loading"><div class="spinner"></div></td></tr>';

                    // Try multiple approaches to get user data
                    let users = null;
                    let error = null;

                    // Approach 1: Try normal query
                    try {
                        const { data, error: queryError } = await this.supabase
                            .from('admin_users')
                            .select('*')
                            .order('created_at', { ascending: false });
                        
                        if (queryError) throw queryError;
                        users = data;
                        console.log('‚úÖ Normal query succeeded, got', users?.length || 0, 'users');
                    } catch (normalError) {
                        console.warn('‚ö†Ô∏è Normal query failed:', normalError);
                        error = normalError;

                        // Approach 2: Try with view (if created)
                        try {
                            const { data, error: viewError } = await this.supabase
                                .from('admin_users_view')
                                .select('*')
                                .order('created_at', { ascending: false });
                            
                            if (viewError) throw viewError;
                            users = data;
                            console.log('‚úÖ View query succeeded, got', users?.length || 0, 'users');
                            error = null;
                        } catch (viewError) {
                            console.warn('‚ö†Ô∏è View query also failed:', viewError);
                            
                            // Approach 3: Try to get just own user record
                            try {
                                const { data, error: ownError } = await this.supabase
                                    .from('admin_users')
                                    .select('*')
                                    .eq('user_id', this.currentUser.id)
                                    .single();
                                
                                if (ownError) throw ownError;
                                users = [data];
                                console.log('‚úÖ Own user query succeeded');
                                error = null;
                            } catch (ownError) {
                                console.error('‚ùå Even own user query failed:', ownError);
                                error = ownError;
                            }
                        }
                    }

                    if (users) {
                        this.renderUsersTable(users);
                    } else {
                        throw error || new Error('Failed to load users with all methods');
                    }

                } catch (error) {
                    console.error('‚ùå Error loading users data:', error);
                    
                    // Show helpful error message based on error type
                    let errorMessage = 'Failed to load users';
                    if (error.message.includes('infinite recursion')) {
                        errorMessage = 'Database configuration issue. Please check RLS policies.';
                    } else if (error.message.includes('policy')) {
                        errorMessage = 'Permission denied. You may not have access to view users.';
                    } else {
                        errorMessage = `Error: ${error.message}`;
                    }
                    
                    this.showError(errorMessage);
                    
                    document.getElementById('usersTable').innerHTML = 
                        `<tr><td colspan="7" style="text-align: center; color: #dc2626;">
                            ${errorMessage}
                            <br><small>Check browser console for details</small>
                            <br><button class="btn btn-secondary btn-sm" onclick="tryFixUserPermissions()" style="margin-top: 10px;">Try Fix</button>
                        </td></tr>`;
                }
            }
            
            renderUsersTable(users) {
                const tableBody = document.getElementById('usersTable');
                
                if (!users || users.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #64748b;">No users found</td></tr>';
                    return;
                }

                console.log('üë• Rendering users table with', users.length, 'users');
                console.log('üîë Current admin role:', this.currentAdminUser?.role);

                tableBody.innerHTML = users.map(user => {
                    const canManageUser = this.currentAdminUser?.role === 'super_admin' && user.id !== this.currentAdminUser.id;
                    const lastLogin = user.last_login ? new Date(user.last_login).toLocaleDateString() : 'Never';
                    
                    return `
                        <tr>
                            <td>${user.full_name}</td>
                            <td>${user.email}</td>
                            <td>
                                <span class="status-badge ${user.role === 'super_admin' ? 'status-high' : 'status-medium'}">
                                    ${user.role.replace('_', ' ').toUpperCase()}
                                </span>
                            </td>
                            <td>${user.department || '-'}</td>
                            <td>${lastLogin}</td>
                            <td>
                                <span class="status-badge ${user.is_active ? 'status-high' : 'status-low'}">
                                    ${user.is_active ? 'Active' : 'Inactive'}
                                </span>
                            </td>
                            <td>
                                ${canManageUser ? `
                                    <button class="btn ${user.is_active ? 'btn-danger' : 'btn-success'} btn-sm" 
                                            onclick="toggleUserStatus('${user.id}', ${!user.is_active})">
                                        ${user.is_active ? 'üö´ Disable' : '‚úÖ Enable'}
                                    </button>
                                ` : '<span style="color: #64748b; font-size: 12px;">No actions available</span>'}
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            
            async loadSettingsData() {
                try {
                    const { data: settings, error } = await this.supabase
                        .from('system_settings')
                        .select('*');

                    if (error) throw error;

                    // Populate settings form
                    settings.forEach(setting => {
                        const element = document.getElementById(this.settingKeyToElementId(setting.setting_key));
                        if (element) {
                            element.value = setting.setting_value;
                        }
                    });

                } catch (error) {
                    console.error('‚ùå Error loading settings:', error);
                    this.showError('Failed to load settings');
                }
            }

            settingKeyToElementId(key) {
                const mapping = {
                    'survey_auto_restart_time': 'autoRestartTime',
                    'survey_idle_timeout': 'idleTimeout',
                    'dashboard_refresh_interval': 'dashboardRefresh',
                    'low_rating_threshold': 'lowRatingThreshold',
                    'max_follow_up_attempts': 'maxFollowUpAttempts',
                    'email_notifications_enabled': 'emailNotifications'
                };
                return mapping[key] || key;
            }

            handleDateRangeChange() {
                const dateRange = document.getElementById('dateRangeFilter')?.value;
                const customDateGroup = document.getElementById('customDateGroup');
                const customDateGroup2 = document.getElementById('customDateGroup2');

                console.log('üìÖ Date range changed to:', dateRange);

                if (dateRange === 'custom') {
                    if (customDateGroup) customDateGroup.style.display = 'flex';
                    if (customDateGroup2) customDateGroup2.style.display = 'flex';
                } else {
                    if (customDateGroup) customDateGroup.style.display = 'none';
                    if (customDateGroup2) customDateGroup2.style.display = 'none';
                    
                    // Auto-apply filters when not custom
                    setTimeout(() => applyFilters(), 100);
                }
            }

            showError(message) {
                this.showMessage(message, 'error');
            }

            showSuccess(message) {
                this.showMessage(message, 'success');
            }

            showMessage(message, type = 'error') {
                const errorDiv = document.getElementById('authError');
                const successDiv = document.getElementById('authSuccess');
                
                if (type === 'error') {
                    errorDiv.textContent = message;
                    errorDiv.style.display = 'block';
                    successDiv.style.display = 'none';
                } else {
                    successDiv.textContent = message;
                    successDiv.style.display = 'block';
                    errorDiv.style.display = 'none';
                }

                // Auto-hide after 5 seconds
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                    successDiv.style.display = 'none';
                }, 5000);
            }

            clearAuthForms(clearLogin = true, clearRegister = true) {
                // Clear login form
                if (clearLogin) {
                    document.getElementById('loginEmail').value = '';
                    document.getElementById('loginPassword').value = '';
                }
                
                // Clear register form  
                if (clearRegister) {
                    document.getElementById('registerName').value = '';
                    document.getElementById('registerEmail').value = '';
                    document.getElementById('registerPassword').value = '';
                    document.getElementById('registerDepartment').value = '';
                    document.getElementById('adminCode').value = '';
                }
            }

            hideMessages() {
                document.getElementById('authError').style.display = 'none';
                document.getElementById('authSuccess').style.display = 'none';
            }

            async refreshData() {
                try {
                    console.log('üîÑ Starting refresh...');
                    
                    // Show loading indicator if available
                    const refreshButtons = document.querySelectorAll('button:contains("Refresh"), button:contains("üîÑ")');
                    refreshButtons.forEach(btn => {
                        btn.disabled = true;
                        btn.textContent = btn.textContent.replace('üîÑ', '‚è≥');
                    });
                    
                    // Get current active tab
                    const activeTab = document.querySelector('.nav-tab.active');
                    const currentTabName = activeTab ? activeTab.dataset.tab : 'overview';
                    
                    console.log('üìã Refreshing tab:', currentTabName);
                    
                    // Refresh data based on current tab
                    switch (currentTabName) {
                        case 'overview':
                            await this.loadOverviewData();
                            console.log('‚úÖ Overview refreshed');
                            break;
                        case 'surveys':
                            await this.loadSurveysData();
                            console.log('‚úÖ Surveys refreshed');
                            break;
                        case 'analytics':
                            await this.loadAnalyticsData();
                            console.log('‚úÖ Analytics refreshed');
                            break;
                        case 'follow-ups':
                            await this.loadFollowUpsData();
                            console.log('‚úÖ Follow-ups refreshed');
                            break;
                        case 'users':
                            await this.loadUsersData();
                            console.log('‚úÖ Users refreshed');
                            break;
                        case 'settings':
                            await this.loadSettingsData();
                            console.log('‚úÖ Settings refreshed');
                            break;
                        default:
                            await this.loadOverviewData();
                            console.log('‚úÖ Default refresh (overview)');
                    }
                    
                    // Also refresh filter options if on surveys tab
                    if (currentTabName === 'surveys') {
                        await this.populateFilterOptions();
                    }
                    
                    console.log('‚úÖ Refresh completed successfully');
                    this.showSuccess('Data refreshed successfully!');
                    
                } catch (error) {
                    console.error('‚ùå Refresh error:', error);
                    this.showError('Failed to refresh: ' + error.message);
                } finally {
                    // Re-enable refresh buttons
                    const refreshButtons = document.querySelectorAll('button');
                    refreshButtons.forEach(btn => {
                        if (btn.textContent.includes('‚è≥')) {
                            btn.disabled = false;
                            btn.textContent = btn.textContent.replace('‚è≥', 'üîÑ');
                        }
                    });
                }
            }
            
            async removeFollowUp(followUpId, patientName) {
                if (!confirm(`Are you sure you want to remove the follow-up task for ${patientName}?\n\nThis action will be logged for audit purposes.`)) {
                    return false;
                }

                try {
                    // First, get the follow-up details for logging
                    const { data: followUp, error: fetchError } = await this.supabase
                        .from('follow_up_tasks')
                        .select('*')
                        .eq('id', followUpId)
                        .single();

                    if (fetchError) throw fetchError;

                    // Delete the follow-up task
                    const { error: deleteError } = await this.supabase
                        .from('follow_up_tasks')
                        .delete()
                        .eq('id', followUpId);

                    if (deleteError) throw deleteError;

                    // Log the removal activity
                    await this.logActivity('delete', 'follow_up_task', followUpId, {
                        patient_name: followUp.patient_name,
                        priority: followUp.priority,
                        status: followUp.status,
                        reason: 'Admin removed follow-up task',
                        removed_by: this.currentAdminUser.full_name,
                        removed_at: new Date().toISOString()
                    });

                    // Refresh the follow-ups table
                    await this.loadFollowUpsData();
                    
                    this.showSuccess(`Follow-up task for ${patientName} has been removed and logged.`);
                    return true;

                } catch (error) {
                    console.error('‚ùå Error removing follow-up:', error);
                    this.showError('Failed to remove follow-up task: ' + error.message);
                    return false;
                }
            }
            // Enhanced activity logging with better details
            async logActivity(action, resourceType = null, resourceId = null, details = null) {
                try {
                    const logData = {
                        admin_id: this.currentAdminUser.id,
                        action,
                        resource_type: resourceType,
                        resource_id: resourceId,
                        details: {
                            ...details,
                            admin_name: this.currentAdminUser.full_name,
                            admin_email: this.currentAdminUser.email,
                            timestamp: new Date().toISOString(),
                            user_agent: navigator.userAgent
                        }
                    };

                    await this.supabase
                        .from('admin_activity_log')
                        .insert(logData);

                    console.log('‚úÖ Activity logged:', action, resourceType, resourceId);
                } catch (error) {
                    console.warn('‚ùå Could not log activity:', error);
                    // Don't throw error - activity logging is not critical
                }
            }

            async toggleUserStatus(userId, newStatus) {
                // Check permissions first
                if (!this.currentAdminUser || this.currentAdminUser.role !== 'super_admin') {
                    this.showError('Only super administrators can manage user status.');
                    return;
                }

                if (userId === this.currentAdminUser.id) {
                    this.showError('You cannot disable your own account.');
                    return;
                }

                try {
                    console.log(`üîÑ ${newStatus ? 'Enabling' : 'Disabling'} user:`, userId);

                    // Use RPC call if direct update fails
                    let updateError = null;
                    
                    // Try direct update first
                    try {
                        const { error } = await this.supabase
                            .from('admin_users')
                            .update({ 
                                is_active: newStatus,
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', userId);
                        
                        updateError = error;
                    } catch (directError) {
                        updateError = directError;
                    }

                    // If direct update fails, try RPC call
                    if (updateError) {
                        console.warn('‚ö†Ô∏è Direct update failed, trying RPC...', updateError);
                        
                        const { error: rpcError } = await this.supabase
                            .rpc('update_admin_user_status', {
                                target_user_id: userId,
                                new_status: newStatus
                            });
                        
                        if (rpcError) throw rpcError;
                    }

                    // Log the activity (optional, may fail)
                    try {
                        await this.logActivity(
                            newStatus ? 'enable_user' : 'disable_user', 
                            'admin_user', 
                            userId, 
                            {
                                action: newStatus ? 'enabled' : 'disabled',
                                target_user_id: userId,
                                performed_by: this.currentAdminUser.full_name
                            }
                        );
                    } catch (logError) {
                        console.warn('‚ö†Ô∏è Could not log activity:', logError);
                    }

                    // Refresh the users table
                    await this.loadUsersData();
                    
                    const actionText = newStatus ? 'enabled' : 'disabled';
                    this.showSuccess(`User ${actionText} successfully!`);
                    console.log(`‚úÖ User ${actionText} successfully`);

                } catch (error) {
                    console.error(`‚ùå Error ${newStatus ? 'enabling' : 'disabling'} user:`, error);
                    
                    let errorMessage = `Failed to ${newStatus ? 'enable' : 'disable'} user`;
                    if (error.message.includes('infinite recursion')) {
                        errorMessage = 'Database configuration issue. Please check RLS policies.';
                    } else if (error.message.includes('policy')) {
                        errorMessage = 'Permission denied. Check your admin role and RLS policies.';
                    }
                    
                    this.showError(`${errorMessage}: ${error.message}`);
                }
            }
        
                
        
            
        }

        // === PERFECT EXPORT SYSTEM ===
        class ExportManager {
        constructor(adminDashboard) {
            this.dashboard = adminDashboard;
            this.supabase = adminDashboard.supabase;
        }

        // Enhanced survey export with multiple sheets and formatting
        async exportSurveys(format = 'excel', includeFilters = true) {
            try {
                this.showExportProgress('Preparing survey data...');

                // Get filtered data if filters are applied
                let data;
                if (includeFilters && this.dashboard.filteredData?.length > 0) {
                    data = this.dashboard.filteredData;
                    console.log('üìä Exporting filtered data:', data.length, 'surveys');
                } else {
                    // Get all surveys
                    const { data: allSurveys, error } = await this.supabase
                        .from('patient_survey_responses')
                        .select('*')
                        .order('created_at', { ascending: false });

                    if (error) throw error;
                    data = allSurveys;
                    console.log('üìä Exporting all data:', data.length, 'surveys');
                }

                this.showExportProgress('Processing survey responses...');

                switch (format) {
                    case 'excel':
                        await this.exportSurveysToExcel(data);
                        break;
                    case 'csv':
                        this.exportSurveysToCSV(data);
                        break;
                    case 'pdf':
                        await this.exportSurveysToPDF(data);
                        break;
                    case 'json':
                        this.exportSurveysToJSON(data);
                        break;
                    default:
                        throw new Error('Unsupported export format');
                }

                this.hideExportProgress();
                this.dashboard.showSuccess(`Survey data exported successfully in ${format.toUpperCase()} format!`);

            } catch (error) {
                this.hideExportProgress();
                console.error('‚ùå Export error:', error);
                this.dashboard.showError('Export failed: ' + error.message);
            }
        }

        async exportSurveysToExcel(data) {
            const wb = XLSX.utils.book_new();

            // Sheet 1: Summary Statistics
            const summaryData = this.generateSummaryStats(data);
            const summaryWS = XLSX.utils.aoa_to_sheet([
                ['üìä PATIENT SURVEY EXPORT SUMMARY'],
                ['Generated on:', new Date().toLocaleString()],
                ['Total Surveys:', data.length],
                ['Date Range:', this.getDataDateRange(data)],
                [''],
                ['üìà KEY METRICS'],
                ...summaryData
            ]);
            XLSX.utils.book_append_sheet(wb, summaryWS, 'Summary');

            // Sheet 2: Main Survey Data (flattened)
            const flattenedData = data.map(survey => ({
                'Survey ID': survey.response_id,
                'Patient Name': survey.patient_info?.full_name || '',
                'Email': survey.patient_info?.email || '',
                'Phone': survey.patient_info?.phone || '',
                'Visit Date': survey.patient_info?.visit_date || '',
                'Visit Time': survey.patient_info?.visit_time || '',
                'Department': survey.patient_info?.department_visited || '',
                'Overall Rating': survey.experience_data?.overall_satisfaction || '',
                'Reception Rating': survey.experience_data?.reception_rating || '',
                'Doctor Rating': survey.experience_data?.doctor_rating || '',
                'Nursing Rating': survey.experience_data?.nursing_rating || '',
                'Staff Professionalism': survey.experience_data?.staff_professionalism || '',
                'Wait Time': survey.experience_data?.wait_time_actual || '',
                'Appointment Timeliness': survey.experience_data?.appointment_timeliness || '',
                'Wants Follow-up': survey.contact_preferences?.wants_contact || '',
                'Contact Methods': survey.contact_preferences?.contact_methods?.join(', ') || '',
                'Additional Comments': survey.experience_data?.additional_comments || '',
                'Submitted Date': new Date(survey.created_at).toLocaleString(),
                'Last Updated': new Date(survey.updated_at).toLocaleString()
            }));

            const mainWS = XLSX.utils.json_to_sheet(flattenedData);
            XLSX.utils.book_append_sheet(wb, mainWS, 'Survey Responses');

            // Sheet 3: Department Analysis
            const deptAnalysis = this.generateDepartmentAnalysis(data);
            const deptWS = XLSX.utils.json_to_sheet(deptAnalysis);
            XLSX.utils.book_append_sheet(wb, deptWS, 'Department Analysis');

            // Sheet 4: Rating Distribution
            const ratingDist = this.generateRatingDistribution(data);
            const ratingWS = XLSX.utils.json_to_sheet(ratingDist);
            XLSX.utils.book_append_sheet(wb, ratingWS, 'Rating Distribution');

            // Sheet 5: Follow-up Requests
            const followUpData = data
                .filter(s => s.contact_preferences?.wants_contact === 'yes')
                .map(survey => ({
                    'Patient Name': survey.patient_info?.full_name || '',
                    'Email': survey.patient_info?.email || '',
                    'Phone': survey.patient_info?.phone || '',
                    'Overall Rating': survey.experience_data?.overall_satisfaction || '',
                    'Department': survey.patient_info?.department_visited || '',
                    'Preferred Contact': survey.contact_preferences?.contact_methods?.join(', ') || '',
                    'Visit Date': survey.patient_info?.visit_date || '',
                    'Comments': survey.experience_data?.additional_comments || '',
                    'Submitted': new Date(survey.created_at).toLocaleString()
                }));

            if (followUpData.length > 0) {
                const followUpWS = XLSX.utils.json_to_sheet(followUpData);
                XLSX.utils.book_append_sheet(wb, followUpWS, 'Follow-up Requests');
            }

            // Generate filename with timestamp and filters
            const timestamp = new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-');
            const filterSuffix = this.dashboard.filteredData?.length > 0 ? '_filtered' : '_all';
            const filename = `patient_surveys_${timestamp}${filterSuffix}.xlsx`;

            XLSX.writeFile(wb, filename);
        }

        exportSurveysToCSV(data) {
            const flattenedData = data.map(survey => ({
                'survey_id': survey.response_id,
                'patient_name': survey.patient_info?.full_name || '',
                'email': survey.patient_info?.email || '',
                'phone': survey.patient_info?.phone || '',
                'visit_date': survey.patient_info?.visit_date || '',
                'visit_time': survey.patient_info?.visit_time || '',
                'department': survey.patient_info?.department_visited || '',
                'overall_rating': survey.experience_data?.overall_satisfaction || '',
                'reception_rating': survey.experience_data?.reception_rating || '',
                'doctor_rating': survey.experience_data?.doctor_rating || '',
                'nursing_rating': survey.experience_data?.nursing_rating || '',
                'staff_professionalism': survey.experience_data?.staff_professionalism || '',
                'wait_time': survey.experience_data?.wait_time_actual || '',
                'appointment_timeliness': survey.experience_data?.appointment_timeliness || '',
                'wants_followup': survey.contact_preferences?.wants_contact || '',
                'contact_methods': survey.contact_preferences?.contact_methods?.join('; ') || '',
                'additional_comments': survey.experience_data?.additional_comments || '',
                'submitted_date': new Date(survey.created_at).toISOString(),
                'last_updated': new Date(survey.updated_at).toISOString()
            }));

            const csv = this.convertToCSV(flattenedData);
            const timestamp = new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-');
            const filterSuffix = this.dashboard.filteredData?.length > 0 ? '_filtered' : '_all';
            const filename = `patient_surveys_${timestamp}${filterSuffix}.csv`;
            
            this.downloadFile(csv, filename, 'text/csv;charset=utf-8;');
        }

        async exportSurveysToPDF(data) {
            // Create HTML for PDF conversion
            const html = this.generatePDFContent(data);
            
            // For now, open in new window for printing
            const printWindow = window.open('', '_blank');
            printWindow.document.write(html);
            printWindow.document.close();
            
            // Auto-print dialog
            setTimeout(() => {
                printWindow.print();
            }, 1000);
        }

        exportSurveysToJSON(data) {
            const exportData = {
                exported_at: new Date().toISOString(),
                total_surveys: data.length,
                date_range: this.getDataDateRange(data),
                summary_stats: this.generateSummaryStats(data),
                surveys: data
            };

            const json = JSON.stringify(exportData, null, 2);
            const timestamp = new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-');
            const filterSuffix = this.dashboard.filteredData?.length > 0 ? '_filtered' : '_all';
            const filename = `patient_surveys_${timestamp}${filterSuffix}.json`;
            
            this.downloadFile(json, filename, 'application/json');
        }

        // Enhanced follow-up export
        async exportFollowUps(format = 'excel') {
            try {
                this.showExportProgress('Fetching follow-up tasks...');

                const { data: followUps, error } = await this.supabase
                    .from('follow_up_tasks')
                    .select(`
                        *,
                        admin_users!follow_up_tasks_assigned_to_fkey(full_name, email)
                    `)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                this.showExportProgress('Processing follow-up data...');

                switch (format) {
                    case 'excel':
                        this.exportFollowUpsToExcel(followUps);
                        break;
                    case 'csv':
                        this.exportFollowUpsToCSV(followUps);
                        break;
                    default:
                        throw new Error('Unsupported format for follow-ups');
                }

                this.hideExportProgress();
                this.dashboard.showSuccess('Follow-up tasks exported successfully!');

            } catch (error) {
                this.hideExportProgress();
                console.error('‚ùå Follow-up export error:', error);
                this.dashboard.showError('Follow-up export failed: ' + error.message);
            }
        }

        exportFollowUpsToExcel(data) {
            const wb = XLSX.utils.book_new();

            // Summary sheet
            const priorityStats = this.generateFollowUpStats(data);
            const summaryWS = XLSX.utils.aoa_to_sheet([
                ['üìã FOLLOW-UP TASKS EXPORT'],
                ['Generated on:', new Date().toLocaleString()],
                ['Total Tasks:', data.length],
                [''],
                ['üìä BY PRIORITY'],
                ...priorityStats.priority,
                [''],
                ['üìà BY STATUS'],
                ...priorityStats.status
            ]);
            XLSX.utils.book_append_sheet(wb, summaryWS, 'Summary');

            // Main data sheet
            const flattenedData = data.map(task => ({
                'Task ID': task.id,
                'Patient Name': task.patient_name,
                'Email': task.patient_email,
                'Phone': task.patient_phone,
                'Contact Method': task.contact_method,
                'Priority': task.priority.toUpperCase(),
                'Status': task.status.replace('_', ' ').toUpperCase(),
                'Assigned To': task.admin_users?.full_name || 'Unassigned',
                'Assigned Email': task.admin_users?.email || '',
                'Notes': task.notes || '',
                'Attempts': task.attempts || 0,
                'Max Attempts': task.max_attempts || 3,
                'Created Date': new Date(task.created_at).toLocaleString(),
                'Scheduled Date': task.scheduled_date ? new Date(task.scheduled_date).toLocaleString() : '',
                'Completed Date': task.completed_date ? new Date(task.completed_date).toLocaleString() : '',
                'Updated Date': new Date(task.updated_at).toLocaleString()
            }));

            const mainWS = XLSX.utils.json_to_sheet(flattenedData);
            XLSX.utils.book_append_sheet(wb, mainWS, 'Follow-up Tasks');

            // Pending tasks sheet
            const pendingTasks = data
                .filter(task => task.status === 'pending')
                .map(task => ({
                    'Priority': task.priority.toUpperCase(),
                    'Patient': task.patient_name,
                    'Contact': task.contact_method,
                    'Assigned To': task.admin_users?.full_name || 'UNASSIGNED',
                    'Days Old': Math.floor((new Date() - new Date(task.created_at)) / (1000 * 60 * 60 * 24)),
                    'Notes': task.notes || ''
                }));

            if (pendingTasks.length > 0) {
                const pendingWS = XLSX.utils.json_to_sheet(pendingTasks);
                XLSX.utils.book_append_sheet(wb, pendingWS, 'Pending Tasks');
            }

            const timestamp = new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-');
            const filename = `follow_up_tasks_${timestamp}.xlsx`;
            XLSX.writeFile(wb, filename);
        }

        exportFollowUpsToCSV(data) {
            const flattenedData = data.map(task => ({
                'task_id': task.id,
                'patient_name': task.patient_name,
                'patient_email': task.patient_email || '',
                'patient_phone': task.patient_phone || '',
                'contact_method': task.contact_method,
                'priority': task.priority,
                'status': task.status,
                'assigned_to': task.admin_users?.full_name || '',
                'assigned_email': task.admin_users?.email || '',
                'notes': task.notes || '',
                'attempts': task.attempts || 0,
                'max_attempts': task.max_attempts || 3,
                'created_date': new Date(task.created_at).toISOString(),
                'scheduled_date': task.scheduled_date ? new Date(task.scheduled_date).toISOString() : '',
                'completed_date': task.completed_date ? new Date(task.completed_date).toISOString() : '',
                'updated_date': new Date(task.updated_at).toISOString()
            }));

            const csv = this.convertToCSV(flattenedData);
            const timestamp = new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-');
            const filename = `follow_up_tasks_${timestamp}.csv`;
            
            this.downloadFile(csv, filename, 'text/csv;charset=utf-8;');
        }

        // Analytics export
        async exportAnalytics(format = 'excel') {
            try {
                this.showExportProgress('Generating analytics report...');

                // Get last 30 days of data for analytics
                const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
                
                const { data: surveys, error } = await this.supabase
                    .from('patient_survey_responses')
                    .select('*')
                    .gte('created_at', thirtyDaysAgo.toISOString());

                if (error) throw error;

                const analytics = this.generateAnalyticsData(surveys);

                switch (format) {
                    case 'excel':
                        this.exportAnalyticsToExcel(analytics, surveys);
                        break;
                    case 'csv':
                        this.exportAnalyticsToCSV(analytics);
                        break;
                }

                this.hideExportProgress();
                this.dashboard.showSuccess('Analytics report exported successfully!');

            } catch (error) {
                this.hideExportProgress();
                console.error('‚ùå Analytics export error:', error);
                this.dashboard.showError('Analytics export failed: ' + error.message);
            }
        }

        // === HELPER METHODS ===

        generateSummaryStats(data) {
            const validRatings = data.filter(s => s.experience_data?.overall_satisfaction);
            const avgRating = validRatings.length > 0 
                ? (validRatings.reduce((sum, s) => sum + parseInt(s.experience_data.overall_satisfaction), 0) / validRatings.length).toFixed(2)
                : 0;

            const ratingCounts = [1, 2, 3, 4, 5].map(rating => [
                `${rating} Star${rating > 1 ? 's' : ''}`,
                validRatings.filter(s => parseInt(s.experience_data.overall_satisfaction) === rating).length
            ]);

            const followUpRequests = data.filter(s => s.contact_preferences?.wants_contact === 'yes').length;
            const departments = [...new Set(data.map(s => s.patient_info?.department_visited).filter(Boolean))];

            return [
                ['Average Rating:', avgRating],
                ['Total Responses:', data.length],
                ['Follow-up Requests:', followUpRequests],
                ['Departments Covered:', departments.length],
                [''],
                ...ratingCounts
            ];
        }

        generateDepartmentAnalysis(data) {
            const deptData = {};
            data.forEach(survey => {
                const dept = survey.patient_info?.department_visited;
                const rating = survey.experience_data?.overall_satisfaction;
                
                if (dept && rating) {
                    if (!deptData[dept]) {
                        deptData[dept] = { ratings: [], followUps: 0, total: 0 };
                    }
                    deptData[dept].ratings.push(parseInt(rating));
                    deptData[dept].total++;
                    
                    if (survey.contact_preferences?.wants_contact === 'yes') {
                        deptData[dept].followUps++;
                    }
                }
            });

            return Object.entries(deptData).map(([dept, stats]) => ({
                'Department': dept,
                'Total Surveys': stats.total,
                'Average Rating': (stats.ratings.reduce((sum, r) => sum + r, 0) / stats.ratings.length).toFixed(2),
                'Follow-up Requests': stats.followUps,
                'Follow-up Rate': ((stats.followUps / stats.total) * 100).toFixed(1) + '%'
            }));
        }

        generateRatingDistribution(data) {
            const validRatings = data.filter(s => s.experience_data?.overall_satisfaction);
            
            return [1, 2, 3, 4, 5].map(rating => {
                const count = validRatings.filter(s => parseInt(s.experience_data.overall_satisfaction) === rating).length;
                const percentage = validRatings.length > 0 ? ((count / validRatings.length) * 100).toFixed(1) : 0;
                
                return {
                    'Rating': `${rating} Star${rating > 1 ? 's' : ''}`,
                    'Count': count,
                    'Percentage': percentage + '%'
                };
            });
        }

        generateFollowUpStats(data) {
            const priorityStats = ['urgent', 'high', 'medium', 'low'].map(priority => [
                priority.toUpperCase(),
                data.filter(task => task.priority === priority).length
            ]);

            const statusStats = ['pending', 'in_progress', 'completed', 'cancelled'].map(status => [
                status.replace('_', ' ').toUpperCase(),
                data.filter(task => task.status === status).length
            ]);

            return { priority: priorityStats, status: statusStats };
        }

        generateAnalyticsData(surveys) {
            const validRatings = surveys.filter(s => s.experience_data?.overall_satisfaction);
            
            return {
                totalSurveys: surveys.length,
                averageRating: validRatings.length > 0 
                    ? (validRatings.reduce((sum, s) => sum + parseInt(s.experience_data.overall_satisfaction), 0) / validRatings.length).toFixed(2)
                    : 0,
                satisfactionRate: validRatings.length > 0 
                    ? ((validRatings.filter(s => parseInt(s.experience_data.overall_satisfaction) >= 4).length / validRatings.length) * 100).toFixed(1)
                    : 0,
                followUpRequests: surveys.filter(s => s.contact_preferences?.wants_contact === 'yes').length
            };
        }

        generatePDFContent(data) {
            const summaryStats = this.generateSummaryStats(data);
            
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Patient Survey Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .summary { background: #f8f9fa; padding: 20px; margin-bottom: 30px; border-radius: 8px; }
                        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
                        .stat-item { background: white; padding: 15px; border-radius: 6px; text-align: center; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üìä Patient Survey Report</h1>
                        <p>Generated on: ${new Date().toLocaleString()}</p>
                        <p>Total Surveys: ${data.length}</p>
                    </div>
                    
                    <div class="summary">
                        <h2>Summary Statistics</h2>
                        <div class="stats-grid">
                            ${summaryStats.map(([label, value]) => 
                                `<div class="stat-item"><strong>${label}</strong><br>${value}</div>`
                            ).join('')}
                        </div>
                    </div>
                    
                    <h2>Recent Survey Responses</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Patient</th>
                                <th>Department</th>
                                <th>Rating</th>
                                <th>Visit Date</th>
                                <th>Follow-up</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.slice(0, 20).map(survey => `
                                <tr>
                                    <td>${survey.patient_info?.full_name || 'N/A'}</td>
                                    <td>${survey.patient_info?.department_visited || 'N/A'}</td>
                                    <td>${survey.experience_data?.overall_satisfaction || 'N/A'}/5</td>
                                    <td>${survey.patient_info?.visit_date || 'N/A'}</td>
                                    <td>${survey.contact_preferences?.wants_contact === 'yes' ? 'Yes' : 'No'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `;
        }

        getDataDateRange(data) {
            if (data.length === 0) return 'No data';
            
            const dates = data.map(d => new Date(d.created_at)).sort();
            const oldest = dates[0].toLocaleDateString();
            const newest = dates[dates.length - 1].toLocaleDateString();
            
            return oldest === newest ? oldest : `${oldest} to ${newest}`;
        }

        convertToCSV(data) {
            if (!data.length) return '';
            
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => 
                    headers.map(field => {
                        const value = row[field];
                        // Escape quotes and wrap in quotes if contains comma or quote
                        if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                            return `"${value.replace(/"/g, '""')}"`;
                        }
                        return value;
                    }).join(',')
                )
            ].join('\n');
            
            // Add UTF-8 BOM for better Excel compatibility
            return '\ufeff' + csvContent;
        }

        downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        showExportProgress(message) {
            // Create or update progress indicator
            let progressDiv = document.getElementById('exportProgress');
            if (!progressDiv) {
                progressDiv = document.createElement('div');
                progressDiv.id = 'exportProgress';
                progressDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: white;
                    padding: 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                    z-index: 10000;
                    text-align: center;
                    min-width: 300px;
                `;
                document.body.appendChild(progressDiv);
            }
            
            progressDiv.innerHTML = `
                <div class="spinner" style="margin: 0 auto 15px; width: 40px; height: 40px;"></div>
                <h3>Exporting Data</h3>
                <p>${message}</p>
            `;
        }

        hideExportProgress() {
            const progressDiv = document.getElementById('exportProgress');
            if (progressDiv) {
                progressDiv.remove();
            }
        }
    }

        // Global functions for UI interactions
        function switchAuthTab(tabName) {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const loginTab = document.querySelector('.auth-tab:first-child');
            const registerTab = document.querySelector('.auth-tab:last-child');

            if (tabName === 'login') {
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                loginTab.classList.add('active');
                registerTab.classList.remove('active');
            } else {
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
                loginTab.classList.remove('active');
                registerTab.classList.add('active');
            }

            // Hide messages when switching tabs but DON'T clear form values
            if (window.adminDashboard) {
                window.adminDashboard.hideMessages();
            }
        }

        function viewSurvey(responseId) {
            if (window.adminDashboard && window.adminDashboard.supabase) {
                window.adminDashboard.supabase
                    .from('patient_survey_responses')
                    .select('*')
                    .eq('response_id', responseId)
                    .single()
                    .then(({ data: survey, error }) => {
                        if (error) {
                            console.error('Error loading survey:', error);
                            return;
                        }

                        const modal = document.getElementById('surveyModal');
                        const details = document.getElementById('surveyDetails');
                        
                        details.innerHTML = `
                            <h3>Survey Details</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 20px;">
                                <div>
                                    <h4>Patient Information</h4>
                                    <p><strong>Name:</strong> ${survey.patient_info?.full_name || 'N/A'}</p>
                                    <p><strong>Email:</strong> ${survey.patient_info?.email || 'N/A'}</p>
                                    <p><strong>Phone:</strong> ${survey.patient_info?.phone || 'N/A'}</p>
                                    <p><strong>Visit Date:</strong> ${survey.patient_info?.visit_date || 'N/A'}</p>
                                    <p><strong>Visit Time:</strong> ${survey.patient_info?.visit_time || 'N/A'}</p>
                                    <p><strong>Department:</strong> ${survey.patient_info?.department_visited || 'N/A'}</p>
                                </div>
                                <div>
                                    <h4>Ratings (1-5 scale)</h4>
                                    <p><strong>Overall Satisfaction:</strong> ${survey.experience_data?.overall_satisfaction || 'N/A'}/5</p>
                                    <p><strong>Reception:</strong> ${survey.experience_data?.reception_rating || 'N/A'}/5</p>
                                    <p><strong>Doctor/Provider:</strong> ${survey.experience_data?.doctor_rating || 'N/A'}/5</p>
                                    <p><strong>Nursing:</strong> ${survey.experience_data?.nursing_rating || 'N/A'}/5</p>
                                    <p><strong>Staff Professionalism:</strong> ${survey.experience_data?.staff_professionalism || 'N/A'}/5</p>
                                </div>
                                <div>
                                    <h4>Experience Details</h4>
                                    <p><strong>Wait Time:</strong> ${survey.experience_data?.wait_time_actual || 'N/A'}</p>
                                    <p><strong>Appointment Timeliness:</strong> ${survey.experience_data?.appointment_timeliness || 'N/A'}</p>
                                </div>
                                <div>
                                    <h4>Contact Preferences</h4>
                                    <p><strong>Wants Contact:</strong> ${survey.contact_preferences?.wants_contact === 'yes' ? 'Yes' : 'No'}</p>
                                    <p><strong>Methods:</strong> ${survey.contact_preferences?.contact_methods?.join(', ') || 'None'}</p>
                                </div>
                            </div>
                            ${survey.experience_data?.additional_comments ? `
                                <div style="margin-top: 20px;">
                                    <h4>Additional Comments</h4>
                                    <p style="background: #f8f9fa; padding: 10px; border-radius: 6px;">${survey.experience_data.additional_comments}</p>
                                </div>
                            ` : ''}
                            <div style="margin-top: 20px; font-size: 12px; color: #666;">
                                <p><strong>Survey ID:</strong> ${survey.response_id}</p>
                                <p><strong>Submitted:</strong> ${new Date(survey.created_at).toLocaleString()}</p>
                            </div>
                        `;
                        
                        modal.style.display = 'block';
                    })
                    .catch(error => {
                        console.error('Error viewing survey:', error);
                        alert('Error loading survey details');
                    });
            }
        }

        function closeSurveyModal() {
            document.getElementById('surveyModal').style.display = 'none';
        }

        function viewFollowUp(followUpId) {
            if (window.adminDashboard && window.adminDashboard.supabase) {
                window.adminDashboard.supabase
                    .from('follow_up_tasks')
                    .select(`
                        *,
                        admin_users!follow_up_tasks_assigned_to_fkey(full_name, email),
                        patient_survey_responses!follow_up_tasks_survey_response_id_fkey(*)
                    `)
                    .eq('id', followUpId)
                    .single()
                    .then(({ data: followUp, error }) => {
                        if (error) {
                            console.error('Error loading follow-up task:', error);
                            // Fallback: try without joins
                            return window.adminDashboard.supabase
                                .from('follow_up_tasks')
                                .select('*')
                                .eq('id', followUpId)
                                .single();
                        }
                        return { data: followUp, error: null };
                    })
                    .then(({ data: followUp, error }) => {
                        if (error) {
                            console.error('Error loading follow-up task:', error);
                            alert('Error loading follow-up details: ' + error.message);
                            return;
                        }

                        const modal = document.getElementById('followUpModal');
                        const details = document.getElementById('followUpDetails');
                        
                        // Get survey details if available
                        let surveySection = '';
                        if (followUp.patient_survey_responses) {
                            const survey = followUp.patient_survey_responses;
                            surveySection = `
                                <div style="margin-top: 20px;">
                                    <h4>üìã Related Survey Details</h4>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-top: 10px;">
                                        <p><strong>Overall Rating:</strong> ${survey.experience_data?.overall_satisfaction || 'N/A'}/5</p>
                                        <p><strong>Visit Date:</strong> ${survey.patient_info?.visit_date || 'N/A'}</p>
                                        <p><strong>Department:</strong> ${survey.patient_info?.department_visited || 'N/A'}</p>
                                        <p><strong>Wants Contact:</strong> ${survey.contact_preferences?.wants_contact === 'yes' ? 'Yes' : 'No'}</p>
                                        ${survey.experience_data?.additional_comments ? 
                                            `<p><strong>Comments:</strong> ${survey.experience_data.additional_comments}</p>` 
                                            : ''
                                        }
                                    </div>
                                </div>
                            `;
                        }

                        // Build priority indicator
                        const priorityColors = {
                            'urgent': '#dc2626',
                            'high': '#ea580c', 
                            'medium': '#ca8a04',
                            'low': '#16a34a'
                        };
                        const priorityColor = priorityColors[followUp.priority] || '#6b7280';

                        details.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3>Follow-up Task Details</h3>
                                <span style="background: ${priorityColor}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: uppercase;">
                                    ${followUp.priority} Priority
                                </span>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                                <div>
                                    <h4>üë§ Patient Information</h4>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-top: 10px;">
                                        <p><strong>Name:</strong> ${followUp.patient_name || 'N/A'}</p>
                                        <p><strong>Email:</strong> ${followUp.patient_email || 'N/A'}</p>
                                        <p><strong>Phone:</strong> ${followUp.patient_phone || 'N/A'}</p>
                                        <p><strong>Preferred Contact:</strong> 
                                            <span style="background: #e0e7ff; color: #3730a3; padding: 2px 8px; border-radius: 12px; font-size: 12px;">
                                                ${followUp.contact_method}
                                            </span>
                                        </p>
                                    </div>
                                </div>
                                
                                <div>
                                    <h4>üìã Task Information</h4>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-top: 10px;">
                                        <p><strong>Status:</strong> 
                                            <span style="background: ${followUp.status === 'pending' ? '#fef3c7' : followUp.status === 'completed' ? '#d1fae5' : '#fee2e2'}; 
                                                        color: ${followUp.status === 'pending' ? '#92400e' : followUp.status === 'completed' ? '#065f46' : '#991b1b'}; 
                                                        padding: 2px 8px; border-radius: 12px; font-size: 12px; text-transform: uppercase;">
                                                ${followUp.status.replace('_', ' ')}
                                            </span>
                                        </p>
                                        <p><strong>Assigned To:</strong> ${followUp.admin_users?.full_name || 'Unassigned'}</p>
                                        <p><strong>Created:</strong> ${new Date(followUp.created_at).toLocaleString()}</p>
                                        <p><strong>Attempts:</strong> ${followUp.attempts || 0} / ${followUp.max_attempts || 3}</p>
                                        ${followUp.scheduled_date ? `<p><strong>Scheduled:</strong> ${new Date(followUp.scheduled_date).toLocaleString()}</p>` : ''}
                                        ${followUp.completed_date ? `<p><strong>Completed:</strong> ${new Date(followUp.completed_date).toLocaleString()}</p>` : ''}
                                    </div>
                                </div>
                            </div>

                            ${followUp.notes ? `
                                <div style="margin-top: 20px;">
                                    <h4>üìù Notes & Reason</h4>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-top: 10px;">
                                        <p>${followUp.notes}</p>
                                    </div>
                                </div>
                            ` : ''}

                            ${surveySection}

                            <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #e5e7eb; display: flex; gap: 10px; flex-wrap: wrap;">
                                ${followUp.status === 'pending' ? `
                                    <button class="btn btn-success btn-sm" onclick="completeFollowUpFromModal('${followUp.id}')">‚úÖ Mark Complete</button>
                                    <button class="btn btn-warning btn-sm" onclick="assignFollowUpToMe('${followUp.id}')">üë§ Assign to Me</button>
                                ` : ''}
                                <button class="btn btn-primary btn-sm" onclick="contactPatient('${followUp.patient_email}', '${followUp.contact_method}', '${followUp.patient_phone}')">üìß Contact Patient</button>
                                <button class="btn btn-secondary btn-sm" onclick="addFollowUpNote('${followUp.id}')">üìù Add Note</button>
                                <button class="btn btn-danger btn-sm" onclick="removeFollowUpFromModal('${followUp.id}', '${followUp.patient_name?.replace(/'/g, "\\'")}')">üóëÔ∏è Remove Task</button>
                            </div>

                            <div style="margin-top: 20px; font-size: 12px; color: #666; border-top: 1px solid #e5e7eb; padding-top: 15px;">
                                <p><strong>Task ID:</strong> ${followUp.id}</p>
                                ${followUp.survey_response_id ? `<p><strong>Survey ID:</strong> ${followUp.survey_response_id}</p>` : ''}
                            </div>
                        `;
                        
                        modal.style.display = 'block';
                    })
                    .catch(error => {
                        console.error('Error viewing follow-up:', error);
                        alert('Error loading follow-up details');
                    });
            }
        }

        // Also add these supporting functions if they don't exist:

        async function completeFollowUpFromModal(followUpId) {
            await completeFollowUp(followUpId);
            closeFollowUpModal();
        }

        async function removeFollowUpFromModal(followUpId, patientName) {
            const confirmed = await removeFollowUp(followUpId, patientName);
            if (confirmed !== false) {
                closeFollowUpModal();
            }
        }

        async function assignFollowUpToMe(followUpId) {
            if (window.adminDashboard) {
                try {
                    const { error } = await window.adminDashboard.supabase
                        .from('follow_up_tasks')
                        .update({ 
                            assigned_to: window.adminDashboard.currentAdminUser.id,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', followUpId);

                    if (error) throw error;

                    alert('Task assigned to you successfully!');
                    closeFollowUpModal();
                    await window.adminDashboard.loadFollowUpsData();
                } catch (error) {
                    console.error('Error assigning follow-up:', error);
                    alert('Error assigning task: ' + error.message);
                }
            }
        }

        async function contactPatient(email, method, phone) {
            if (method === 'email' && email) {
                // Open email client
                const subject = encodeURIComponent('Follow-up: Your Recent Healthcare Visit');
                const body = encodeURIComponent(`Dear Patient,\n\nWe are following up on your recent visit to ensure you received the best possible care.\n\nPlease reply to this email or call us if you have any questions or concerns.\n\nThank you,\nPatient Care Team`);
                window.open(`mailto:${email}?subject=${subject}&body=${body}`);
            } else if (method === 'phone' && phone) {
                // Copy phone number and show instructions
                navigator.clipboard.writeText(phone).then(() => {
                    alert(`Phone number ${phone} copied to clipboard.\n\nPlease call the patient to follow up on their healthcare experience.`);
                }).catch(() => {
                    alert(`Please call the patient at: ${phone}`);
                });
            } else {
                alert('Contact information not available for this method.');
            }
        }

        async function addFollowUpNote(followUpId) {
            const note = prompt('Add a note to this follow-up task:');
            if (note && note.trim() && window.adminDashboard) {
                try {
                    // Get current notes
                    const { data: currentTask } = await window.adminDashboard.supabase
                        .from('follow_up_tasks')
                        .select('notes')
                        .eq('id', followUpId)
                        .single();

                    const timestamp = new Date().toLocaleString();
                    const adminName = window.adminDashboard.currentAdminUser.full_name;
                    const newNote = `[${timestamp} - ${adminName}]: ${note.trim()}`;
                    
                    const updatedNotes = currentTask?.notes 
                        ? currentTask.notes + '\n\n' + newNote
                        : newNote;

                    const { error } = await window.adminDashboard.supabase
                        .from('follow_up_tasks')
                        .update({ 
                            notes: updatedNotes,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', followUpId);

                    if (error) throw error;

                    alert('Note added successfully!');
                    // Refresh the modal view
                    viewFollowUp(followUpId);
                } catch (error) {
                    console.error('Error adding note:', error);
                    alert('Error adding note: ' + error.message);
                }
            }
        }

        function closeFollowUpModal() {
            document.getElementById('followUpModal').style.display = 'none';
        }

        async function completeFollowUp(followUpId) {
            if (confirm('Mark this follow-up as completed?')) {
                try {
                    await window.adminDashboard.supabase
                        .from('follow_up_tasks')
                        .update({ 
                            status: 'completed',
                            completed_date: new Date().toISOString()
                        })
                        .eq('id', followUpId);

                    await window.adminDashboard.loadFollowUpsData();
                    alert('Follow-up marked as completed');
                } catch (error) {
                    console.error('Error completing follow-up:', error);
                    alert('Error completing follow-up');
                }
            }
        }

        function applyFilters() {
            console.log('üéØ Apply filters clicked');
            
            if (window.adminDashboard) {
                const filters = {
                    department: document.getElementById('departmentFilter')?.value || '',
                    dateRange: document.getElementById('dateRangeFilter')?.value || '',
                    satisfaction: document.getElementById('satisfactionFilter')?.value || ''
                };

                // Handle custom date range
                if (filters.dateRange === 'custom') {
                    filters.startDate = document.getElementById('startDate')?.value || '';
                    filters.endDate = document.getElementById('endDate')?.value || '';
                    
                    if (!filters.startDate || !filters.endDate) {
                        alert('Please select both start and end dates for custom range');
                        return;
                    }
                }

                console.log('üîç Applying filters:', filters);
                window.adminDashboard.currentFilters = filters;
                window.adminDashboard.loadSurveysData();
            } else {
                console.error('‚ùå adminDashboard not available');
                alert('Dashboard not ready. Please refresh the page.');
            }
        }

        function clearFilters() {
            console.log('üßπ Clearing all filters');
            
            // Reset filter form elements
            document.getElementById('departmentFilter').value = '';
            document.getElementById('dateRangeFilter').value = 'today';
            document.getElementById('satisfactionFilter').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            
            // Hide custom date fields
            document.getElementById('customDateGroup').style.display = 'none';
            document.getElementById('customDateGroup2').style.display = 'none';
            
            if (window.adminDashboard) {
                window.adminDashboard.currentFilters = {};
                window.adminDashboard.loadSurveysData();
            }
        }

        function toggleExportDropdown() {
            const dropdown = document.querySelector('.export-dropdown');
            dropdown.classList.toggle('show');
        }




        
        async function saveSettings() {
            try {
                const settings = {
                    'survey_auto_restart_time': document.getElementById('autoRestartTime').value,
                    'survey_idle_timeout': document.getElementById('idleTimeout').value,
                    'dashboard_refresh_interval': document.getElementById('dashboardRefresh').value,
                    'low_rating_threshold': document.getElementById('lowRatingThreshold').value,
                    'max_follow_up_attempts': document.getElementById('maxFollowUpAttempts').value,
                    'email_notifications_enabled': document.getElementById('emailNotifications').value
                };

                for (const [key, value] of Object.entries(settings)) {
                    await window.adminDashboard.supabase
                        .from('system_settings')
                        .upsert({
                            setting_key: key,
                            setting_value: value,
                            updated_by: window.adminDashboard.currentAdminUser.id
                        });
                }

                alert('Settings saved successfully!');
            } catch (error) {
                console.error('Error saving settings:', error);
                alert('Error saving settings');
            }
        }

        function refreshData() {
            console.log('üîÑ Global refresh called');
            
            if (!window.adminDashboard) {
                console.error('‚ùå AdminDashboard not available');
                alert('Dashboard not ready. Please refresh the page.');
                return;
            }
            
            console.log('‚úÖ Calling adminDashboard.refreshData()');
            window.adminDashboard.refreshData();
        }
        // Close dropdowns when clicking outside
        window.onclick = function(event) {
            if (!event.target.matches('.btn')) {
                const dropdowns = document.getElementsByClassName('export-dropdown-content');
                for (let i = 0; i < dropdowns.length; i++) {
                    const openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.adminDashboard = new AdminDashboard();
        });
    // Global function for remove button
        async function removeFollowUp(followUpId, patientName) {
            if (window.adminDashboard) {
                await window.adminDashboard.removeFollowUp(followUpId, patientName);
            }
        }

        // Supporting functions for follow-up modal actions
        async function completeFollowUpFromModal(followUpId) {
            await completeFollowUp(followUpId);
            closeFollowUpModal();
        }

        async function removeFollowUpFromModal(followUpId, patientName) {
            const confirmed = await removeFollowUp(followUpId, patientName);
            if (confirmed !== false) {
                closeFollowUpModal();
            }
        }

        async function assignFollowUpToMe(followUpId) {
            if (window.adminDashboard) {
                try {
                    const { error } = await window.adminDashboard.supabase
                        .from('follow_up_tasks')
                        .update({ 
                            assigned_to: window.adminDashboard.currentAdminUser.id,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', followUpId);

                    if (error) throw error;

                    // Log the assignment
                    await window.adminDashboard.logActivity('assign', 'follow_up_task', followUpId, {
                        assigned_to: window.adminDashboard.currentAdminUser.full_name,
                        action_type: 'self_assignment'
                    });

                    alert('Task assigned to you successfully!');
                    closeFollowUpModal();
                    await window.adminDashboard.loadFollowUpsData();
                } catch (error) {
                    console.error('Error assigning follow-up:', error);
                    alert('Error assigning task: ' + error.message);
                }
            }
        }

        async function contactPatient(email, method, phone) {
            if (method === 'email' && email) {
                // Open email client
                const subject = encodeURIComponent('Follow-up: Your Recent Healthcare Visit');
                const body = encodeURIComponent(`Dear Patient,\n\nWe are following up on your recent visit to ensure you received the best possible care.\n\nPlease reply to this email or call us if you have any questions or concerns.\n\nThank you,\nPatient Care Team`);
                window.open(`mailto:${email}?subject=${subject}&body=${body}`);
            } else if (method === 'phone' && phone) {
                // Copy phone number and show instructions
                navigator.clipboard.writeText(phone).then(() => {
                    alert(`Phone number ${phone} copied to clipboard.\n\nPlease call the patient to follow up on their healthcare experience.`);
                }).catch(() => {
                    alert(`Please call the patient at: ${phone}`);
                });
            } else {
                alert('Contact information not available for this method.');
            }
        }

        async function addFollowUpNote(followUpId) {
            const note = prompt('Add a note to this follow-up task:');
            if (note && note.trim() && window.adminDashboard) {
                try {
                    // Get current notes
                    const { data: currentTask } = await window.adminDashboard.supabase
                        .from('follow_up_tasks')
                        .select('notes')
                        .eq('id', followUpId)
                        .single();

                    const timestamp = new Date().toLocaleString();
                    const adminName = window.adminDashboard.currentAdminUser.full_name;
                    const newNote = `[${timestamp} - ${adminName}]: ${note.trim()}`;
                    
                    const updatedNotes = currentTask?.notes 
                        ? currentTask.notes + '\n\n' + newNote
                        : newNote;

                    const { error } = await window.adminDashboard.supabase
                        .from('follow_up_tasks')
                        .update({ 
                            notes: updatedNotes,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', followUpId);

                    if (error) throw error;

                    // Log the note addition
                    await window.adminDashboard.logActivity('update', 'follow_up_task', followUpId, {
                        action_type: 'note_added',
                        note_content: note.trim(),
                        added_by: adminName
                    });

                    alert('Note added successfully!');
                    // Refresh the modal view
                    viewFollowUp(followUpId);
                } catch (error) {
                    console.error('Error adding note:', error);
                    alert('Error adding note: ' + error.message);
                }
            }
        }
        
        async function tryFixUserPermissions() {
            if (!window.adminDashboard) {
                alert('Dashboard not ready');
                return;
            }

            const confirmed = confirm(
                'This will attempt to fix user management permissions.\n\n' +
                'It will try to:\n' +
                '1. Disable RLS temporarily\n' +
                '2. Check your admin role\n' +
                '3. Reload user data\n\n' +
                'Continue?'
            );

            if (!confirmed) return;

            try {
                // Try to check user role first
                const { data: currentAdmin, error } = await window.adminDashboard.supabase
                    .from('admin_users')
                    .select('role, is_active')
                    .eq('user_id', window.adminDashboard.currentUser.id)
                    .single();

                if (error) {
                    throw new Error(`Cannot verify your admin role: ${error.message}`);
                }

                if (!currentAdmin || !currentAdmin.is_active) {
                    throw new Error('Your admin account is not active');
                }

                if (currentAdmin.role !== 'super_admin') {
                    alert(`Your role is: ${currentAdmin.role}\n\nOnly super_admin can manage users.`);
                    return;
                }

                // If we get here, try to reload users
                await window.adminDashboard.loadUsersData();
                
            } catch (error) {
                console.error('‚ùå Fix attempt failed:', error);
                alert(`Fix failed: ${error.message}\n\nYou may need to run the SQL fix in Supabase.`);
            }
        }
    
        // === ENHANCED GLOBAL EXPORT FUNCTIONS ===

        // Initialize export manager when dashboard is ready
        function initializeExportManager() {
            if (window.adminDashboard && !window.adminDashboard.exportManager) {
                window.adminDashboard.exportManager = new ExportManager(window.adminDashboard);
                console.log('‚úÖ Export manager initialized');
            }
        }

        // Enhanced export functions
        function exportSurveys(format) {
            const dropdown = document.querySelector('.export-dropdown');
            if (dropdown) dropdown.classList.remove('show');
            
            initializeExportManager();
            
            if (window.adminDashboard?.exportManager) {
                window.adminDashboard.exportManager.exportSurveys(format, true);
            } else {
                alert('Export system not ready. Please refresh the page.');
            }
        }

        function exportRecentSurveys(format = 'excel') {
            closeAllDropdowns();
            initializeExportManager();
            
            if (window.adminDashboard?.exportManager) {
                window.adminDashboard.supabase
                    .from('patient_survey_responses')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(10)
                    .then(({ data, error }) => {
                        if (error) {
                            window.adminDashboard.showError('Error fetching recent surveys: ' + error.message);
                            return;
                        }
                        
                        const originalFiltered = window.adminDashboard.filteredData;
                        window.adminDashboard.filteredData = data;
                        
                        window.adminDashboard.exportManager.exportSurveys(format, true).then(() => {
                            window.adminDashboard.filteredData = originalFiltered;
                        });
                    });
            } else {
                alert('Export system not ready. Please refresh the page.');
            }
        }

        function exportFollowUps(format = 'excel') {
            initializeExportManager();
            
            if (window.adminDashboard?.exportManager) {
                window.adminDashboard.exportManager.exportFollowUps(format);
            } else {
                alert('Export system not ready. Please refresh the page.');
            }
        }

        function exportAnalytics(format = 'excel') {
            initializeExportManager();
            
            if (window.adminDashboard?.exportManager) {
                window.adminDashboard.exportManager.exportAnalytics(format);
            } else {
                alert('Export system not ready. Please refresh the page.');
            }
        }

        function exportCustomRange() {
            const startDate = prompt('Enter start date (YYYY-MM-DD):');
            const endDate = prompt('Enter end date (YYYY-MM-DD):');
            
            if (!startDate || !endDate) return;
            
            initializeExportManager();
            
            if (window.adminDashboard?.exportManager) {
                window.adminDashboard.supabase
                    .from('patient_survey_responses')
                    .select('*')
                    .gte('created_at', startDate + 'T00:00:00')
                    .lte('created_at', endDate + 'T23:59:59')
                    .order('created_at', { ascending: false })
                    .then(({ data, error }) => {
                        if (error) {
                            alert('Error fetching custom range: ' + error.message);
                            return;
                        }
                        
                        window.adminDashboard.filteredData = data;
                        window.adminDashboard.exportManager.exportSurveys('excel', true);
                    });
            }
        }

        function toggleExportDropdown(button) {
            // Close all other dropdowns first
            document.querySelectorAll('.export-dropdown').forEach(dropdown => {
                if (dropdown !== button.parentElement) {
                    dropdown.classList.remove('show');
                }
            });
            
            // Toggle the clicked dropdown
            button.parentElement.classList.toggle('show');
        }

        function closeAllDropdowns() {
            document.querySelectorAll('.export-dropdown.show').forEach(dropdown => {
                dropdown.classList.remove('show');
            });
        }

        // Enhanced event listener setup
        document.addEventListener('click', function(event) {
            if (!event.target.matches('.btn') && !event.target.closest('.export-dropdown')) {
                closeAllDropdowns();
            }
        });

        // Initialize export manager on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Wait for dashboard to be ready
            const checkDashboard = setInterval(() => {
                if (window.adminDashboard) {
                    initializeExportManager();
                    clearInterval(checkDashboard);
                }
            }, 1000);
        });

        // Keyboard shortcuts for exports
        document.addEventListener('keydown', function(event) {
            // Ctrl+E for quick export
            if (event.ctrlKey && event.key === 'e') {
                event.preventDefault();
                const activeTab = document.querySelector('.nav-tab.active')?.dataset.tab;
                
                switch (activeTab) {
                    case 'surveys':
                        exportSurveys('excel');
                        break;
                    case 'follow-ups':
                        exportFollowUps('excel');
                        break;
                    case 'analytics':
                        exportAnalytics('excel');
                        break;
                    default:
                        exportRecentSurveys('excel');
                }
            }
        });
    </script>
</body>
</html>
