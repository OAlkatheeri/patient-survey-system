<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinic Survey Admin Dashboard</title>
    
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <!-- Export libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Auth Screen Styles */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .auth-form {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 450px;
        }

        .auth-form h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c5aa0;
            font-size: 28px;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
            background: #f1f5f9;
            border-radius: 8px;
            padding: 4px;
        }

        .auth-tab {
            flex: 1;
            background: none;
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #64748b;
        }

        .auth-tab.active {
            background: white;
            color: #2c5aa0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #2c5aa0;
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
        }

        .form-group small {
            color: #64748b;
            font-size: 14px;
        }

        .btn-primary {
            width: 100%;
            background: linear-gradient(135deg, #2c5aa0 0%, #1e3a8a 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(44, 90, 160, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .error-message {
            color: #dc2626;
            background: #fee2e2;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .success-message {
            color: #059669;
            background: #d1fae5;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        /* Dashboard Layout */
        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #2c5aa0;
            font-size: 24px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info .role-badge {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .btn-logout {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
        }

        .btn-logout:hover {
            background: #dc2626;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            padding: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            overflow-x: auto;
        }

        .nav-tab {
            background: none;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
            color: #64748b;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #2c5aa0 0%, #1e3a8a 100%);
            color: white;
        }

        .nav-tab:hover:not(.active) {
            background: #f1f5f9;
            color: #2c5aa0;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border-left: 4px solid;
        }

        .stat-card.primary { border-color: #2c5aa0; }
        .stat-card.success { border-color: #10b981; }
        .stat-card.warning { border-color: #f59e0b; }
        .stat-card.danger { border-color: #ef4444; }

        .stat-card h3 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-card p {
            color: #64748b;
            font-weight: 500;
        }

        .stat-card .trend {
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
        }

        .trend.up { color: #10b981; }
        .trend.down { color: #ef4444; }

        /* Tables */
        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .table-header {
            padding: 20px 25px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .table-header h3 {
            color: #1e293b;
            font-size: 18px;
        }

        .table-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px 25px;
            text-align: left;
            border-bottom: 1px solid #f1f5f9;
        }

        th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        tbody tr:hover {
            background: #f8fafc;
        }

        /* Charts */
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .chart-container h3 {
            margin-bottom: 20px;
            color: #1e293b;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
        }

        /* Buttons */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-primary { background: #2c5aa0; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-secondary { background: #6b7280; color: white; }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Status badges */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending { background: #fef3c7; color: #92400e; }
        .status-completed { background: #d1fae5; color: #065f46; }
        .status-high { background: #fee2e2; color: #991b1b; }
        .status-medium { background: #fef3c7; color: #92400e; }
        .status-low { background: #d1fae5; color: #065f46; }

        /* Loading spinner */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #2c5aa0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Filters */
        .filters {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #2c5aa0;
        }

        /* Enhanced Clinic Select Styling */
        .clinic-select {
            position: relative;
        }

        .clinic-select select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .clinic-select select:focus {
            outline: none;
            border-color: #2c5aa0;
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
        }

        .clinic-select select:hover {
            border-color: #94a3b8;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 20px;
            border-radius: 12px;
            width: 95%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .modal-header h3 {
            margin: 0;
            color: #1e293b;
            font-size: 1.25rem;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e2e8f0;
        }

        /* Survey Detail Modal Styles */
        .survey-detail-container {
            max-height: 70vh;
            overflow-y: auto;
            padding-right: 10px;
        }

        .detail-section {
            margin-bottom: 25px;
            background: #f8fafc;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e2e8f0;
        }

        .section-title {
            margin: 0 0 15px 0;
            color: #1e293b;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 8px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .detail-item.full-width {
            grid-column: 1 / -1;
        }

        .detail-item label {
            font-weight: 600;
            color: #475569;
            font-size: 0.9rem;
        }

        .detail-item span {
            color: #1e293b;
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            min-height: 38px;
            display: flex;
            align-items: center;
        }

        .satisfaction-rating {
            font-weight: 600;
            text-transform: capitalize;
        }

        .comments-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .comment-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .comment-item h4 {
            margin: 0 0 10px 0;
            color: #1e293b;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .comment-text {
            margin: 0;
            color: #374151;
            line-height: 1.6;
            background: #f8fafc;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid #e2e8f0;
        }

        .comment-text.positive {
            border-left-color: #10b981;
            background: #f0fdf4;
        }

        .comment-text.improvement {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }

        /* Mobile responsiveness for survey details */
        @media (max-width: 768px) {
            .survey-detail-container {
                max-height: 60vh;
            }

            .detail-grid {
                grid-template-columns: 1fr;
            }

            .detail-section {
                padding: 15px;
            }

            .section-title {
                font-size: 1rem;
            }
        }

        /* Alert styles */
        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #3b82f6;
        }

        /* Export dropdown */
        .export-dropdown {
            position: relative;
            display: inline-block;
        }

        .export-dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 200px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1000;
            border-radius: 6px;
            right: 0;
            border: 1px solid #e5e7eb;
        }

        .export-dropdown-content a {
            color: #374151;
            padding: 10px 15px;
            text-decoration: none;
            display: block;
            font-size: 14px;
            border-bottom: 1px solid #f1f5f9;
            transition: background-color 0.2s;
        }

        .export-dropdown-content a:last-child {
            border-bottom: none;
        }

        .export-dropdown-content a:hover {
            background-color: #f8fafc;
            color: #2c5aa0;
        }

        .export-dropdown.show .export-dropdown-content {
            display: block;
        }

        /* Screen Reader Only Content */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Focus styles for accessibility */
        button:focus,
        input:focus,
        select:focus,
        .nav-tab:focus {
            outline: 2px solid #2c5aa0;
            outline-offset: 2px;
        }

        /* Skip link for keyboard navigation */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 6px;
            background: #2c5aa0;
            color: white;
            padding: 8px;
            text-decoration: none;
            z-index: 1000;
            border-radius: 4px;
        }

        .skip-link:focus {
            top: 6px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                justify-content: flex-start;
            }

            table {
                font-size: 14px;
            }

            th, td {
                padding: 10px 15px;
            }

            .chart-grid {
                grid-template-columns: 1fr;
            }

            .table-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            /* Mobile table improvements */
            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            thead {
                display: none;
            }

            tbody {
                display: block;
            }

            tr {
                display: block;
                border: 1px solid #e2e8f0;
                margin-bottom: 10px;
                border-radius: 8px;
                background: white;
            }

            td {
                display: block;
                text-align: left !important;
                border: none;
                padding: 10px 15px;
                position: relative;
                padding-left: 40%;
            }

            td:before {
                content: attr(data-label);
                position: absolute;
                left: 15px;
                font-weight: 600;
                color: #64748b;
                font-size: 12px;
                text-transform: uppercase;
            }

            .auth-form {
                padding: 20px;
                margin: 10px;
            }

            .stats-grid {
                gap: 10px;
            }

            .stat-card {
                padding: 15px;
            }
        }

        /* Extra small devices */
        @media (max-width: 480px) {
            .container {
                padding: 5px;
            }

            .auth-form {
                padding: 15px;
                margin: 5px;
            }

            .header {
                padding: 10px;
            }

            .modal-content {
                margin: 2% auto;
                padding: 15px;
                width: 95%;
            }
        }
    </style>
</head>
<body>
    <!-- Skip link for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <!-- Authentication Screen -->
    <div id="authScreen" class="auth-container">
        <div class="auth-form">
            <h1>üè• Admin Portal</h1>
            
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login')">Sign In</button>
                <button class="auth-tab" onclick="switchAuthTab('register')">Register</button>
            </div>

            <div id="authError" class="error-message" style="display: none;"></div>
            <div id="authSuccess" class="success-message" style="display: none;"></div>

            <!-- Login Form -->
            <form id="loginForm" style="display: block;" role="form" aria-label="Admin login form">
                <div class="form-group">
                    <label for="loginEmail">Email Address</label>
                    <input type="email" id="loginEmail" required placeholder="admin@clinic.com" 
                           aria-describedby="loginEmailHelp" autocomplete="email">
                    <div id="loginEmailHelp" class="sr-only">Enter your admin email address</div>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" required placeholder="Enter your password" 
                           aria-describedby="loginPasswordHelp" autocomplete="current-password">
                    <div id="loginPasswordHelp" class="sr-only">Enter your admin password</div>
                </div>
                <button type="submit" class="btn-primary" aria-describedby="loginSubmitHelp">Sign In</button>
                <div id="loginSubmitHelp" class="sr-only">Submit login form</div>
            </form>

            <!-- Register Form -->
            <form id="registerForm" style="display: none;">
                <div class="form-group">
                    <label for="registerUsername">Username</label>
                    <input type="text" id="registerUsername" required placeholder="johndoe">
                </div>
                <div class="form-group">
                    <label for="registerName">Full Name</label>
                    <input type="text" id="registerName" required placeholder="John Doe">
                </div>
                <div class="form-group">
                    <label for="registerEmail">Email Address</label>
                    <input type="email" id="registerEmail" required placeholder="john@clinic.com">
                </div>
                <div class="form-group">
                    <label for="registerPassword">Password</label>
                    <input type="password" id="registerPassword" required placeholder="Create your login password" minlength="6">
                    <small>This will be your personal login password.</small>
                </div>
                <div class="form-group">
                    <label for="registerRole">Role</label>
                    <select id="registerRole" required>
                        <option value="user">User (View Only)</option>
                        <option value="admin">Admin (Clinic Manager)</option>
                        <option value="super_admin">Super Admin (System Admin)</option>
                    </select>
                    <small>Contact your system administrator to request elevated permissions.</small>
                </div>
                <button type="submit" class="btn-primary">Create Account</button>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <h1>üìä Clinic Survey Dashboard</h1>
                <div class="user-info">
                    <span id="userName">Loading...</span>
                    <span id="userRole" class="role-badge">User</span>
                    <button id="logoutBtn" class="btn-logout">Logout</button>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="nav-tabs">
                <button class="nav-tab active" data-tab="overview">üìà Overview</button>
                <button class="nav-tab" data-tab="surveys">üìã All Surveys</button>
                <button class="nav-tab" data-tab="analytics">üìä Analytics</button>
                <button class="nav-tab" data-tab="follow-ups">üìû Follow-ups</button>
                <button class="nav-tab" data-tab="clinics">üè• Clinics</button>
                <button class="nav-tab" data-tab="users">üë• Users</button>
                <button class="nav-tab" data-tab="settings">‚öôÔ∏è Settings</button>
            </div>

            <!-- Overview Tab -->
            <div id="overview" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card primary">
                        <h3 id="totalSurveys">0</h3>
                        <p>Total Surveys Today</p>
                        <div class="trend up" id="surveyTrend">Loading...</div>
                    </div>
                    <div class="stat-card success">
                        <h3 id="avgSatisfaction">0.0</h3>
                        <p>Average Satisfaction</p>
                        <div class="trend up" id="satisfactionTrend">Loading...</div>
                    </div>
                    <div class="stat-card warning">
                        <h3 id="pendingFollowUps">0</h3>
                        <p>Pending Follow-ups</p>
                        <div class="trend down" id="followUpTrend">Loading...</div>
                    </div>
                    <div class="stat-card danger">
                        <h3 id="dissatisfiedCount">0</h3>
                        <p>Dissatisfied Patients</p>
                        <div class="trend down" id="dissatisfiedTrend">Loading...</div>
                    </div>
                </div>

                <!-- Recent Surveys -->
                <div class="table-container">
                    <div class="table-header">
                        <h3>Recent Survey Responses</h3>
                        <div class="table-actions">
                            <button class="btn btn-primary btn-sm" onclick="refreshData()">üîÑ Refresh</button>
                            <div class="export-dropdown">
                                <button class="btn btn-success btn-sm" onclick="toggleExportDropdown(this)">üì• Export Recent ‚ñº</button>
                                <div class="export-dropdown-content">
                                    <a href="#" onclick="exportRecentSurveys('excel')">üìä Excel Report</a>
                                    <a href="#" onclick="exportRecentSurveys('csv')">üìã CSV Data</a>
                                    <a href="#" onclick="exportRecentSurveys('pdf')">üìÑ PDF Report</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Patient Name</th>
                                <th>Contact Info</th>
                                <th>Clinic</th>
                                <th>Overall Rating</th>
                                <th>Visit Date</th>
                                <th>Submitted</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recentSurveysTable">
                            <tr>
                                <td colspan="7" class="loading">
                                    <div class="spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- All Surveys Tab -->
            <div id="surveys" class="tab-content">
                <div class="filters">
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label>Clinic</label>
                            <select id="clinicFilter">
                                <option value="">All Clinics</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Date Range</label>
                            <select id="dateRangeFilter">
                                <option value="today">Today</option>
                                <option value="yesterday">Yesterday</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="quarter">This Quarter</option>
                                <option value="year">This Year</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        <div class="filter-group" id="customDateGroup" style="display: none;">
                            <label>From Date</label>
                            <input type="date" id="startDate">
                        </div>
                        <div class="filter-group" id="customDateGroup2" style="display: none;">
                            <label>To Date</label>
                            <input type="date" id="endDate">
                        </div>
                        <div class="filter-group">
                            <label>Satisfaction Level</label>
                            <select id="satisfactionFilter">
                                <option value="">All Ratings</option>
                                <option value="low">Dissatisfied</option>
                                <option value="medium">Satisfied</option>
                                <option value="high">Very Satisfied</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-header">
                        <h3>All Survey Responses</h3>
                        <div class="table-actions">
                            <div class="export-dropdown">
                                <button class="btn btn-success btn-sm" onclick="toggleExportDropdown(this)">üì• Export Data ‚ñº</button>
                                <div class="export-dropdown-content">
                                    <a href="#" onclick="exportSurveys('excel')">üìä Excel Report (Multi-Sheet)</a>
                                    <a href="#" onclick="exportSurveys('csv')">üìã CSV Data</a>
                                    <a href="#" onclick="exportSurveys('pdf')">üìÑ PDF Report</a>
                                    <a href="#" onclick="exportSurveys('json')">üîß JSON Data</a>
                                    <hr style="margin: 5px 0;">
                                    <a href="#" onclick="exportCustomRange()">üìÖ Custom Date Range</a>
                                    <a href="#" onclick="exportAnalytics()">üìà Analytics Report</a>
                                </div>
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="loadSurveysData()">üîÑ Refresh</button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Survey ID</th>
                                <th>Patient Name</th>
                                <th>Contact Info</th>
                                <th>Clinic</th>
                                <th>Overall Rating</th>
                                <th>Visit Date</th>
                                <th>Follow-up</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="allSurveysTable">
                            <tr>
                                <td colspan="8" class="loading">
                                    <div class="spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics" class="tab-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="totalResponsesMetric">0</h3>
                        <p>Total Responses (30 days)</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="avgOverallMetric">0.0</h3>
                        <p>Average Overall Rating</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="satisfactionRateMetric">0%</h3>
                        <p>Satisfaction Rate</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="responseRateMetric">0%</h3>
                        <p>Follow-up Request Rate</p>
                    </div>
                </div>

                <div class="chart-grid">
                    <div class="chart-container">
                        <h3>Satisfaction Trends (Last 7 Days)</h3>
                        <canvas id="satisfactionChart" width="400" height="200"></canvas>
                    </div>

                    <div class="chart-container">
                        <h3>Clinic Performance</h3>
                        <canvas id="clinicChart" width="400" height="200"></canvas>
                    </div>

                    <div class="chart-container">
                        <h3>Wait Time Distribution</h3>
                        <canvas id="waitTimeChart" width="400" height="200"></canvas>
                    </div>

                    <div class="chart-container">
                        <h3>Rating Distribution</h3>
                        <canvas id="ratingChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>

            <!-- Follow-ups Tab -->
            <div id="follow-ups" class="tab-content">
                <div class="table-container">
                    <div class="table-header">
                        <h3>Follow-up Tasks</h3>
                        <div class="table-actions">
                            <button class="btn btn-primary btn-sm" onclick="loadFollowUpsData()">üîÑ Refresh</button>
                            <div class="export-dropdown">
                                <button class="btn btn-success btn-sm" onclick="toggleExportDropdown(this)">üì• Export Tasks ‚ñº</button>
                                <div class="export-dropdown-content">
                                    <a href="#" onclick="exportFollowUps('excel')">üìä Excel Report</a>
                                    <a href="#" onclick="exportFollowUps('csv')">üìã CSV Data</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Patient</th>
                                <th>Clinic</th>
                                <th>Priority</th>
                                <th>Assigned To</th>
                                <th>Status</th>
                                <th>Survey Rating</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="followUpsTable">
                            <tr>
                                <td colspan="8" class="loading">
                                    <div class="spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Clinics Tab -->
            <div id="clinics" class="tab-content">
                <div class="table-container">
                    <div class="table-header">
                        <h3>Clinic Management</h3>
                        <div class="table-actions">
                            <button class="btn btn-primary btn-sm" onclick="addNewClinic()">‚ûï Add Clinic</button>
                            <button class="btn btn-secondary btn-sm" onclick="loadClinicsData()">üîÑ Refresh</button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Clinic Name</th>
                                <th>Location</th>
                                <th>Contact Info</th>
                                <th>Manager/Responsible</th>
                                <th>Department Count</th>
                                <th>Survey Count</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="clinicsTable">
                            <tr>
                                <td colspan="8" class="loading">
                                    <div class="spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Add/Edit Clinic Modal -->
                <div id="clinicModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 id="clinicModalTitle">Add New Clinic</h3>
                            <span class="close" onclick="closeClinicModal()">&times;</span>
                        </div>
                        <form id="clinicForm">
                            <div class="form-group">
                                <label for="clinicName">Clinic Name *</label>
                                <input type="text" id="clinicName" required 
                                       placeholder="Enter clinic name">
                            </div>
                            <div class="form-group">
                                <label for="clinicLocation">Location *</label>
                                <input type="text" id="clinicLocation" required 
                                       placeholder="Enter clinic location/address">
                            </div>
                            <div class="form-group">
                                <label for="clinicPhone">Phone Number</label>
                                <input type="tel" id="clinicPhone" 
                                       placeholder="+971-XX-XXXXXXX">
                            </div>
                            <div class="form-group">
                                <label for="clinicEmail">Email Address</label>
                                <input type="email" id="clinicEmail" 
                                       placeholder="clinic@example.com">
                            </div>
                            <div class="form-group">
                                <label for="clinicManager">Manager/Responsible Person *</label>
                                <select id="clinicManager" required>
                                    <option value="">Select Manager</option>
                                    <!-- Options will be populated dynamically -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="clinicDepartments">Departments (comma-separated)</label>
                                <textarea id="clinicDepartments" rows="3" 
                                          placeholder="General Medicine, Cardiology, Pediatrics..."></textarea>
                                <small>Enter department names separated by commas</small>
                            </div>
                            <div class="form-group">
                                <label for="clinicDescription">Description</label>
                                <textarea id="clinicDescription" rows="3" 
                                          placeholder="Brief description of the clinic..."></textarea>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="clinicActive" checked>
                                    Active (visible in surveys)
                                </label>
                            </div>
                            <div class="modal-actions">
                                <button type="button" class="btn btn-secondary" onclick="closeClinicModal()">Cancel</button>
                                <button type="submit" class="btn btn-primary">Save Clinic</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="users" class="tab-content">
                <div class="table-container">
                    <div class="table-header">
                        <h3>System Users</h3>
                        <div class="table-actions">
                            <button class="btn btn-secondary btn-sm" onclick="loadUsersData()">üîÑ Refresh</button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Last Login</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable">
                            <tr>
                                <td colspan="7" class="loading">
                                    <div class="spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <div class="table-container">
                    <div class="table-header">
                        <h3>System Settings</h3>
                    </div>
                    <div style="padding: 25px;">
                        <div class="filters-grid">
                            <div class="filter-group">
                                <label>Survey Auto-restart Time (seconds)</label>
                                <input type="number" id="autoRestartTime" value="30" min="10" max="300" disabled>
                            </div>
                            <div class="filter-group">
                                <label>Low Rating Threshold</label>
                                <select id="lowRatingThreshold" disabled>
                                    <option value="dissatisfied">Dissatisfied</option>
                                    <option value="very_dissatisfied">Very Dissatisfied</option>
                                </select>
                            </div>
                        </div>
                        <p style="margin-top: 20px; color: #64748b;">Settings are configured in the system and cannot be changed here.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Survey Detail Modal -->
    <div id="surveyModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeSurveyModal()">&times;</span>
            <h2>Survey Details</h2>
            <div id="surveyDetails"></div>
        </div>
    </div>

    <!-- Follow-up Task Modal -->
    <div id="followUpModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeFollowUpModal()">&times;</span>
            <h2>Follow-up Task</h2>
            <div id="followUpDetails"></div>
        </div>
    </div>

    <script>
        // üîß SUPABASE CONFIGURATION - Environment-based configuration
        const SUPABASE_CONFIG = {
            url: 'https://uaznsgkixgedgfaxxkkw.supabase.co',
            // Using public anonymous key - safe for client-side use
            anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhem5zZ2tpeGdlZGdmYXh4a2t3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzMzI5NTIsImV4cCI6MjA2ODkwODk1Mn0.AEnTidWKltCIe701dYeWXCeUDbNJncYKStt4xQeDnXc'
        };

        // Security Note: This should be the anonymous key, not service_role key
        // Service role keys should never be exposed in client-side code

        class AdminDashboard {
            constructor() {
                this.supabase = null;
                this.currentUser = null;
                this.currentSystemUser = null;
                this.charts = {};
                this.filteredData = [];
                this.currentFilters = {};
                this.init();
            }

            init() {
                try {
                    this.initSupabase();
                    this.setupEventListeners();
                    this.checkAuthStatus();
                } catch (error) {
                    console.error('‚ùå Initialization error:', error);
                    this.showError('Failed to initialize dashboard. Please refresh the page.');
                }
            }

            initSupabase() {
                try {
                    if (typeof supabase !== 'undefined') {
                        this.supabase = supabase.createClient(
                            SUPABASE_CONFIG.url,
                            SUPABASE_CONFIG.anonKey
                        );
                        console.log('‚úÖ Supabase initialized');
                    } else {
                        console.error('‚ùå Supabase client not loaded');
                        this.showError('Supabase client not available. Please check your configuration.');
                    }
                } catch (error) {
                    console.error('‚ùå Supabase initialization error:', error);
                    this.showError('Failed to initialize Supabase connection.');
                }
            }

            setupEventListeners() {
                // Login form
                const loginForm = document.getElementById('loginForm');
                if (loginForm) {
                    loginForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleLogin();
                    });
                }

                // Register form
                const registerForm = document.getElementById('registerForm');
                if (registerForm) {
                    registerForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleRegister();
                    });
                }

                // Logout button
                const logoutBtn = document.getElementById('logoutBtn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', () => this.handleLogout());
                }

                // Tab navigation
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.addEventListener('click', () => this.switchTab(tab.dataset.tab));
                });

                // Clinic form
                const clinicForm = document.getElementById('clinicForm');
                if (clinicForm) {
                    clinicForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleClinicSubmit();
                    });
                }

                // Close modal when clicking outside
                window.addEventListener('click', (e) => {
                    const clinicModal = document.getElementById('clinicModal');
                    if (e.target === clinicModal) {
                        this.closeClinicModal();
                    }
                });

                // Filter change handlers
                const dateRangeFilter = document.getElementById('dateRangeFilter');
                if (dateRangeFilter) {
                    dateRangeFilter.addEventListener('change', this.handleDateRangeChange.bind(this));
                }

                // Auto-refresh dashboard data every 5 minutes
                setInterval(() => {
                    if (this.currentUser) {
                        this.refreshData();
                    }
                }, 300000);
            }

            async checkAuthStatus() {
                try {
                    if (!this.supabase) {
                        this.showAuth();
                        return;
                    }

                    const { data: { session }, error } = await this.supabase.auth.getSession();
                    
                    if (error) {
                        console.error('‚ùå Auth session error:', error);
                        this.showAuth();
                        return;
                    }
                    
                    if (session) {
                        console.log('‚úÖ Active session found:', session.user.email);
                        await this.handleAuthSuccess(session.user);
                    } else {
                        console.log('‚ÑπÔ∏è No active session, showing auth');
                        this.showAuth();
                    }
                } catch (error) {
                    console.error('‚ùå Auth check error:', error);
                    this.showAuth();
                    this.showError(`Authentication check failed: ${error.message}`);
                }
            }

            async handleLogin() {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                const submitBtn = document.querySelector('#loginForm button[type="submit"]');

                try {
                    this.hideMessages();
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Signing In...';

                    const { data, error } = await this.supabase.auth.signInWithPassword({
                        email,
                        password
                    });

                    if (error) throw error;

                    await this.handleAuthSuccess(data.user);
                } catch (error) {
                    console.error('‚ùå Login error:', error);
                    this.showError(error.message || 'Login failed. Please try again.');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Sign In';
                }
            }

            async handleRegister() {
                const username = document.getElementById('registerUsername').value;
                const name = document.getElementById('registerName').value;
                const email = document.getElementById('registerEmail').value;
                const password = document.getElementById('registerPassword').value;
                const role = document.getElementById('registerRole').value;
                const submitBtn = document.querySelector('#registerForm button[type="submit"]');

                try {
                    this.hideMessages();
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Creating Account...';

                    // Create auth user
                    const { data: authData, error: authError } = await this.supabase.auth.signUp({
                        email,
                        password,
                        options: {
                            data: {
                                username: username,
                                full_name: name,
                                role: role
                            }
                        }
                    });

                    if (authError) throw authError;

                    if (authData.user) {
                        // Create user in users table
                        const { error: userError } = await this.supabase
                            .from('users')
                            .insert({
                                auth_user_id: authData.user.id,
                                username: username,
                                email: email,
                                full_name: name,
                                role: role,
                                is_active: true
                            });

                        if (userError) {
                            console.error('User creation error:', userError);
                            // Don't throw here - user was created in auth
                        }

                        this.showSuccess('Account created successfully! Please sign in.');
                        switchAuthTab('login');
                        document.getElementById('loginEmail').value = email;
                    }

                } catch (error) {
                    console.error('‚ùå Registration error:', error);
                    this.showError(error.message || 'Registration failed. Please try again.');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Create Account';
                }
            }

            async handleAuthSuccess(user) {
                try {
                    this.currentUser = user;
                    console.log('üîç Checking system user for:', user.email);

                    // Get user details from users table
                    const { data: systemUser, error } = await this.supabase
                        .from('users')
                        .select('*')
                        .eq('auth_user_id', user.id)
                        .maybeSingle();

                    if (error) {
                        console.error('‚ùå Error querying users:', error);
                        throw new Error(`Database error: ${error.message}`);
                    }

                    if (!systemUser) {
                        throw new Error('User account not found in system. Please contact administrator.');
                    }

                    if (!systemUser.is_active) {
                        throw new Error('Your account has been disabled. Please contact administrator.');
                    }

                    this.currentSystemUser = systemUser;
                    console.log('‚úÖ System user found:', systemUser.full_name, `(${systemUser.role})`);

                    // Update last login
                    await this.supabase
                        .from('users')
                        .update({ last_login: new Date().toISOString() })
                        .eq('id', systemUser.id);

                    this.showDashboard();
                    await this.loadDashboardData();
                    
                    // Clear forms
                    this.clearAuthForms(true, true);
                } catch (error) {
                    console.error('‚ùå Auth success handling error:', error);
                    this.showError(error.message);
                    if (this.supabase) {
                        await this.supabase.auth.signOut();
                    }
                    this.showAuth();
                }
            }

            async handleLogout() {
                try {
                    await this.supabase.auth.signOut();
                    this.currentUser = null;
                    this.currentSystemUser = null;
                    this.showAuth();
                    this.clearAuthForms(true, true);
                } catch (error) {
                    console.error('‚ùå Logout error:', error);
                }
            }

            showAuth() {
                document.getElementById('authScreen').style.display = 'flex';
                document.getElementById('dashboard').classList.remove('active');
            }

            showDashboard() {
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('dashboard').classList.add('active');
                
                // Update user info
                document.getElementById('userName').textContent = this.currentSystemUser.full_name;
                document.getElementById('userRole').textContent = this.currentSystemUser.role.replace('_', ' ').toUpperCase();
            }

            switchTab(tabName) {
                // Update tab buttons
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

                // Update tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabName).classList.add('active');

                // Load tab-specific data
                this.loadTabData(tabName);
            }

            async loadTabData(tabName) {
                try {
                    switch (tabName) {
                        case 'overview':
                            await this.loadOverviewData();
                            break;
                        case 'surveys':
                            await this.loadSurveysData();
                            break;
                        case 'analytics':
                            await this.loadAnalyticsData();
                            break;
                        case 'follow-ups':
                            await this.loadFollowUpsData();
                            break;
                        case 'clinics':
                            await this.loadClinicsData();
                            break;
                        case 'users':
                            await this.loadUsersData();
                            break;
                        case 'settings':
                            // Settings are static in this version
                            break;
                    }
                } catch (error) {
                    console.error(`‚ùå Error loading ${tabName} data:`, error);
                    this.showError(`Failed to load ${tabName} data`);
                }
            }

            async loadDashboardData() {
                await this.loadOverviewData();
                await this.populateFilterOptions();
            }

            async loadOverviewData() {
                try {
                    console.log('üîÑ Loading overview data...');
                    
                    // Get user's accessible clinics
                    const { data: userClinics } = await this.supabase
                        .rpc('get_user_accessible_clinics');
                    
                    const clinicIds = userClinics?.map(c => c.clinic_id) || [];
                    
                    // Get today's date range
                    const today = new Date();
                    const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                    const endOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1);

                    // Build query based on user role
                    let query = this.supabase
                        .from('clinic_survey_responses')
                        .select('*')
                        .gte('created_at', startOfDay.toISOString())
                        .lt('created_at', endOfDay.toISOString());

                    // Apply clinic filter for non-super admins
                    if (this.currentSystemUser.role !== 'super_admin' && clinicIds.length > 0) {
                        query = query.in('patient_info->>clinic_location', clinicIds);
                    }

                    const { data: todaySurveys, error: todayError } = await query;

                    if (todayError) {
                        console.error('‚ùå Error fetching today surveys:', todayError);
                        throw todayError;
                    }

                    // Get all surveys for averages (last 7 days)
                    const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                    
                    let allQuery = this.supabase
                        .from('clinic_survey_responses')
                        .select('*')
                        .gte('created_at', sevenDaysAgo.toISOString());

                    if (this.currentSystemUser.role !== 'super_admin' && clinicIds.length > 0) {
                        allQuery = allQuery.in('patient_info->>clinic_location', clinicIds);
                    }

                    const { data: allSurveys } = await allQuery;

                    const surveysForStats = allSurveys || todaySurveys || [];

                    // Calculate stats
                    const totalSurveys = todaySurveys?.length || 0;
                    
                    // Map satisfaction values
                    const satisfactionMap = {
                        'very_satisfied': 5,
                        'satisfied': 4,
                        'neutral': 3,
                        'dissatisfied': 2,
                        'very_dissatisfied': 1
                    };
                    
                    const validRatings = surveysForStats.filter(s => {
                        const rating = s.responses?.overall_satisfaction;
                        return rating && satisfactionMap[rating];
                    });
                    
                    const avgSatisfaction = validRatings.length > 0 
                        ? (validRatings.reduce((sum, s) => sum + satisfactionMap[s.responses.overall_satisfaction], 0) / validRatings.length).toFixed(1)
                        : '0.0';
                    
                    // Count dissatisfied
                    const dissatisfiedCount = validRatings.filter(s => 
                        ['dissatisfied', 'very_dissatisfied'].includes(s.responses.overall_satisfaction)
                    ).length;

                    // Get pending follow-ups
                    let followUpQuery = this.supabase
                        .from('follow_up_tasks')
                        .select('*')
                        .eq('status', 'pending');

                    if (this.currentSystemUser.role !== 'super_admin' && clinicIds.length > 0) {
                        followUpQuery = followUpQuery.in('clinic_id', clinicIds);
                    }

                    const { data: followUps } = await followUpQuery;
                    const pendingFollowUps = followUps?.length || 0;

                    // Update stats in UI
                    document.getElementById('totalSurveys').textContent = totalSurveys;
                    document.getElementById('avgSatisfaction').textContent = avgSatisfaction;
                    document.getElementById('pendingFollowUps').textContent = pendingFollowUps;
                    document.getElementById('dissatisfiedCount').textContent = dissatisfiedCount;

                    // Update trends
                    this.updateTrends(totalSurveys, avgSatisfaction, pendingFollowUps, dissatisfiedCount);

                    // Load recent surveys table
                    await this.loadRecentSurveys();

                } catch (error) {
                    console.error('‚ùå Error loading overview data:', error);
                    this.showError('Failed to load dashboard data: ' + error.message);
                }
            }

            updateTrends(totalSurveys, avgSatisfaction, pendingFollowUps, dissatisfiedCount) {
                document.getElementById('surveyTrend').textContent = totalSurveys > 0 
                    ? `${totalSurveys} surveys submitted today` 
                    : 'No surveys today yet';
                    
                document.getElementById('satisfactionTrend').textContent = avgSatisfaction !== '0.0' 
                    ? `Average over last 7 days` 
                    : 'No rating data yet';
                    
                document.getElementById('followUpTrend').textContent = pendingFollowUps > 0 
                    ? `${pendingFollowUps} tasks need attention` 
                    : 'All caught up!';
                    
                document.getElementById('dissatisfiedTrend').textContent = dissatisfiedCount > 0 
                    ? `${dissatisfiedCount} need attention` 
                    : 'Great job!';
            }

            async loadRecentSurveys() {
                try {
                    // Get user's accessible clinics
                    const { data: userClinics } = await this.supabase
                        .rpc('get_user_accessible_clinics');
                    
                    const clinicIds = userClinics?.map(c => c.clinic_id) || [];
                    
                    let query = this.supabase
                        .from('survey_responses_view')
                        .select('*')
                        .order('created_at', { ascending: false })
                        .limit(10);

                    // Apply clinic filter for non-super admins
                    if (this.currentSystemUser.role !== 'super_admin' && clinicIds.length > 0) {
                        query = query.in('clinic_id', clinicIds);
                    }

                    const { data: surveys, error } = await query;

                    if (error) throw error;

                    const tableBody = document.getElementById('recentSurveysTable');
                    
                    if (!surveys || surveys.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #64748b;">No surveys found</td></tr>';
                        return;
                    }

                    tableBody.innerHTML = surveys.map(survey => {
                        const overallRating = this.mapSatisfactionToNumber(survey.overall_satisfaction);
                        
                        return `
                            <tr>
                                <td data-label="Patient Name">${survey.patient_name || 'N/A'}</td>
                                <td data-label="Contact">
                                    <div style="font-size: 0.9em;">
                                        <div>${survey.patient_email || 'N/A'}</div>
                                        <div style="color: #64748b;">${survey.patient_phone || 'N/A'}</div>
                                    </div>
                                </td>
                                <td data-label="Clinic">${survey.clinic_name || 'N/A'}</td>
                                <td data-label="Satisfaction">
                                    <span class="status-badge ${this.getSatisfactionClass(overallRating)}">
                                        ${this.formatSatisfaction(survey.overall_satisfaction)}
                                    </span>
                                </td>
                                <td data-label="Visit Date">${survey.visit_date || 'N/A'}</td>
                                <td data-label="Submitted">${new Date(survey.created_at).toLocaleDateString()}</td>
                                <td data-label="Actions">
                                    <button class="btn btn-primary btn-sm" onclick="viewSurvey('${survey.response_id}')">View</button>
                                </td>
                            </tr>
                        `;
                    }).join('');

                } catch (error) {
                    console.error('‚ùå Error loading recent surveys:', error);
                    document.getElementById('recentSurveysTable').innerHTML = 
                        '<tr><td colspan="7" style="text-align: center; color: #dc2626;">Error loading surveys</td></tr>';
                }
            }

            mapSatisfactionToNumber(satisfaction) {
                const map = {
                    'very_satisfied': 5,
                    'satisfied': 4,
                    'neutral': 3,
                    'dissatisfied': 2,
                    'very_dissatisfied': 1
                };
                return map[satisfaction] || 0;
            }

            formatSatisfaction(satisfaction) {
                const formats = {
                    'very_satisfied': 'Very Satisfied',
                    'satisfied': 'Satisfied',
                    'neutral': 'Neutral',
                    'dissatisfied': 'Dissatisfied',
                    'very_dissatisfied': 'Very Dissatisfied'
                };
                return formats[satisfaction] || satisfaction || 'N/A';
            }

            getSatisfactionClass(rating) {
                if (rating >= 4) return 'status-high';
                if (rating === 3) return 'status-medium';
                return 'status-low';
            }

            async populateFilterOptions() {
                try {
                    // Get user's accessible clinics
                    const { data: userClinics } = await this.supabase
                        .rpc('get_user_accessible_clinics');
                    
                    const clinicFilter = document.getElementById('clinicFilter');
                    
                    // Clear existing options except "All Clinics"
                    while (clinicFilter.children.length > 1) {
                        clinicFilter.removeChild(clinicFilter.lastChild);
                    }
                    
                    userClinics?.forEach(clinic => {
                        const option = document.createElement('option');
                        option.value = clinic.clinic_id;
                        option.textContent = `${clinic.clinic_name} - ${clinic.clinic_location}`;
                        clinicFilter.appendChild(option);
                    });
                } catch (error) {
                    console.error('‚ùå Error populating filter options:', error);
                }
            }

            async loadSurveysData() {
                try {
                    console.log('üîÑ Loading surveys data with filters:', this.currentFilters);
                    
                    document.getElementById('allSurveysTable').innerHTML = 
                        '<tr><td colspan="8" class="loading"><div class="spinner"></div></td></tr>';
                    
                    // Get user's accessible clinics
                    const { data: userClinics } = await this.supabase
                        .rpc('get_user_accessible_clinics');
                    
                    const clinicIds = userClinics?.map(c => c.clinic_id) || [];
                    
                    let query = this.supabase
                        .from('survey_responses_view')
                        .select('*')
                        .order('created_at', { ascending: false });

                    // Apply clinic access filter
                    if (this.currentSystemUser.role !== 'super_admin' && clinicIds.length > 0) {
                        query = query.in('clinic_id', clinicIds);
                    }

                    // Apply user filters
                    query = this.applyFiltersToQuery(query);

                    const { data: surveys, error } = await query;

                    if (error) throw error;

                    this.filteredData = surveys || [];
                    this.renderSurveysTable(this.filteredData);

                } catch (error) {
                    console.error('‚ùå Error loading surveys data:', error);
                    this.showError('Failed to load surveys data: ' + error.message);
                }
            }
            
            renderSurveysTable(surveys) {
                const tableBody = document.getElementById('allSurveysTable');
                
                if (surveys.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #64748b;">No surveys found matching current filters</td></tr>';
                    return;
                }

                tableBody.innerHTML = surveys.map(survey => `
                    <tr>
                        <td data-label="Survey ID" title="${survey.response_id}">${survey.response_id.substring(0, 15)}...</td>
                        <td data-label="Patient Name">${survey.patient_name || 'N/A'}</td>
                        <td data-label="Contact Info">
                            <div style="font-size: 0.9em;">
                                <div>${survey.patient_email || 'N/A'}</div>
                                <div style="color: #64748b;">${survey.patient_phone || 'N/A'}</div>
                            </div>
                        </td>
                        <td data-label="Clinic">${survey.clinic_name || 'N/A'}</td>
                        <td data-label="Overall Rating">
                            <span class="status-badge ${this.getSatisfactionClass(this.mapSatisfactionToNumber(survey.overall_satisfaction))}">
                                ${this.formatSatisfaction(survey.overall_satisfaction)}
                            </span>
                        </td>
                        <td data-label="Visit Date">${survey.visit_date || 'N/A'}</td>
                        <td data-label="Follow-up">
                            <span class="status-badge ${survey.wants_contact ? 'status-pending' : 'status-completed'}">
                                ${survey.wants_contact ? 'Yes' : 'No'}
                            </span>
                        </td>
                        <td data-label="Actions">
                            <button class="btn btn-primary btn-sm" onclick="viewSurvey('${survey.response_id}')">View</button>
                        </td>
                    </tr>
                `).join('');
            }

            applyFiltersToQuery(query) {
                // Apply clinic filter
                if (this.currentFilters.clinic) {
                    query = query.eq('clinic_id', this.currentFilters.clinic);
                }

                // Apply date range filter
                if (this.currentFilters.dateRange && this.currentFilters.dateRange !== 'custom') {
                    const { startDate, endDate } = this.getDateRange(this.currentFilters.dateRange);
                    if (startDate && endDate) {
                        const startDateTime = new Date(startDate + 'T00:00:00').toISOString();
                        const endDateTime = new Date(endDate + 'T23:59:59').toISOString();
                        query = query
                            .gte('created_at', startDateTime)
                            .lte('created_at', endDateTime);
                    }
                }

                // Apply custom date range
                if (this.currentFilters.startDate && this.currentFilters.endDate) {
                    const startDateTime = new Date(this.currentFilters.startDate + 'T00:00:00').toISOString();
                    const endDateTime = new Date(this.currentFilters.endDate + 'T23:59:59').toISOString();
                    query = query
                        .gte('created_at', startDateTime)
                        .lte('created_at', endDateTime);
                }

                // Apply satisfaction filter
                if (this.currentFilters.satisfaction) {
                    switch (this.currentFilters.satisfaction) {
                        case 'low':
                            query = query.in('overall_satisfaction', ['dissatisfied', 'very_dissatisfied']);
                            break;
                        case 'medium':
                            query = query.eq('overall_satisfaction', 'satisfied');
                            break;
                        case 'high':
                            query = query.eq('overall_satisfaction', 'very_satisfied');
                            break;
                    }
                }

                return query;
            }

            getDateRange(range) {
                const today = new Date();
                let startDate, endDate;

                switch (range) {
                    case 'today':
                        startDate = endDate = today.toISOString().split('T')[0];
                        break;
                    case 'yesterday':
                        const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
                        startDate = endDate = yesterday.toISOString().split('T')[0];
                        break;
                    case 'week':
                        const weekStart = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                        startDate = weekStart.toISOString().split('T')[0];
                        endDate = today.toISOString().split('T')[0];
                        break;
                    case 'month':
                        const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                        startDate = monthStart.toISOString().split('T')[0];
                        endDate = today.toISOString().split('T')[0];
                        break;
                    case 'quarter':
                        const quarterStart = new Date(today.getFullYear(), Math.floor(today.getMonth() / 3) * 3, 1);
                        startDate = quarterStart.toISOString().split('T')[0];
                        endDate = today.toISOString().split('T')[0];
                        break;
                    case 'year':
                        const yearStart = new Date(today.getFullYear(), 0, 1);
                        startDate = yearStart.toISOString().split('T')[0];
                        endDate = today.toISOString().split('T')[0];
                        break;
                }

                return { startDate, endDate };
            }
            
            async loadAnalyticsData() {
                try {
                    await this.updateAnalyticsMetrics();
                    await this.createSatisfactionTrendChart();
                    await this.createClinicPerformanceChart();
                    await this.createWaitTimeChart();
                    await this.createRatingDistributionChart();
                } catch (error) {
                    console.error('‚ùå Error loading analytics data:', error);
                    this.showError('Failed to load analytics data');
                }
            }

            async updateAnalyticsMetrics() {
                try {
                    // Get user stats using the database function
                    const { data: stats, error } = await this.supabase
                        .rpc('get_user_survey_stats');

                    if (error) throw error;

                    if (stats && stats.length > 0) {
                        const stat = stats[0];
                        document.getElementById('totalResponsesMetric').textContent = stat.total_surveys || 0;
                        document.getElementById('avgOverallMetric').textContent = 
                            stat.total_surveys > 0 ? (stat.satisfaction_rate / 20).toFixed(1) : '0.0';
                        document.getElementById('satisfactionRateMetric').textContent = 
                            stat.satisfaction_rate ? stat.satisfaction_rate + '%' : '0%';
                        document.getElementById('responseRateMetric').textContent = 
                            stat.recommendation_rate ? stat.recommendation_rate + '%' : '0%';
                    }

                } catch (error) {
                    console.error('‚ùå Error updating analytics metrics:', error);
                    document.getElementById('totalResponsesMetric').textContent = '0';
                    document.getElementById('avgOverallMetric').textContent = '0.0';
                    document.getElementById('satisfactionRateMetric').textContent = '0%';
                    document.getElementById('responseRateMetric').textContent = '0%';
                }
            }

            async createSatisfactionTrendChart() {
                const ctx = document.getElementById('satisfactionChart');
                if (!ctx) return;

                try {
                    if (this.charts.satisfaction) {
                        this.charts.satisfaction.destroy();
                    }

                    // Get user's accessible clinics
                    const { data: userClinics } = await this.supabase
                        .rpc('get_user_accessible_clinics');
                    
                    const clinicIds = userClinics?.map(c => c.clinic_id) || [];
                    
                    const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                    
                    let query = this.supabase
                        .from('survey_responses_view')
                        .select('*')
                        .gte('created_at', sevenDaysAgo.toISOString())
                        .order('created_at', { ascending: true });

                    if (this.currentSystemUser.role !== 'super_admin' && clinicIds.length > 0) {
                        query = query.in('clinic_id', clinicIds);
                    }

                    const { data: surveys, error } = await query;

                    if (error) throw error;

                    // Group by day
                    const dailyData = {};
                    const last7Days = [];
                    for (let i = 6; i >= 0; i--) {
                        const date = new Date();
                        date.setDate(date.getDate() - i);
                        const dateStr = date.toISOString().split('T')[0];
                        last7Days.push(dateStr);
                        dailyData[dateStr] = [];
                    }

                    surveys.forEach(survey => {
                        const date = new Date(survey.created_at).toISOString().split('T')[0];
                        if (dailyData[date] && survey.overall_satisfaction) {
                            dailyData[date].push(this.mapSatisfactionToNumber(survey.overall_satisfaction));
                        }
                    });

                    const chartData = last7Days.map(date => {
                        const ratings = dailyData[date];
                        return ratings.length > 0 
                            ? (ratings.reduce((sum, r) => sum + r, 0) / ratings.length).toFixed(1)
                            : null;
                    });

                    const labels = last7Days.map(date => {
                        const d = new Date(date);
                        return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                    });

                    this.charts.satisfaction = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Average Satisfaction',
                                data: chartData,
                                borderColor: '#2c5aa0',
                                backgroundColor: 'rgba(44, 90, 160, 0.1)',
                                tension: 0.4,
                                fill: true,
                                spanGaps: true
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 5,
                                    ticks: {
                                        stepSize: 1
                                    }
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error('‚ùå Error creating satisfaction trend chart:', error);
                }
            }

            async createClinicPerformanceChart() {
                const ctx = document.getElementById('clinicChart');
                if (!ctx) return;

                try {
                    if (this.charts.clinic) {
                        this.charts.clinic.destroy();
                    }

                    // Get user's accessible clinics
                    const { data: userClinics } = await this.supabase
                        .rpc('get_user_accessible_clinics');
                    
                    const clinicIds = userClinics?.map(c => c.clinic_id) || [];
                    
                    let query = this.supabase
                        .from('survey_responses_view')
                        .select('*')
                        .gte('created_at', new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString());

                    if (this.currentSystemUser.role !== 'super_admin' && clinicIds.length > 0) {
                        query = query.in('clinic_id', clinicIds);
                    }

                    const { data: surveys, error } = await query;

                    if (error) throw error;

                    // Group by clinic
                    const clinicData = {};
                    surveys.forEach(survey => {
                        const clinic = survey.clinic_name;
                        const rating = this.mapSatisfactionToNumber(survey.overall_satisfaction);
                        if (clinic && rating) {
                            if (!clinicData[clinic]) clinicData[clinic] = [];
                            clinicData[clinic].push(rating);
                        }
                    });

                    const clinics = Object.keys(clinicData).slice(0, 8);
                    const data = clinics.map(clinic => {
                        const ratings = clinicData[clinic];
                        return ratings.length > 0 
                            ? (ratings.reduce((sum, r) => sum + r, 0) / ratings.length).toFixed(1)
                            : 0;
                    });

                    const colors = [
                        '#10b981', '#f59e0b', '#3b82f6', '#ef4444', 
                        '#8b5cf6', '#06b6d4', '#84cc16', '#f97316'
                    ];

                    this.charts.clinic = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: clinics,
                            datasets: [{
                                label: 'Average Rating',
                                data: data,
                                backgroundColor: colors.slice(0, clinics.length)
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: { 
                                y: { 
                                    beginAtZero: true, 
                                    max: 5,
                                    ticks: {
                                        stepSize: 1
                                    }
                                } 
                            },
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error('‚ùå Error creating clinic chart:', error);
                }
            }

            async createWaitTimeChart() {
                const ctx = document.getElementById('waitTimeChart');
                if (!ctx) return;

                try {
                    if (this.charts.waitTime) {
                        this.charts.waitTime.destroy();
                    }

                    // Get user's accessible clinics
                    const { data: userClinics } = await this.supabase
                        .rpc('get_user_accessible_clinics');
                    
                    const clinicIds = userClinics?.map(c => c.clinic_id) || [];
                    
                    let query = this.supabase
                        .from('clinic_survey_responses')
                        .select('responses')
                        .gte('created_at', new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString());

                    if (this.currentSystemUser.role !== 'super_admin' && clinicIds.length > 0) {
                        query = query.in('patient_info->>clinic_location', clinicIds);
                    }

                    const { data: surveys, error } = await query;

                    if (error) throw error;

                    const waitTimeAcceptable = {
                        'Yes': surveys.filter(s => s.responses?.waiting_time_acceptable === 'yes').length,
                        'No': surveys.filter(s => s.responses?.waiting_time_acceptable === 'no').length
                    };

                    this.charts.waitTime = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(waitTimeAcceptable),
                            datasets: [{
                                data: Object.values(waitTimeAcceptable),
                                backgroundColor: ['#10b981', '#ef4444']
                            }]
                        },
                        options: { 
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error('‚ùå Error creating wait time chart:', error);
                }
            }

            async createRatingDistributionChart() {
                const ctx = document.getElementById('ratingChart');
                if (!ctx) return;

                try {
                    if (this.charts.rating) {
                        this.charts.rating.destroy();
                    }

                    // Get user's accessible clinics
                    const { data: userClinics } = await this.supabase
                        .rpc('get_user_accessible_clinics');
                    
                    const clinicIds = userClinics?.map(c => c.clinic_id) || [];
                    
                    let query = this.supabase
                        .from('survey_responses_view')
                        .select('overall_satisfaction')
                        .gte('created_at', new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString());

                    if (this.currentSystemUser.role !== 'super_admin' && clinicIds.length > 0) {
                        query = query.in('clinic_id', clinicIds);
                    }

                    const { data: surveys, error } = await query;

                    if (error) throw error;

                    const ratingCounts = {
                        'Very Dissatisfied': surveys.filter(s => s.overall_satisfaction === 'very_dissatisfied').length,
                        'Dissatisfied': surveys.filter(s => s.overall_satisfaction === 'dissatisfied').length,
                        'Satisfied': surveys.filter(s => s.overall_satisfaction === 'satisfied').length,
                        'Very Satisfied': surveys.filter(s => s.overall_satisfaction === 'very_satisfied').length
                    };

                    this.charts.rating = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: Object.keys(ratingCounts),
                            datasets: [{
                                label: 'Number of Responses',
                                data: Object.values(ratingCounts),
                                backgroundColor: '#2c5aa0'
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: { 
                                y: { 
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    }
                                } 
                            },
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error('‚ùå Error creating rating distribution chart:', error);
                }
            }

            async loadFollowUpsData() {
                try {
                    // Get user's accessible clinics
                    const { data: userClinics } = await this.supabase
                        .rpc('get_user_accessible_clinics');
                    
                    const clinicIds = userClinics?.map(c => c.clinic_id) || [];
                    
                    let query = this.supabase
                        .from('follow_up_tasks')
                        .select(`
                            *,
                            assigned_user:users!follow_up_tasks_assigned_to_fkey(full_name),
                            clinics!follow_up_tasks_clinic_id_fkey(name)
                        `)
                        .order('created_at', { ascending: false });

                    if (this.currentSystemUser.role !== 'super_admin' && clinicIds.length > 0) {
                        query = query.in('clinic_id', clinicIds);
                    }

                    const { data: followUps, error } = await query;

                    if (error) throw error;

                    this.renderFollowUpsTable(followUps);

                } catch (error) {
                    console.error('‚ùå Error loading follow-ups data:', error);
                    this.showError('Failed to load follow-ups data');
                }
            }

            renderFollowUpsTable(followUps) {
                const tableBody = document.getElementById('followUpsTable');
                
                if (followUps.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #64748b;">No follow-up tasks found</td></tr>';
                    return;
                }

                tableBody.innerHTML = followUps.map(followUp => `
                    <tr>
                        <td>${followUp.patient_name}</td>
                        <td>${followUp.clinics?.name || 'N/A'}</td>
                        <td>
                            <span class="status-badge ${this.getPriorityClass(followUp.priority)}">
                                ${followUp.priority.toUpperCase()}
                            </span>
                        </td>
                        <td>${followUp.assigned_user?.full_name || 'Unassigned'}</td>
                        <td>
                            <span class="status-badge status-${followUp.status}">
                                ${followUp.status.replace('_', ' ')}
                            </span>
                        </td>
                        <td>${this.formatSatisfaction(followUp.overall_satisfaction)}</td>
                        <td>${new Date(followUp.created_at).toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="viewFollowUp('${followUp.id}')">View</button>
                            ${followUp.status === 'pending' ? 
                                `<button class="btn btn-success btn-sm" onclick="completeFollowUp('${followUp.id}')">Complete</button>` : ''
                            }
                        </td>
                    </tr>
                `).join('');
            }

            getPriorityClass(priority) {
                switch(priority) {
                    case 'urgent': return 'status-high';
                    case 'high': return 'status-medium'; 
                    case 'medium': return 'status-low';
                    case 'low': return 'status-completed';
                    default: return 'status-medium';
                }
            }

            async loadUsersData() {
                try {
                    let query = this.supabase
                        .from('users')
                        .select('*')
                        .order('created_at', { ascending: false });

                    // Only super admins can see all users
                    if (this.currentSystemUser.role !== 'super_admin') {
                        // Regular users only see themselves
                        query = query.eq('id', this.currentSystemUser.id);
                    }

                    const { data: users, error } = await query;

                    if (error) throw error;

                    this.renderUsersTable(users);

                } catch (error) {
                    console.error('‚ùå Error loading users data:', error);
                    this.showError('Failed to load users data');
                    document.getElementById('usersTable').innerHTML = 
                        '<tr><td colspan="7" style="text-align: center; color: #dc2626;">Failed to load users</td></tr>';
                }
            }
            
            renderUsersTable(users) {
                const tableBody = document.getElementById('usersTable');
                
                if (!users || users.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #64748b;">No users found</td></tr>';
                    return;
                }

                tableBody.innerHTML = users.map(user => {
                    const canManageUser = this.currentSystemUser?.role === 'super_admin' && user.id !== this.currentSystemUser.id;
                    const lastLogin = user.last_login ? new Date(user.last_login).toLocaleDateString() : 'Never';
                    
                    return `
                        <tr>
                            <td>${user.username}</td>
                            <td>${user.full_name}</td>
                            <td>${user.email}</td>
                            <td>
                                <span class="status-badge ${user.role === 'super_admin' ? 'status-high' : 'status-medium'}">
                                    ${user.role.replace('_', ' ').toUpperCase()}
                                </span>
                            </td>
                            <td>${lastLogin}</td>
                            <td>
                                <span class="status-badge ${user.is_active ? 'status-high' : 'status-low'}">
                                    ${user.is_active ? 'Active' : 'Inactive'}
                                </span>
                            </td>
                            <td>
                                ${canManageUser ? `
                                    <button class="btn ${user.is_active ? 'btn-danger' : 'btn-success'} btn-sm" 
                                            onclick="toggleUserStatus('${user.id}', ${!user.is_active})">
                                        ${user.is_active ? 'üö´ Disable' : '‚úÖ Enable'}
                                    </button>
                                ` : '<span style="color: #64748b; font-size: 12px;">No actions available</span>'}
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            // ===== CLINIC MANAGEMENT FUNCTIONS =====
            async loadClinicsData() {
                try {
                    // Load clinics with manager information and survey counts
                    const { data: clinics, error } = await this.supabase
                        .from('clinics')
                        .select(`
                            *,
                            manager:users!clinics_manager_id_fkey(full_name, email),
                            survey_count:clinic_survey_responses(count)
                        `)
                        .order('name');

                    if (error) throw error;

                    this.renderClinicsTable(clinics || []);

                } catch (error) {
                    console.error('‚ùå Error loading clinics data:', error);
                    this.showError('Failed to load clinics data: ' + error.message);
                    document.getElementById('clinicsTable').innerHTML = 
                        '<tr><td colspan="8" style="text-align: center; color: #dc2626;">Failed to load clinics</td></tr>';
                }
            }

            renderClinicsTable(clinics) {
                const tableBody = document.getElementById('clinicsTable');
                
                if (!clinics || clinics.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #64748b;">No clinics found</td></tr>';
                    return;
                }

                tableBody.innerHTML = clinics.map(clinic => {
                    const canManageClinic = ['admin', 'super_admin'].includes(this.currentSystemUser?.role);
                    const departmentCount = clinic.departments ? clinic.departments.split(',').length : 0;
                    const surveyCount = clinic.survey_count?.[0]?.count || 0;
                    
                    return `
                        <tr>
                            <td data-label="Clinic Name">
                                <div style="font-weight: 600;">${clinic.name}</div>
                                <div style="font-size: 0.8em; color: #64748b;">${clinic.description || 'No description'}</div>
                            </td>
                            <td data-label="Location">${clinic.location}</td>
                            <td data-label="Contact Info">
                                <div style="font-size: 0.9em;">
                                    <div>${clinic.email || 'N/A'}</div>
                                    <div style="color: #64748b;">${clinic.phone || 'N/A'}</div>
                                </div>
                            </td>
                            <td data-label="Manager">
                                <div style="font-weight: 600;">${clinic.manager?.full_name || 'Not Assigned'}</div>
                                <div style="font-size: 0.8em; color: #64748b;">${clinic.manager?.email || ''}</div>
                            </td>
                            <td data-label="Departments">
                                <span class="status-badge status-medium">${departmentCount} departments</span>
                            </td>
                            <td data-label="Surveys">
                                <span class="status-badge status-high">${surveyCount} surveys</span>
                            </td>
                            <td data-label="Status">
                                <span class="status-badge ${clinic.is_active ? 'status-high' : 'status-low'}">
                                    ${clinic.is_active ? 'Active' : 'Inactive'}
                                </span>
                            </td>
                            <td data-label="Actions">
                                ${canManageClinic ? `
                                    <button class="btn btn-primary btn-sm" onclick="editClinic('${clinic.id}')" title="Edit Clinic">
                                        ‚úèÔ∏è Edit
                                    </button>
                                    <button class="btn ${clinic.is_active ? 'btn-danger' : 'btn-success'} btn-sm" 
                                            onclick="toggleClinicStatus('${clinic.id}', ${!clinic.is_active})" 
                                            title="${clinic.is_active ? 'Deactivate' : 'Activate'} Clinic">
                                        ${clinic.is_active ? 'üö´' : '‚úÖ'}
                                    </button>
                                ` : '<span style="color: #64748b; font-size: 12px;">View Only</span>'}
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            async addNewClinic() {
                await this.loadManagerOptions();
                document.getElementById('clinicModalTitle').textContent = 'Add New Clinic';
                document.getElementById('clinicForm').reset();
                document.getElementById('clinicActive').checked = true;
                document.getElementById('clinicModal').style.display = 'block';
            }

            async editClinic(clinicId) {
                try {
                    const { data: clinic, error } = await this.supabase
                        .from('clinics')
                        .select('*')
                        .eq('id', clinicId)
                        .single();

                    if (error) throw error;

                    await this.loadManagerOptions();
                    
                    document.getElementById('clinicModalTitle').textContent = 'Edit Clinic';
                    document.getElementById('clinicName').value = clinic.name || '';
                    document.getElementById('clinicLocation').value = clinic.location || '';
                    document.getElementById('clinicPhone').value = clinic.phone || '';
                    document.getElementById('clinicEmail').value = clinic.email || '';
                    document.getElementById('clinicManager').value = clinic.manager_id || '';
                    document.getElementById('clinicDepartments').value = clinic.departments || '';
                    document.getElementById('clinicDescription').value = clinic.description || '';
                    document.getElementById('clinicActive').checked = clinic.is_active;
                    
                    // Store clinic ID for update
                    document.getElementById('clinicForm').dataset.clinicId = clinicId;
                    document.getElementById('clinicModal').style.display = 'block';

                } catch (error) {
                    console.error('‚ùå Error loading clinic:', error);
                    this.showError('Failed to load clinic data');
                }
            }

            async loadManagerOptions() {
                try {
                    const { data: users, error } = await this.supabase
                        .from('users')
                        .select('id, full_name, email')
                        .eq('is_active', true)
                        .in('role', ['admin', 'super_admin'])
                        .order('full_name');

                    if (error) throw error;

                    const managerSelect = document.getElementById('clinicManager');
                    managerSelect.innerHTML = '<option value="">Select Manager</option>';
                    
                    users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = `${user.full_name} (${user.email})`;
                        managerSelect.appendChild(option);
                    });

                } catch (error) {
                    console.error('‚ùå Error loading managers:', error);
                    this.showError('Failed to load manager options');
                }
            }

            async toggleClinicStatus(clinicId, newStatus) {
                try {
                    const { error } = await this.supabase
                        .from('clinics')
                        .update({ is_active: newStatus })
                        .eq('id', clinicId);

                    if (error) throw error;

                    this.showSuccess(`Clinic ${newStatus ? 'activated' : 'deactivated'} successfully`);
                    await this.loadClinicsData();

                } catch (error) {
                    console.error('‚ùå Error updating clinic status:', error);
                    this.showError('Failed to update clinic status');
                }
            }

            async handleClinicSubmit() {
                try {
                    const form = document.getElementById('clinicForm');
                    const clinicId = form.dataset.clinicId;
                    const isEdit = !!clinicId;

                    const clinicData = {
                        name: document.getElementById('clinicName').value.trim(),
                        location: document.getElementById('clinicLocation').value.trim(),
                        phone: document.getElementById('clinicPhone').value.trim() || null,
                        email: document.getElementById('clinicEmail').value.trim() || null,
                        manager_id: document.getElementById('clinicManager').value || null,
                        departments: document.getElementById('clinicDepartments').value.trim() || null,
                        description: document.getElementById('clinicDescription').value.trim() || null,
                        is_active: document.getElementById('clinicActive').checked
                    };

                    // Validate required fields
                    if (!clinicData.name || !clinicData.location) {
                        this.showError('Please fill in all required fields');
                        return;
                    }

                    let result;
                    if (isEdit) {
                        result = await this.supabase
                            .from('clinics')
                            .update(clinicData)
                            .eq('id', clinicId);
                    } else {
                        result = await this.supabase
                            .from('clinics')
                            .insert([clinicData]);
                    }

                    if (result.error) throw result.error;

                    this.showSuccess(`Clinic ${isEdit ? 'updated' : 'created'} successfully`);
                    this.closeClinicModal();
                    await this.loadClinicsData();

                } catch (error) {
                    console.error('‚ùå Error saving clinic:', error);
                    this.showError('Failed to save clinic: ' + error.message);
                }
            }

            closeClinicModal() {
                document.getElementById('clinicModal').style.display = 'none';
                document.getElementById('clinicForm').reset();
                delete document.getElementById('clinicForm').dataset.clinicId;
            }

            handleDateRangeChange() {
                const dateRange = document.getElementById('dateRangeFilter')?.value;
                const customDateGroup = document.getElementById('customDateGroup');
                const customDateGroup2 = document.getElementById('customDateGroup2');

                if (dateRange === 'custom') {
                    if (customDateGroup) customDateGroup.style.display = 'flex';
                    if (customDateGroup2) customDateGroup2.style.display = 'flex';
                } else {
                    if (customDateGroup) customDateGroup.style.display = 'none';
                    if (customDateGroup2) customDateGroup2.style.display = 'none';
                    
                    setTimeout(() => applyFilters(), 100);
                }
            }

            showError(message) {
                this.showMessage(message, 'error');
            }

            showSuccess(message) {
                this.showMessage(message, 'success');
            }

            showMessage(message, type = 'error') {
                const errorDiv = document.getElementById('authError');
                const successDiv = document.getElementById('authSuccess');
                
                if (type === 'error') {
                    errorDiv.textContent = message;
                    errorDiv.style.display = 'block';
                    successDiv.style.display = 'none';
                } else {
                    successDiv.textContent = message;
                    successDiv.style.display = 'block';
                    errorDiv.style.display = 'none';
                }

                setTimeout(() => {
                    errorDiv.style.display = 'none';
                    successDiv.style.display = 'none';
                }, 5000);
            }

            clearAuthForms(clearLogin = true, clearRegister = true) {
                if (clearLogin) {
                    document.getElementById('loginEmail').value = '';
                    document.getElementById('loginPassword').value = '';
                }
                
                if (clearRegister) {
                    document.getElementById('registerUsername').value = '';
                    document.getElementById('registerName').value = '';
                    document.getElementById('registerEmail').value = '';
                    document.getElementById('registerPassword').value = '';
                    document.getElementById('registerRole').value = 'user';
                }
            }

            hideMessages() {
                document.getElementById('authError').style.display = 'none';
                document.getElementById('authSuccess').style.display = 'none';
            }

            async refreshData() {
                try {
                    const activeTab = document.querySelector('.nav-tab.active');
                    const currentTabName = activeTab ? activeTab.dataset.tab : 'overview';
                    
                    await this.loadTabData(currentTabName);
                    
                    this.showSuccess('Data refreshed successfully!');
                } catch (error) {
                    console.error('‚ùå Refresh error:', error);
                    this.showError('Failed to refresh: ' + error.message);
                }
            }

            async toggleUserStatus(userId, newStatus) {
                if (!this.currentSystemUser || this.currentSystemUser.role !== 'super_admin') {
                    this.showError('Only super administrators can manage user status.');
                    return;
                }

                if (userId === this.currentSystemUser.id) {
                    this.showError('You cannot disable your own account.');
                    return;
                }

                try {
                    const { error } = await this.supabase
                        .from('users')
                        .update({ 
                            is_active: newStatus,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', userId);
                    
                    if (error) throw error;

                    await this.loadUsersData();
                    
                    const actionText = newStatus ? 'enabled' : 'disabled';
                    this.showSuccess(`User ${actionText} successfully!`);

                } catch (error) {
                    console.error(`‚ùå Error toggling user status:`, error);
                    this.showError(`Failed to update user status: ${error.message}`);
                }
            }
        }

        // Export Manager Class
        class ExportManager {
            constructor(adminDashboard) {
                this.dashboard = adminDashboard;
                this.supabase = adminDashboard.supabase;
            }

            async exportSurveys(format = 'excel', includeFilters = true) {
                try {
                    this.showExportProgress('Preparing survey data...');

                    let data;
                    if (includeFilters && this.dashboard.filteredData?.length > 0) {
                        data = this.dashboard.filteredData;
                    } else {
                        // Get user's accessible clinics
                        const { data: userClinics } = await this.supabase
                            .rpc('get_user_accessible_clinics');
                        
                        const clinicIds = userClinics?.map(c => c.clinic_id) || [];
                        
                        let query = this.supabase
                            .from('survey_responses_view')
                            .select('*')
                            .order('created_at', { ascending: false });

                        if (this.dashboard.currentSystemUser.role !== 'super_admin' && clinicIds.length > 0) {
                            query = query.in('clinic_id', clinicIds);
                        }

                        const { data: allSurveys, error } = await query;
                        if (error) throw error;
                        data = allSurveys;
                    }

                    this.showExportProgress('Processing survey responses...');

                    switch (format) {
                        case 'excel':
                            await this.exportSurveysToExcel(data);
                            break;
                        case 'csv':
                            this.exportSurveysToCSV(data);
                            break;
                        case 'pdf':
                            await this.exportSurveysToPDF(data);
                            break;
                        case 'json':
                            this.exportSurveysToJSON(data);
                            break;
                    }

                    this.hideExportProgress();
                    this.dashboard.showSuccess(`Survey data exported successfully in ${format.toUpperCase()} format!`);

                } catch (error) {
                    this.hideExportProgress();
                    console.error('‚ùå Export error:', error);
                    this.dashboard.showError('Export failed: ' + error.message);
                }
            }

            async exportSurveysToExcel(data) {
                const wb = XLSX.utils.book_new();

                // Summary sheet
                const summaryData = this.generateSummaryStats(data);
                const summaryWS = XLSX.utils.aoa_to_sheet([
                    ['üìä CLINIC SURVEY EXPORT SUMMARY'],
                    ['Generated on:', new Date().toLocaleString()],
                    ['Total Surveys:', data.length],
                    ['Date Range:', this.getDataDateRange(data)],
                    [''],
                    ['üìà KEY METRICS'],
                    ...summaryData
                ]);
                XLSX.utils.book_append_sheet(wb, summaryWS, 'Summary');

                // Main data sheet
                const flattenedData = data.map(survey => ({
                    'Survey ID': survey.response_id,
                    'Patient Name': survey.patient_name || '',
                    'Email': survey.patient_email || '',
                    'Phone': survey.patient_phone || '',
                    'Date of Birth': survey.date_of_birth || '',
                    'Gender': survey.gender || '',
                    'Nationality': survey.nationality || '',
                    'Emergency Contact Name': survey.emergency_contact_name || '',
                    'Emergency Contact Phone': survey.emergency_contact_phone || '',
                    'Visit Date': survey.visit_date || '',
                    'Clinic': survey.clinic_name || '',
                    'Appointment Type': survey.appointment_type || '',
                    'Visit Type': survey.visit_type || '',
                    'Insurance Provider': survey.insurance_provider || '',
                    'Visit Reason': survey.visit_reason || '',
                    'Overall Satisfaction': this.dashboard.formatSatisfaction(survey.overall_satisfaction),
                    'Recommendation': survey.recommendation_likelihood || '',
                    'Wants Follow-up': survey.wants_contact ? 'Yes' : 'No',
                    'Submitted Date': new Date(survey.created_at).toLocaleString()
                }));

                const mainWS = XLSX.utils.json_to_sheet(flattenedData);
                XLSX.utils.book_append_sheet(wb, mainWS, 'Survey Responses');

                // Clinic analysis sheet
                const clinicAnalysis = this.generateClinicAnalysis(data);
                const clinicWS = XLSX.utils.json_to_sheet(clinicAnalysis);
                XLSX.utils.book_append_sheet(wb, clinicWS, 'Clinic Analysis');

                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-');
                const filename = `clinic_surveys_${timestamp}.xlsx`;

                XLSX.writeFile(wb, filename);
            }

            exportSurveysToCSV(data) {
                const flattenedData = data.map(survey => ({
                    'survey_id': survey.response_id,
                    'patient_name': survey.patient_name || '',
                    'patient_email': survey.patient_email || '',
                    'patient_phone': survey.patient_phone || '',
                    'date_of_birth': survey.date_of_birth || '',
                    'gender': survey.gender || '',
                    'nationality': survey.nationality || '',
                    'emergency_contact_name': survey.emergency_contact_name || '',
                    'emergency_contact_phone': survey.emergency_contact_phone || '',
                    'visit_date': survey.visit_date || '',
                    'clinic': survey.clinic_name || '',
                    'appointment_type': survey.appointment_type || '',
                    'visit_type': survey.visit_type || '',
                    'insurance_provider': survey.insurance_provider || '',
                    'visit_reason': survey.visit_reason || '',
                    'overall_satisfaction': survey.overall_satisfaction || '',
                    'recommendation_likelihood': survey.recommendation_likelihood || '',
                    'wants_followup': survey.wants_contact ? 'yes' : 'no',
                    'submitted_date': new Date(survey.created_at).toISOString()
                }));

                const csv = this.convertToCSV(flattenedData);
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-');
                const filename = `clinic_surveys_${timestamp}.csv`;
                
                this.downloadFile(csv, filename, 'text/csv;charset=utf-8;');
            }

            async exportSurveysToPDF(data) {
                const html = this.generatePDFContent(data);
                const printWindow = window.open('', '_blank');
                printWindow.document.write(html);
                printWindow.document.close();
                
                setTimeout(() => {
                    printWindow.print();
                }, 1000);
            }

            exportSurveysToJSON(data) {
                const exportData = {
                    exported_at: new Date().toISOString(),
                    total_surveys: data.length,
                    date_range: this.getDataDateRange(data),
                    summary_stats: this.generateSummaryStats(data),
                    surveys: data
                };

                const json = JSON.stringify(exportData, null, 2);
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-');
                const filename = `clinic_surveys_${timestamp}.json`;
                
                this.downloadFile(json, filename, 'application/json');
            }

            async exportFollowUps(format = 'excel') {
                try {
                    this.showExportProgress('Fetching follow-up tasks...');

                    // Get user's accessible clinics
                    const { data: userClinics } = await this.supabase
                        .rpc('get_user_accessible_clinics');
                    
                    const clinicIds = userClinics?.map(c => c.clinic_id) || [];
                    
                    let query = this.supabase
                        .from('follow_up_tasks')
                        .select(`
                            *,
                            assigned_user:users!follow_up_tasks_assigned_to_fkey(full_name, email),
                            clinics!follow_up_tasks_clinic_id_fkey(name)
                        `)
                        .order('created_at', { ascending: false });

                    if (this.dashboard.currentSystemUser.role !== 'super_admin' && clinicIds.length > 0) {
                        query = query.in('clinic_id', clinicIds);
                    }

                    const { data: followUps, error } = await query;

                    if (error) throw error;

                    this.showExportProgress('Processing follow-up data...');

                    switch (format) {
                        case 'excel':
                            this.exportFollowUpsToExcel(followUps);
                            break;
                        case 'csv':
                            this.exportFollowUpsToCSV(followUps);
                            break;
                    }

                    this.hideExportProgress();
                    this.dashboard.showSuccess('Follow-up tasks exported successfully!');

                } catch (error) {
                    this.hideExportProgress();
                    console.error('‚ùå Follow-up export error:', error);
                    this.dashboard.showError('Follow-up export failed: ' + error.message);
                }
            }

            exportFollowUpsToExcel(data) {
                const wb = XLSX.utils.book_new();

                // Summary
                const priorityStats = this.generateFollowUpStats(data);
                const summaryWS = XLSX.utils.aoa_to_sheet([
                    ['üìã FOLLOW-UP TASKS EXPORT'],
                    ['Generated on:', new Date().toLocaleString()],
                    ['Total Tasks:', data.length],
                    [''],
                    ['üìä BY PRIORITY'],
                    ...priorityStats.priority,
                    [''],
                    ['üìà BY STATUS'],
                    ...priorityStats.status
                ]);
                XLSX.utils.book_append_sheet(wb, summaryWS, 'Summary');

                // Main data
                const flattenedData = data.map(task => ({
                    'Task ID': task.id,
                    'Patient Name': task.patient_name,
                    'Email': task.patient_email,
                    'Phone': task.patient_phone,
                    'Clinic': task.clinics?.name || '',
                    'Priority': task.priority.toUpperCase(),
                    'Status': task.status.replace('_', ' ').toUpperCase(),
                    'Assigned To': task.assigned_user?.full_name || 'Unassigned',
                    'Overall Satisfaction': this.dashboard.formatSatisfaction(task.overall_satisfaction),
                    'Notes': task.notes || '',
                    'Created Date': new Date(task.created_at).toLocaleString()
                }));

                const mainWS = XLSX.utils.json_to_sheet(flattenedData);
                XLSX.utils.book_append_sheet(wb, mainWS, 'Follow-up Tasks');

                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-');
                const filename = `follow_up_tasks_${timestamp}.xlsx`;
                XLSX.writeFile(wb, filename);
            }

            exportFollowUpsToCSV(data) {
                const flattenedData = data.map(task => ({
                    'task_id': task.id,
                    'patient_name': task.patient_name,
                    'patient_email': task.patient_email || '',
                    'patient_phone': task.patient_phone || '',
                    'clinic': task.clinics?.name || '',
                    'priority': task.priority,
                    'status': task.status,
                    'assigned_to': task.assigned_user?.full_name || '',
                    'overall_satisfaction': task.overall_satisfaction || '',
                    'notes': task.notes || '',
                    'created_date': new Date(task.created_at).toISOString()
                }));

                const csv = this.convertToCSV(flattenedData);
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-');
                const filename = `follow_up_tasks_${timestamp}.csv`;
                
                this.downloadFile(csv, filename, 'text/csv;charset=utf-8;');
            }

            // Helper methods
            generateSummaryStats(data) {
                const satisfactionMap = {
                    'very_satisfied': 5,
                    'satisfied': 4,
                    'neutral': 3,
                    'dissatisfied': 2,
                    'very_dissatisfied': 1
                };

                const validRatings = data.filter(s => s.overall_satisfaction && satisfactionMap[s.overall_satisfaction]);
                const avgRating = validRatings.length > 0 
                    ? (validRatings.reduce((sum, s) => sum + satisfactionMap[s.overall_satisfaction], 0) / validRatings.length).toFixed(2)
                    : 0;

                const ratingCounts = Object.keys(satisfactionMap).map(rating => [
                    this.dashboard.formatSatisfaction(rating),
                    validRatings.filter(s => s.overall_satisfaction === rating).length
                ]);

                const followUpRequests = data.filter(s => s.wants_contact).length;
                const uniqueClinics = [...new Set(data.map(s => s.clinic_name).filter(Boolean))];

                return [
                    ['Average Rating:', avgRating],
                    ['Total Responses:', data.length],
                    ['Follow-up Requests:', followUpRequests],
                    ['Clinics Covered:', uniqueClinics.length],
                    [''],
                    ...ratingCounts
                ];
            }

            generateClinicAnalysis(data) {
                const clinicData = {};
                data.forEach(survey => {
                    const clinic = survey.clinic_name;
                    const rating = this.dashboard.mapSatisfactionToNumber(survey.overall_satisfaction);
                    
                    if (clinic && rating) {
                        if (!clinicData[clinic]) {
                            clinicData[clinic] = { ratings: [], followUps: 0, total: 0 };
                        }
                        clinicData[clinic].ratings.push(rating);
                        clinicData[clinic].total++;
                        
                        if (survey.wants_contact) {
                            clinicData[clinic].followUps++;
                        }
                    }
                });

                return Object.entries(clinicData).map(([clinic, stats]) => ({
                    'Clinic': clinic,
                    'Total Surveys': stats.total,
                    'Average Rating': (stats.ratings.reduce((sum, r) => sum + r, 0) / stats.ratings.length).toFixed(2),
                    'Follow-up Requests': stats.followUps,
                    'Follow-up Rate': ((stats.followUps / stats.total) * 100).toFixed(1) + '%'
                }));
            }

            generateFollowUpStats(data) {
                const priorityStats = ['urgent', 'high', 'medium', 'low'].map(priority => [
                    priority.toUpperCase(),
                    data.filter(task => task.priority === priority).length
                ]);

                const statusStats = ['pending', 'in_progress', 'completed', 'cancelled'].map(status => [
                    status.replace('_', ' ').toUpperCase(),
                    data.filter(task => task.status === status).length
                ]);

                return { priority: priorityStats, status: statusStats };
            }

            generatePDFContent(data) {
                const summaryStats = this.generateSummaryStats(data);
                
                return `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Clinic Survey Report</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            .header { text-align: center; margin-bottom: 30px; }
                            .summary { background: #f8f9fa; padding: 20px; margin-bottom: 30px; border-radius: 8px; }
                            .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
                            .stat-item { background: white; padding: 15px; border-radius: 6px; text-align: center; }
                            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            th { background-color: #f2f2f2; }
                            @media print { body { margin: 0; } }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>üìä Clinic Survey Report</h1>
                            <p>Generated on: ${new Date().toLocaleString()}</p>
                            <p>Total Surveys: ${data.length}</p>
                        </div>
                        
                        <div class="summary">
                            <h2>Summary Statistics</h2>
                            <div class="stats-grid">
                                ${summaryStats.map(([label, value]) => 
                                    `<div class="stat-item"><strong>${label}</strong><br>${value}</div>`
                                ).join('')}
                            </div>
                        </div>
                        
                        <h2>Recent Survey Responses</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>Patient</th>
                                    <th>Clinic</th>
                                    <th>Satisfaction</th>
                                    <th>Visit Date</th>
                                    <th>Follow-up</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.slice(0, 20).map(survey => `
                                    <tr>
                                        <td>${survey.patient_name || 'N/A'}</td>
                                        <td>${survey.clinic_name || 'N/A'}</td>
                                        <td>${this.dashboard.formatSatisfaction(survey.overall_satisfaction)}</td>
                                        <td>${survey.visit_date || 'N/A'}</td>
                                        <td>${survey.wants_contact ? 'Yes' : 'No'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </body>
                    </html>
                `;
            }

            getDataDateRange(data) {
                if (data.length === 0) return 'No data';
                
                const dates = data.map(d => new Date(d.created_at)).sort();
                const oldest = dates[0].toLocaleDateString();
                const newest = dates[dates.length - 1].toLocaleDateString();
                
                return oldest === newest ? oldest : `${oldest} to ${newest}`;
            }

            convertToCSV(data) {
                if (!data.length) return '';
                
                const headers = Object.keys(data[0]);
                const csvContent = [
                    headers.join(','),
                    ...data.map(row => 
                        headers.map(field => {
                            const value = row[field];
                            if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                                return `"${value.replace(/"/g, '""')}"`;
                            }
                            return value;
                        }).join(',')
                    )
                ].join('\n');
                
                return '\ufeff' + csvContent;
            }

            downloadFile(content, filename, contentType) {
                const blob = new Blob([content], { type: contentType });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }

            showExportProgress(message) {
                let progressDiv = document.getElementById('exportProgress');
                if (!progressDiv) {
                    progressDiv = document.createElement('div');
                    progressDiv.id = 'exportProgress';
                    progressDiv.style.cssText = `
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: white;
                        padding: 20px;
                        border-radius: 8px;
                        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                        z-index: 10000;
                        text-align: center;
                        min-width: 300px;
                    `;
                    document.body.appendChild(progressDiv);
                }
                
                progressDiv.innerHTML = `
                    <div class="spinner" style="margin: 0 auto 15px; width: 40px; height: 40px;"></div>
                    <h3>Exporting Data</h3>
                    <p>${message}</p>
                `;
            }

            hideExportProgress() {
                const progressDiv = document.getElementById('exportProgress');
                if (progressDiv) {
                    progressDiv.remove();
                }
            }
        }

        // Global functions
        function switchAuthTab(tabName) {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const loginTab = document.querySelector('.auth-tab:first-child');
            const registerTab = document.querySelector('.auth-tab:last-child');

            if (tabName === 'login') {
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                loginTab.classList.add('active');
                registerTab.classList.remove('active');
            } else {
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
                loginTab.classList.remove('active');
                registerTab.classList.add('active');
            }

            if (window.adminDashboard) {
                window.adminDashboard.hideMessages();
            }
        }

        function viewSurvey(responseId) {
            if (window.adminDashboard && window.adminDashboard.supabase) {
                window.adminDashboard.supabase
                    .from('clinic_survey_responses')
                    .select('*')
                    .eq('response_id', responseId)
                    .single()
                    .then(({ data: survey, error }) => {
                        if (error) {
                            console.error('Error loading survey:', error);
                            return;
                        }

                        const modal = document.getElementById('surveyModal');
                        const details = document.getElementById('surveyDetails');
                        
                        // Helper function to format satisfaction ratings
                        const formatSatisfaction = (value) => {
                            if (!value) return 'N/A';
                            return value.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        };

                        // Helper function to format yes/no values
                        const formatYesNo = (value) => {
                            if (value === 'yes' || value === true) return '‚úÖ Yes';
                            if (value === 'no' || value === false) return '‚ùå No';
                            return 'N/A';
                        };

                        details.innerHTML = `
                            <div class="survey-detail-container">
                                <!-- Patient Information Section -->
                                <div class="detail-section">
                                    <h3 class="section-title">üë§ Patient Information</h3>
                                    <div class="detail-grid">
                                        <div class="detail-item">
                                            <label>Full Name:</label>
                                            <span>${survey.patient_name || 'N/A'}</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Email:</label>
                                            <span>${survey.patient_email || 'N/A'}</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Phone:</label>
                                            <span>${survey.patient_phone || 'N/A'}</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Date of Birth:</label>
                                            <span>${survey.date_of_birth || 'N/A'}</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Gender:</label>
                                            <span>${formatSatisfaction(survey.gender) || 'N/A'}</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Nationality:</label>
                                            <span>${formatSatisfaction(survey.nationality) || 'N/A'}</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Emergency Contact:</label>
                                            <span>${survey.emergency_contact_name || 'N/A'}</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Emergency Phone:</label>
                                            <span>${survey.emergency_contact_phone || 'N/A'}</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Visit Information Section -->
                                <div class="detail-section">
                                    <h3 class="section-title">üè• Visit Information</h3>
                                    <div class="detail-grid">
                                        <div class="detail-item">
                                            <label>Visit Date:</label>
                                            <span>${survey.visit_date || 'N/A'}</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Clinic:</label>
                                            <span>${survey.clinic_name || 'N/A'}</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Appointment Type:</label>
                                            <span>${formatSatisfaction(survey.appointment_type) || 'N/A'}</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Visit Type:</label>
                                            <span>${formatSatisfaction(survey.visit_type) || 'N/A'}</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Insurance Provider:</label>
                                            <span>${formatSatisfaction(survey.insurance_provider) || 'N/A'}</span>
                                        </div>
                                        <div class="detail-item full-width">
                                            <label>Reason for Visit:</label>
                                            <span>${survey.visit_reason || 'N/A'}</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Satisfaction Ratings Section -->
                                <div class="detail-section">
                                    <h3 class="section-title">‚≠ê Satisfaction Ratings</h3>
                                    <div class="detail-grid">
                                        <div class="detail-item">
                                            <label>Overall Experience:</label>
                                            <span class="satisfaction-rating">${formatSatisfaction(survey.overall_satisfaction)}</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Reception Staff:</label>
                                            <span class="satisfaction-rating">${formatSatisfaction(survey.reception_satisfaction)}</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Registration Process:</label>
                                            <span>${formatYesNo(survey.registration_smooth)}</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Nursing Staff:</label>
                                            <span class="satisfaction-rating">${formatSatisfaction(survey.nursing_professionalism)}</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Prompt Medical Attention:</label>
                                            <span>${formatYesNo(survey.nursing_prompt)}</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Doctor Consultation:</label>
                                            <span class="satisfaction-rating">${formatSatisfaction(survey.doctor_satisfaction)}</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Doctor Listened to Concerns:</label>
                                            <span>${formatYesNo(survey.doctor_listening)}</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Clinic Cleanliness:</label>
                                            <span class="satisfaction-rating">${formatSatisfaction(survey.clinic_cleanliness)}</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Waiting Time Acceptable:</label>
                                            <span>${formatYesNo(survey.waiting_time_acceptable)}</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Recommendation Likelihood:</label>
                                            <span class="satisfaction-rating">${formatSatisfaction(survey.recommendation_likelihood)}</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Comments and Feedback Section -->
                                <div class="detail-section">
                                    <h3 class="section-title">üí¨ Comments & Feedback</h3>
                                    <div class="comments-section">
                                        ${survey.reception_comments ? `
                                            <div class="comment-item">
                                                <h4>üè¢ Reception Staff Comments:</h4>
                                                <p class="comment-text">${survey.reception_comments}</p>
                                            </div>
                                        ` : ''}
                                        
                                        ${survey.nursing_comments ? `
                                            <div class="comment-item">
                                                <h4>üë©‚Äç‚öïÔ∏è Nursing Staff Comments:</h4>
                                                <p class="comment-text">${survey.nursing_comments}</p>
                                            </div>
                                        ` : ''}
                                        
                                        ${survey.doctor_comments ? `
                                            <div class="comment-item">
                                                <h4>üë®‚Äç‚öïÔ∏è Doctor Comments:</h4>
                                                <p class="comment-text">${survey.doctor_comments}</p>
                                            </div>
                                        ` : ''}
                                        
                                        ${survey.environment_comments ? `
                                            <div class="comment-item">
                                                <h4>üè• Environment Comments:</h4>
                                                <p class="comment-text">${survey.environment_comments}</p>
                                            </div>
                                        ` : ''}
                                        
                                        ${survey.liked_most ? `
                                            <div class="comment-item">
                                                <h4>üëç What They Liked Most:</h4>
                                                <p class="comment-text positive">${survey.liked_most}</p>
                                            </div>
                                        ` : ''}
                                        
                                        ${survey.areas_improve ? `
                                            <div class="comment-item">
                                                <h4>üìà Areas for Improvement:</h4>
                                                <p class="comment-text improvement">${survey.areas_improve}</p>
                                            </div>
                                        ` : ''}
                                        
                                        ${survey.recommendation_comments ? `
                                            <div class="comment-item">
                                                <h4>üí° Recommendation Comments:</h4>
                                                <p class="comment-text">${survey.recommendation_comments}</p>
                                            </div>
                                        ` : ''}
                                        
                                        ${!survey.reception_comments && !survey.nursing_comments && !survey.doctor_comments && !survey.environment_comments && !survey.liked_most && !survey.areas_improve && !survey.recommendation_comments ? `
                                            <p style="color: #64748b; font-style: italic; text-align: center; padding: 20px;">No additional comments provided</p>
                                        ` : ''}
                                    </div>
                                </div>

                                <!-- Contact Preferences Section -->
                                <div class="detail-section">
                                    <h3 class="section-title">üìû Contact Preferences</h3>
                                    <div class="detail-grid">
                                        <div class="detail-item">
                                            <label>Wants Follow-up Contact:</label>
                                            <span>${formatYesNo(survey.wants_contact)}</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Preferred Contact Method:</label>
                                            <span>${survey.contact_method || 'N/A'}</span>
                                        </div>
                                        <div class="detail-item full-width">
                                            <label>Best Time to Contact:</label>
                                            <span>${survey.best_time_contact || 'N/A'}</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Survey Metadata Section -->
                                <div class="detail-section">
                                    <h3 class="section-title">üìã Survey Information</h3>
                                    <div class="detail-grid">
                                        <div class="detail-item">
                                            <label>Survey ID:</label>
                                            <span style="font-family: monospace; font-size: 0.9em;">${survey.response_id}</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Submitted Date:</label>
                                            <span>${new Date(survey.created_at).toLocaleString()}</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Privacy Consent:</label>
                                            <span>${formatYesNo(survey.privacy_consent)}</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Follow-up Consent:</label>
                                            <span>${formatYesNo(survey.followup_consent)}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        modal.style.display = 'block';
                    })
                    .catch(error => {
                        console.error('Error viewing survey:', error);
                        alert('Error loading survey details');
                    });
            }
        }

        function closeSurveyModal() {
            document.getElementById('surveyModal').style.display = 'none';
        }

        function viewFollowUp(followUpId) {
            if (window.adminDashboard && window.adminDashboard.supabase) {
                window.adminDashboard.supabase
                    .from('follow_up_tasks')
                    .select(`
                        *,
                        assigned_user:users!follow_up_tasks_assigned_to_fkey(full_name, email),
                        clinics!follow_up_tasks_clinic_id_fkey(name),
                        clinic_survey_responses!follow_up_tasks_survey_response_id_fkey(*)
                    `)
                    .eq('id', followUpId)
                    .single()
                    .then(({ data: followUp, error }) => {
                        if (error) {
                            console.error('Error loading follow-up task:', error);
                            return window.adminDashboard.supabase
                                .from('follow_up_tasks')
                                .select('*')
                                .eq('id', followUpId)
                                .single();
                        }
                        return { data: followUp, error: null };
                    })
                    .then(({ data: followUp, error }) => {
                        if (error) {
                            console.error('Error loading follow-up task:', error);
                            alert('Error loading follow-up details: ' + error.message);
                            return;
                        }

                        const modal = document.getElementById('followUpModal');
                        const details = document.getElementById('followUpDetails');
                        
                        details.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3>Follow-up Task Details</h3>
                                <span style="background: ${followUp.priority === 'urgent' ? '#dc2626' : followUp.priority === 'high' ? '#ea580c' : '#ca8a04'}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: uppercase;">
                                    ${followUp.priority} Priority
                                </span>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                                <div>
                                    <h4>üë§ Patient Information</h4>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-top: 10px;">
                                        <p><strong>Name:</strong> ${followUp.patient_name || 'N/A'}</p>
                                        <p><strong>Email:</strong> ${followUp.patient_email || 'N/A'}</p>
                                        <p><strong>Phone:</strong> ${followUp.patient_phone || 'N/A'}</p>
                                        <p><strong>Clinic:</strong> ${followUp.clinics?.name || 'N/A'}</p>
                                    </div>
                                </div>
                                
                                <div>
                                    <h4>üìã Task Information</h4>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-top: 10px;">
                                        <p><strong>Status:</strong> 
                                            <span style="background: ${followUp.status === 'pending' ? '#fef3c7' : followUp.status === 'completed' ? '#d1fae5' : '#fee2e2'}; 
                                                        color: ${followUp.status === 'pending' ? '#92400e' : followUp.status === 'completed' ? '#065f46' : '#991b1b'}; 
                                                        padding: 2px 8px; border-radius: 12px; font-size: 12px; text-transform: uppercase;">
                                                ${followUp.status.replace('_', ' ')}
                                            </span>
                                        </p>
                                        <p><strong>Assigned To:</strong> ${followUp.assigned_user?.full_name || 'Unassigned'}</p>
                                        <p><strong>Created:</strong> ${new Date(followUp.created_at).toLocaleString()}</p>
                                        <p><strong>Satisfaction:</strong> ${window.adminDashboard.formatSatisfaction(followUp.overall_satisfaction)}</p>
                                    </div>
                                </div>
                            </div>

                            ${followUp.notes ? `
                                <div style="margin-top: 20px;">
                                    <h4>üìù Notes & Reason</h4>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-top: 10px;">
                                        <p>${followUp.notes}</p>
                                    </div>
                                </div>
                            ` : ''}

                            <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                                ${followUp.status === 'pending' ? `
                                    <button class="btn btn-success btn-sm" onclick="completeFollowUp('${followUp.id}')">‚úÖ Mark Complete</button>
                                ` : ''}
                            </div>
                        `;
                        
                        modal.style.display = 'block';
                    })
                    .catch(error => {
                        console.error('Error viewing follow-up:', error);
                        alert('Error loading follow-up details');
                    });
            }
        }

        function closeFollowUpModal() {
            document.getElementById('followUpModal').style.display = 'none';
        }

        async function completeFollowUp(followUpId) {
            if (confirm('Mark this follow-up as completed?')) {
                try {
                    await window.adminDashboard.supabase
                        .from('follow_up_tasks')
                        .update({ 
                            status: 'completed',
                            resolved_at: new Date().toISOString()
                        })
                        .eq('id', followUpId);

                    await window.adminDashboard.loadFollowUpsData();
                    closeFollowUpModal();
                    window.adminDashboard.showSuccess('Follow-up marked as completed');
                } catch (error) {
                    console.error('Error completing follow-up:', error);
                    alert('Error completing follow-up');
                }
            }
        }

        function applyFilters() {
            console.log('üéØ Apply filters clicked');
            
            if (window.adminDashboard) {
                const filters = {
                    clinic: document.getElementById('clinicFilter')?.value || '',
                    dateRange: document.getElementById('dateRangeFilter')?.value || '',
                    satisfaction: document.getElementById('satisfactionFilter')?.value || ''
                };

                // Handle custom date range
                if (filters.dateRange === 'custom') {
                    filters.startDate = document.getElementById('startDate')?.value || '';
                    filters.endDate = document.getElementById('endDate')?.value || '';
                    
                    if (!filters.startDate || !filters.endDate) {
                        alert('Please select both start and end dates for custom range');
                        return;
                    }
                }

                console.log('üîç Applying filters:', filters);
                window.adminDashboard.currentFilters = filters;
                window.adminDashboard.loadSurveysData();
            } else {
                console.error('‚ùå adminDashboard not available');
                alert('Dashboard not ready. Please refresh the page.');
            }
        }

        function clearFilters() {
            console.log('üßπ Clearing all filters');
            
            // Reset filter form elements
            document.getElementById('clinicFilter').value = '';
            document.getElementById('dateRangeFilter').value = 'today';
            document.getElementById('satisfactionFilter').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            
            // Hide custom date fields
            document.getElementById('customDateGroup').style.display = 'none';
            document.getElementById('customDateGroup2').style.display = 'none';
            
            if (window.adminDashboard) {
                window.adminDashboard.currentFilters = {};
                window.adminDashboard.loadSurveysData();
            }
        }

        function toggleExportDropdown(button) {
            // Close all other dropdowns first
            document.querySelectorAll('.export-dropdown').forEach(dropdown => {
                if (dropdown !== button.parentElement) {
                    dropdown.classList.remove('show');
                }
            });
            
            // Toggle the clicked dropdown
            button.parentElement.classList.toggle('show');
        }

        function refreshData() {
            if (window.adminDashboard) {
                window.adminDashboard.refreshData();
            }
        }

        // Export functions
        function initializeExportManager() {
            if (window.adminDashboard && !window.adminDashboard.exportManager) {
                window.adminDashboard.exportManager = new ExportManager(window.adminDashboard);
                console.log('‚úÖ Export manager initialized');
            }
        }

        function exportSurveys(format) {
            const dropdown = document.querySelector('.export-dropdown');
            if (dropdown) dropdown.classList.remove('show');
            
            initializeExportManager();
            
            if (window.adminDashboard?.exportManager) {
                window.adminDashboard.exportManager.exportSurveys(format, true);
            } else {
                alert('Export system not ready. Please refresh the page.');
            }
        }

        function exportRecentSurveys(format = 'excel') {
            closeAllDropdowns();
            initializeExportManager();
            
            if (window.adminDashboard?.exportManager) {
                // Get user's accessible clinics
                window.adminDashboard.supabase
                    .rpc('get_user_accessible_clinics')
                    .then(({ data: userClinics }) => {
                        const clinicIds = userClinics?.map(c => c.clinic_id) || [];
                        
                        let query = window.adminDashboard.supabase
                            .from('survey_responses_view')
                            .select('*')
                            .order('created_at', { ascending: false })
                            .limit(10);

                        if (window.adminDashboard.currentSystemUser.role !== 'super_admin' && clinicIds.length > 0) {
                            query = query.in('clinic_id', clinicIds);
                        }

                        return query;
                    })
                    .then(({ data, error }) => {
                        if (error) {
                            window.adminDashboard.showError('Error fetching recent surveys: ' + error.message);
                            return;
                        }
                        
                        const originalFiltered = window.adminDashboard.filteredData;
                        window.adminDashboard.filteredData = data;
                        
                        window.adminDashboard.exportManager.exportSurveys(format, true).then(() => {
                            window.adminDashboard.filteredData = originalFiltered;
                        });
                    });
            } else {
                alert('Export system not ready. Please refresh the page.');
            }
        }

        function exportFollowUps(format = 'excel') {
            initializeExportManager();
            
            if (window.adminDashboard?.exportManager) {
                window.adminDashboard.exportManager.exportFollowUps(format);
            } else {
                alert('Export system not ready. Please refresh the page.');
            }
        }

        function exportAnalytics(format = 'excel') {
            initializeExportManager();
            
            if (window.adminDashboard?.exportManager) {
                window.adminDashboard.exportManager.exportAnalytics(format);
            } else {
                alert('Export system not ready. Please refresh the page.');
            }
        }

        function exportCustomRange() {
            const startDate = prompt('Enter start date (YYYY-MM-DD):');
            const endDate = prompt('Enter end date (YYYY-MM-DD):');
            
            if (!startDate || !endDate) return;
            
            initializeExportManager();
            
            if (window.adminDashboard?.exportManager) {
                // Get user's accessible clinics
                window.adminDashboard.supabase
                    .rpc('get_user_accessible_clinics')
                    .then(({ data: userClinics }) => {
                        const clinicIds = userClinics?.map(c => c.clinic_id) || [];
                        
                        let query = window.adminDashboard.supabase
                            .from('survey_responses_view')
                            .select('*')
                            .gte('created_at', startDate + 'T00:00:00')
                            .lte('created_at', endDate + 'T23:59:59')
                            .order('created_at', { ascending: false });

                        if (window.adminDashboard.currentSystemUser.role !== 'super_admin' && clinicIds.length > 0) {
                            query = query.in('clinic_id', clinicIds);
                        }

                        return query;
                    })
                    .then(({ data, error }) => {
                        if (error) {
                            alert('Error fetching custom range: ' + error.message);
                            return;
                        }
                        
                        window.adminDashboard.filteredData = data;
                        window.adminDashboard.exportManager.exportSurveys('excel', true);
                    });
            }
        }

        function toggleUserStatus(userId, newStatus) {
            if (window.adminDashboard) {
                window.adminDashboard.toggleUserStatus(userId, newStatus);
            }
        }

        // Global clinic management functions
        function addNewClinic() {
            if (window.adminDashboard) {
                window.adminDashboard.addNewClinic();
            }
        }

        function editClinic(clinicId) {
            if (window.adminDashboard) {
                window.adminDashboard.editClinic(clinicId);
            }
        }

        function toggleClinicStatus(clinicId, newStatus) {
            if (window.adminDashboard) {
                window.adminDashboard.toggleClinicStatus(clinicId, newStatus);
            }
        }

        function closeClinicModal() {
            if (window.adminDashboard) {
                window.adminDashboard.closeClinicModal();
            }
        }

        function loadClinicsData() {
            if (window.adminDashboard) {
                window.adminDashboard.loadClinicsData();
            }
        }

        function closeAllDropdowns() {
            document.querySelectorAll('.export-dropdown.show').forEach(dropdown => {
                dropdown.classList.remove('show');
            });
        }

        // Close dropdowns when clicking outside
        window.onclick = function(event) {
            if (!event.target.matches('.btn')) {
                const dropdowns = document.getElementsByClassName('export-dropdown-content');
                for (let i = 0; i < dropdowns.length; i++) {
                    const openDropdown = dropdowns[i];
                    if (openDropdown.parentElement.classList.contains('show')) {
                        openDropdown.parentElement.classList.remove('show');
                    }
                }
            }
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.adminDashboard = new AdminDashboard();
            
            // Initialize export manager after dashboard is ready
            setTimeout(() => {
                initializeExportManager();
            }, 1000);
        });
    </script>
</body>
</html>
